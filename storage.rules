rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // --- Field Applications (Barangay Cert, Land Title, IDs, etc.) ---
    match /field_applications/{userId}/{allPaths=**} {
      // ✅ Allow read access to:
      // - the owner (landowner)
      // - SRA officers
      // - Admins
      // - System Admins
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
      );

      // ✅ Allow write (upload/update/delete) only by the owner (landowner)
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Drivers Badge uploads ---
    match /Drivers_Badge/{userId}/{allPaths=**} {
      // Allow read for owner and authorized roles
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
      );

      // Write only by the owner
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Profile Photos uploads ---
    match /profilePhotos/{userId}/{allPaths=**} {
      // Allow read for owner and authorized roles
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin', 'handler']
      );

      // Write only by the owner
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Worker Logs (Manual Task Logging Photos) ---
    match /worker_logs/{allPaths=**} {
      // Allow read and write for all authenticated users
      allow read, write: if request.auth != null;
    }

    // --- Driver Logs (Manual Task Logging Photos) ---
    match /driver_logs/{allPaths=**} {
      // Allow read and write for all authenticated users
      allow read, write: if request.auth != null;
    }

    // --- Task Photos (Work Log Photos - Offline Sync Support) ---
    match /task_photos/{allPaths=**} {
      // Allow read and write for all authenticated users
      // This supports both online and offline sync uploads
      allow read, write: if request.auth != null;
    }

    // --- Report Photos (Handler Report Submissions) ---
    match /report_photos/{userId}/{reportId}/{allPaths=**} {
      // Allow read for owner, SRA officers, and admins
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin', 'handler']
      );

      // Allow write (upload) by the owner only
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Deny everything else explicitly ---
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
