rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {

    // --- Field Applications (Barangay Cert, Land Title, IDs, etc.) ---
    match /field_applications/{userId}/{allPaths=**} {
      // ✅ Allow read access to:
      // - the owner (landowner)
      // - SRA officers
      // - Admins
      // - System Admins
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
      );

      // ✅ Allow write (upload/update/delete) only by the owner (landowner)
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Drivers Badge uploads ---
    match /Drivers_Badge/{userId}/{allPaths=**} {
      // Allow read for owner and authorized roles
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
      );

      // Write only by the owner
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // --- Profile Photos uploads ---
    match /profilePhotos/{userId}/{allPaths=**} {
      // Allow read for owner and authorized roles
      allow read: if request.auth != null && (
        request.auth.uid == userId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin', 'handler']
      );

      // Write only by the owner
      allow write: if request.auth != null && request.auth.uid == userId;
    }


    // --- Driver Logs (Manual Task Logging Photos) ---
    match /driver_logs/{allPaths=**} {
      // Allow read and write for all authenticated users
      allow read, write: if request.auth != null;
    }

    // --- Task Photos (Work Log Photos) ---
    match /task_photos/{allPaths=**} {
      // Allow read and write for all authenticated users
      allow read, write: if request.auth != null;
    }

    // --- Reports (Field Reports sent to SRA) ---
    match /reports/{handlerId}/{fieldId}/{allPaths=**} {
      // Allow read for:
      // - the handler who created it
      // - assigned SRA officer (checked via Firestore)
      // - Admins and System Admins
      allow read: if request.auth != null && (
        request.auth.uid == handlerId ||
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['sra', 'admin', 'system_admin']
      );

      // Allow write (upload) only by the handler
      allow write: if request.auth != null && request.auth.uid == handlerId;
    }

    // --- Deny everything else explicitly ---
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
