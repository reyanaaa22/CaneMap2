<!-- COMPLETE INPUT RECORD MODULE
This file handles ALL functionalities described in the PDF:
- Field dropdown fetched same way as GrowthTracker
- Dynamic Field Operation ‚Üí Task Type ‚Üí Dynamic Form
- Validation + confirmation modal
- Firebase save with success & error UI
- Structured data for easy filtering (operation, cost, date)
- Responsive, animated, themed UI
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CaneMap | Input Record</title>

  <!-- Icons & Tailwind -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="../../css/output.css" />

  <style>
    :root {
      --cane-50:#f0f7e9;--cane-100:#d4e8b3;--cane-200:#b8d97d;
      --cane-500:#2c5a0b;--cane-600:#3a7a0f;--cane-700:#2c5a0b;
    }

    .card{background:#fff;border:1px solid var(--cane-200);box-shadow:0 8px 24px rgba(0,0,0,.08)}
    .fade{animation:fade .25s ease}
    @keyframes fade{from{opacity:0;transform:translateY(5px)}to{opacity:1}}
    .btn{transition:.2s}
    .btn:hover{transform:translateY(-1px);box-shadow:0 10px 20px rgba(0,0,0,.15)}
    
    /* Modern Notification Banner Styles */
    .notification-banner {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 9999;
      display: flex;
      justify-content: center;
      padding: 1rem;
      pointer-events: none;
    }
    
    .notification-content {
      background: white;
      border-radius: 1rem;
      padding: 1.25rem 1.5rem;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      max-width: 500px;
      width: 100%;
      display: flex;
      align-items: center;
      gap: 1rem;
      pointer-events: auto;
      transform: translateY(-120%);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    
    .notification-content.show {
      transform: translateY(0);
      opacity: 1;
    }
    
    .notification-content.success {
      border-left: 4px solid #10b981;
    }
    
    .notification-content.error {
      border-left: 4px solid #ef4444;
    }
    
    .notification-content.loading {
      border-left: 4px solid #3b82f6;
    }
    
    .notification-content.info {
      border-left: 4px solid #3b82f6;
    }
    
    .notification-icon {
      flex-shrink: 0;
      width: 2.5rem;
      height: 2.5rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      animation: scaleIn 0.3s ease-out;
    }
    
    .notification-icon.success {
      background: #d1fae5;
      color: #10b981;
    }
    
    .notification-icon.error {
      background: #fee2e2;
      color: #ef4444;
    }
    
    .notification-icon.loading {
      background: #dbeafe;
      color: #3b82f6;
    }
    
    .notification-icon.info {
      background: #dbeafe;
      color: #3b82f6;
    }
    
    .notification-icon.loading i {
      animation: spin 1s linear infinite;
    }
    
    .notification-text {
      flex: 1;
    }
    
    .notification-title {
      font-weight: 600;
      font-size: 1rem;
      color: #111827;
      margin-bottom: 0.25rem;
    }
    
    .notification-message {
      font-size: 0.875rem;
      color: #6b7280;
      margin-bottom: 0.5rem;
    }
    
    .notification-actions {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.75rem;
      flex-wrap: wrap;
    }
    
    .notification-btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .notification-btn-primary {
      background: var(--cane-700);
      color: white;
    }
    
    .notification-btn-primary:hover {
      background: var(--cane-600);
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .notification-btn-secondary {
      background: #f3f4f6;
      color: #374151;
    }
    
    .notification-btn-secondary:hover {
      background: #e5e7eb;
    }
    
    .notification-close {
      flex-shrink: 0;
      width: 1.75rem;
      height: 1.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: #9ca3af;
      transition: all 0.2s;
      background: transparent;
      border: none;
    }
    
    .notification-close:hover {
      background: #f3f4f6;
      color: #374151;
    }
    
    @keyframes scaleIn {
      from {
        transform: scale(0);
      }
      to {
        transform: scale(1);
      }
    }
    
    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-120%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(-120%);
        opacity: 0;
      }
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      z-index: 9998;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    
    .loading-overlay.show {
      opacity: 1;
      pointer-events: auto;
    }
    
    .loading-spinner {
      width: 3.5rem;
      height: 3.5rem;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
  </style>
</head>

<body class="bg-gradient-to-br from-[var(--cane-50)] to-[var(--cane-100)] min-h-screen text-gray-800">

<header class="bg-white border-b">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
    <a href="dashboard.html" class="text-[var(--cane-700)]"><i class="fa fa-arrow-left"></i></a>
    <h1 class="text-xl font-bold text-[var(--cane-700)]">Input Record</h1>
  </div>
</header>

<main class="max-w-6xl mx-auto p-4 space-y-6">

<!-- INFO -->
<div class="card rounded-xl p-4 text-sm">
  <i class="fa fa-circle-info text-[var(--cane-600)]"></i>
  All fields are required. Please input <b>N/A</b> or <b>0</b> if not applicable.
</div>

<!-- FORM CARD -->
<div class="card rounded-xl p-5 space-y-4 fade">

  <!-- STATUS / GROWTH STAGE (FIRST FIELD) -->
  <div>
    <label class="text-sm font-medium">Growth Stage / Status <span class="text-red-500">*</span></label>
    <select id="statusSelect" class="w-full mt-1 px-3 py-2 border rounded" required>
      <option value="">Select Growth Stage</option>
      <option value="Germination">Germination</option>
      <option value="Tillering">Tillering</option>
      <option value="Grand Growth">Grand Growth</option>
      <option value="Maturing / Ripening">Maturing / Ripening</option>
      <option value="Harvest">Harvest</option>
    </select>
  </div>

  <!-- FIELD -->
  <div id="fieldWrap" class="hidden">
    <label class="text-sm font-medium">Select a Field</label>
    <select id="fieldSelect" class="w-full mt-1 px-3 py-2 border rounded"></select>
  </div>

  <!-- OPERATION -->
  <div id="operationWrap" class="hidden">
    <label class="text-sm font-medium">Field Operation</label>
    <select id="operationSelect" class="w-full mt-1 px-3 py-2 border rounded">
      <option value="">Select</option>
    </select>
  </div>

  <!-- TASK TYPE -->
  <div id="taskTypeWrap" class="hidden">
    <label class="text-sm font-medium">Task Type</label>
    <select id="taskType" class="w-full mt-1 px-3 py-2 border rounded"></select>
  </div>

  <!-- DYNAMIC FORM -->
  <div id="dynamicForm" class="grid grid-cols-1 md:grid-cols-2 gap-3 hidden"></div>

  <!-- OPTIONAL SUPPORTING SECTIONS -->
  
  <!-- Bought Items Section -->
  <div id="boughtItemsSection" class="hidden">
    <div class="border-t pt-4 mt-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold">Bought Items (Optional)</h3>
        <button type="button" id="toggleBoughtItems" class="text-xs text-[var(--cane-700)] hover:underline">
          Show Section
        </button>
      </div>
      <div id="boughtItemsContent" class="hidden space-y-3">
        <div id="boughtItemsList"></div>
        <button type="button" id="addBoughtItemBtn" class="text-sm text-[var(--cane-700)] hover:underline">
          + Add Item
        </button>
      </div>
    </div>
  </div>

  <!-- Vehicle Updates Section -->
  <div id="vehicleUpdatesSection" class="hidden">
    <div class="border-t pt-4 mt-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-semibold">Vehicle / Transport Updates (Optional)</h3>
        <button type="button" id="toggleVehicleUpdates" class="text-xs text-[var(--cane-700)] hover:underline">
          Show Section
        </button>
      </div>
      <div id="vehicleUpdatesContent" class="hidden grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="text-xs font-medium">Vehicle Type</label>
          <select id="vehicleType" class="w-full mt-1 px-3 py-2 border rounded">
            <option value="">Select</option>
            <option>Truck</option>
            <option>Tractor</option>
            <option>Other</option>
          </select>
        </div>
        <div>
          <label class="text-xs font-medium">Trips/Boxes</label>
          <input type="number" id="tripsBoxes" class="w-full mt-1 px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="text-xs font-medium">Fuel Cost</label>
          <input type="number" step="0.01" id="vehicleFuelCost" class="w-full mt-1 px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="text-xs font-medium">Labor Cost</label>
          <input type="number" step="0.01" id="vehicleLaborCost" class="w-full mt-1 px-3 py-2 border rounded" />
        </div>
        <div>
          <label class="text-xs font-medium">Total Cost</label>
          <input type="number" step="0.01" id="vehicleTotalCost" class="w-full mt-1 px-3 py-2 border rounded" readonly />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs font-medium">Route / Field</label>
          <input type="text" id="vehicleRoute" class="w-full mt-1 px-3 py-2 border rounded" />
        </div>
      </div>
    </div>
  </div>

  <!-- SUBMIT -->
  <div class="pt-4 flex justify-end">
    <button id="submitBtn" class="btn bg-[var(--cane-700)] text-white px-6 py-2 rounded-lg">
      Save Record
    </button>
  </div>
</div>

</main>

<!-- CONFIRM MODAL -->
<div id="confirmModal" class="fixed inset-0 flex items-center justify-center bg-black/40 hidden z-50">
  <div class="bg-white rounded-xl p-6 w-[90%] max-w-md fade">
    <h3 class="font-semibold mb-2">Confirm Submission</h3>
    <p class="text-sm mb-4">Are all details correct?</p>
    <div class="flex justify-end gap-2">
      <button onclick="closeConfirm()" class="px-4 py-2 border rounded">Cancel</button>
      <button onclick="confirmSave()" class="px-4 py-2 bg-[var(--cane-700)] text-white rounded">Okay</button>
    </div>
  </div>
</div>

<!-- Modern Notification Banner -->
<div id="notificationBanner" class="notification-banner">
  <div id="notificationContent" class="notification-content">
    <div id="notificationIcon" class="notification-icon">
      <i id="notificationIconI" class="fas"></i>
    </div>
    <div class="notification-text">
      <div id="notificationTitle" class="notification-title"></div>
      <div id="notificationMessage" class="notification-message"></div>
      <div id="notificationActions" class="notification-actions"></div>
    </div>
    <button id="notificationClose" class="notification-close" onclick="hideNotification()">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<script type="module">
import { auth, db } from '../../backend/Common/firebase-config.js'
import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js'
import { collection, getDocs, addDoc, serverTimestamp, query, where } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js'
import { initHandlerOfflineSync, getOnlineStatus, wasOnInputRecords } from '../../backend/Handler/offline-input-sync.js'
import { addPendingRecord } from '../../backend/Handler/offline-input-storage.js'

// Initialize offline sync for Input Records page
initHandlerOfflineSync();

let uid=null
let pendingPayload=null

function showCenterMessage(msg) {
  const existing = document.getElementById('centerMsgModal');
  if(existing) existing.remove();

  const modal = document.createElement('div');
  modal.id = 'centerMsgModal';
  modal.className = 'fixed inset-0 flex items-center justify-center bg-black/40 z-50';
  modal.innerHTML = `
    <div class="bg-white rounded-xl p-6 w-[90%] max-w-sm text-center">
      <h3 class="font-semibold mb-4 text-lg">${msg}</h3>
      <button id="closeCenterMsg" class="px-4 py-2 bg-[var(--cane-700)] text-white rounded">Okay</button>
    </div>
  `;
  document.body.appendChild(modal);

  document.getElementById('closeCenterMsg').onclick = () => modal.remove();
}

// Status ‚Üí Field Operations mapping
const statusToOperations = {
  'Germination': ['Pre-Planting', 'Planting', 'Post-Planting'],
  'Tillering': ['Post-Planting'],
  'Grand Growth': ['Post-Planting'],
  'Maturing / Ripening': ['Post-Planting', 'Harvesting'],
  'Harvest': ['Harvesting']
};

// Status + Field Operation ‚Üí Task Types mapping
const statusOperationToTasks = {
  'Germination': {
    'Pre-Planting': ['Land Clearing', 'Plowing', 'Harrowing', 'Furrow Making', 'Seed Cane Preparation'],
    'Planting': ['Planting Operation', 'Replanting / Gap Filling'],
    'Post-Planting': ['Germination Monitoring']
  },
  'Tillering': {
    'Post-Planting': ['Weed Management', 'Fertilizer Application (Top Dressing)', 'Irrigation', 'Pest Control', 'Disease Control', 'Earthing-Up']
  },
  'Grand Growth': {
    'Post-Planting': ['Fertilizer Application', 'Irrigation', 'Growth Monitoring', 'Pest Control', 'Disease Control']
  },
  'Maturing / Ripening': {
    'Post-Planting': ['Growth Monitoring', 'Pre-Harvest Assessment'],
    'Harvesting': ['Harvesting']
  },
  'Harvest': {
    'Harvesting': ['Harvesting']
  }
};

// Task name aliases mapping (display name ‚Üí taskFieldMap key)
const taskNameAliases = {
  'Replanting / Gap Filling': 'Replanting Operation',
  'Weed Management': 'Weeding',
  'Fertilizer Application (Top Dressing)': 'Post-Planting Fertilization',
  'Fertilizer Application': 'Post-Planting Fertilization',
  'Pest Control': 'Control of Pest & Diseases',
  'Disease Control': 'Control of Pest & Diseases'
};

// Legacy operationMap for backward compatibility with taskFieldMap
const operationMap = {
  'Pre-Planting': ['Land Assessment', 'Land Clearing', 'Sub-Soiling', 'Soil Analysis', 'Plowing', 'Harrowing', 'Furrow Making', 'Lime Application', 'Pre-Planting Fertilization (basal)', 'Seed Cane Preparation'],
  'Planting': ['Planting Operation', 'Replanting Operation'],
  'Post-Planting': ['Germination Monitoring', 'Post-Planting Fertilization', 'Cultivation', 'Weeding', 'Drainage', 'Irrigation', 'Side Cleaning', 'Control of Pest & Diseases', 'Earthing-Up', 'Growth Monitoring', 'Pre-Harvest Assessment', 'Harvesting', 'Hauling', 'Ratooning'],
  'Vehicle Updates': ['Vehicle Updates']
};

// FULL TASK ‚Üí INPUT FIELD MAP (from PDF)
const taskFieldMap = {
"Land Assessment": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { id:'fieldArea', label:'Field Area (hectare)', type:'number', step:'0.01' },

  { id:'soilType', label:'Soil Type', type:'select',
    options:[
      'Clay',
      'Loam',
      'Sandy',
      'Silty',
      'Clay Loam',
      'Sandy Loam',
      'Peat',
      'Others'
    ] 
  },

{ 
  id:'drainage', 
  label:'Drainage Condition', 
  type:'select',
  options:[
    'Well Drained: Roots healthy, max growth and yield',
    'Moderately Drained: Growth okay but slower sometimes',
    'Poorly Drained: Roots suffocate, yield drops'
  ] 
},

  { id:'previousCrop', label:'Previous Crop', type:'select',
    options:[
      'Sugarcane',
      'Rice',
      'Corn',
      'Vegetables',
      'Fallow',
      'Others'
    ] 
  },

],


  "Land Clearing": [
    { id:'startDate', label:'Start Date', type:'date' },
    { id:'endDate', label:'End Date', type:'date' },

    { id:'method', label:'Clearing Method', type:'select',
      options:['Manual','Mechanical','Animal-Drawn','Herbicide'] },

    { id:'equipment', label:'Equipment Used', type:'text' },
    { id:'workers', label:'Number of Workers', type:'number' },
    { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
    { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

  ],


"Sub-Soiling": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { id:'depth', label:'Depth (cm)', type:'number' },
  { 
    id:'equipment', 
    label:'Equipment Used', 
    type:'select',
    options:[
      'Tractor with Subsoiler/Shank',
      'Animal-Drawn',
      'Ripper/Chisel Plow',
      'Manual Tools',
      'Others'
    ]
  },
  { id:'operators', label:'Number of Operators', type:'number' },
  { id:'fuelCost', label:'Fuel Cost', type:'number', step:'0.01' },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],

"Soil Analysis": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { id:'samplingDepth', label:'Sampling Depth (cm)', type:'number', step:'0.01' },
  { 
    id:'soilTexture', 
    label:'Soil Texture', 
    type:'select',
    options:[
      'Clay',
      'Silt',
      'Sand',
      'Loam',
      'Sandy Loam',
      'Clay Loam',
      'Silty Clay',
      'Peat / Organic',
      'Others'
    ]
  },
  { id:'pH', label:'Soil pH', type:'number', step:'0.01' },
  { id:'organicMatter', label:'Organic Matter (%)', type:'number', step:'0.01' },
  { id:'nitrogen', label:'Nitrogen (N) ppm', type:'number', step:'0.01' },
  { id:'phosphorus', label:'Phosphorus (P) ppm', type:'number', step:'0.01' },
  { id:'potassium', label:'Potassium (K) ppm', type:'number', step:'0.01' },
  { id:'calcium', label:'Calcium (Ca) ppm', type:'number', step:'0.01' },
  { id:'magnesium', label:'Magnesium (Mg) ppm', type:'number', step:'0.01' },

],


"Plowing": [
    { id:'startDate', label:'Start Date', type:'date' },
    { id:'endDate', label:'End Date', type:'date' },
    { 
      id:'equipment', 
      label:'Equipment / Method', 
      type:'select', 
      options:['Manual','Animal-Drawn','Mechanical','Others'] 
    },
    { id:'fuelCost', label:'Fuel Cost', type:'number', step:'0.01' },
    { id:'operators', label:'Number of Operators', type:'number' },
    { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
    { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' }
  ],

"Harrowing": [
    { id:'startDate', label:'Start Date', type:'date' },
    { id:'endDate', label:'End Date', type:'date' },
    { id:'passes', label:'Passes (No. of times harrowed)', type:'number' },
    { 
      id:'equipment', 
      label:'Equipment / Method', 
      type:'select', 
      options:['Manual','Animal-Drawn','Mechanical','Others'] 
    },
    { id:'operator', label:'Number of Operators', type:'number' },
    { id:'fuelCost', label:'Fuel Cost', type:'number', step:'0.01' },
    { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' }
  ],

"Furrow Making": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { 
    id:'method', 
    label:'Method', 
    type:'select', 
    options:['Manual', 'Animal-Drawn', 'Mechanical', 'Others'] 
  },
    { id:'workers', label:'Number of Workers', type:'number' },
    { id:'cost', label:'Cost', type:'number', step:'0.01' }
  ],

"Lime Application": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'limeType', 
    label:'Lime Type', 
    type:'select', 
    options:[
      'Agricultural Lime (Calcitic)',
      'Dolomitic Lime',
      'Pelletized Lime',
      'Others'
    ] 
  },

  { id:'amountApplied', label:'Amount Applied (kg/ha)', type:'number', step:'0.01' },

  { 
    id:'applicationMethod', 
    label:'Application Method', 
    type:'select', 
    options:[
      'Broadcast', 
      'Banded', 
      'Incorporated', 
      'Others'
    ] 
  },

  { id:'operators', label:'Number of Operators', type:'number' },

  { 
    id:'equipment', 
    label:'Equipment Used', 
    type:'select', 
    options:[
      'Tractor with Spreader', 
      'Manual Spreading', 
      'Animal-Drawn', 
      'Others'
    ] 
  },

  { id:'materialCost', label:'Material Cost', type:'number', step:'0.01' },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'fuelCost', label:'Fuel Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],


"Pre-Planting Fertilization (basal)": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { id:'fertilizerType', label:'Fertilizer Type', type:'select',
    options:[
      'Urea (46-0-0)',
      'Ammonium Sulfate (21-0-0)',
      'Complete (14-14-14)',
      'DAP (18-46-0)',
      'MOP (0-0-60)',
      '16-20-20',
      'Organic Fertilizer',
      'Liquid Fertilizer/BMOs',
      'Mudpress',
      'Rock Phosphate',
      'Others'
    ] 
  },

  { id:'amount', label:'Amount Applied (kg)', type:'number', step:'0.01' },

  { id:'applicationMethod', label:'Application Method', type:'select',
    options:[
      'Broadcasting',
      'Banding',
      'Side Dressing',
      'Foliar Spray',
      'Mudpress Application',
      'Others'
    ] 
  },

  { id:'workers', label:'Number of Workers', type:'number' },
  { id:'fertilizerCost', label:'Fertilizer Cost', type:'number', step:'0.01' },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' }
],


"Seed Cane Preparation": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'variety', 
    label:'Variety', 
    type:'select',
    options:[
      'PHIL 99-1793',
      'PHIL 80-13',
      'VMC 84-524',
      'VMC 84-947',
      'PHIL 93-1601',
      'PHIL 94-0913',
      'PHIL 92-0577',
      'Others'
    ]
  },
  { id:'workers', label:'Number of Workers', type:'number' },
  { id:'seedSource', label:'Seed Source', type:'text' },
  { id:'seedAge', label:'Seed Age (months)', type:'number' },

  { 
    id:'treatment', 
    label:'Treatment', 
    type:'select', 
    options:[
      'None',
      'Fungicide',
      'Insecticide',
      'Hot Water Treatment',
      'Biological Treatment',
      'Others'
    ]
  },

  { id:'quantity', label:'Quantity Prepared', type:'number' },
  { id:'cost', label:'Cost', type:'number', step:'0.01' }
],

"Planting Operation": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { 
    id:'growthStage', 
    label:'Growth Stage / Status', 
    type:'select',
    options:[
      'Germination',
      'Tillering',
      'Grand Growth',
      'Maturing / Ripening',
      'Harvest'
    ]
  },
  { 
    id:'variety', 
    label:'Variety', 
    type:'select',
    options:[
      'PHIL 99-1793',
      'PHIL 80-13',
      'VMC 84-524',
      'VMC 84-947',
      'PHIL 93-1601',
      'PHIL 94-0913',
      'PHIL 92-0577',
      'Others'
    ]
  },
  { id:'seedRate', label:'Seed Rate (canepoints/ha)', type:'number', step:'0.01' },
  { id:'numberOfSetts', label:'Number of Setts', type:'number', step:'0.01' },
  { id:'totalCaneRequired', label:'Total Cane Required (auto-calculated)', type:'number', step:'0.01', readonly: true, computed: 'numberOfSetts * seedRate' },

  // Labor for preparation of cane points
  { id:'prepLabor', label:'Labor for Preparation of Cane Points', type:'number', step:'0.01' },

  // Hauling of cane points
  { id:'haulingCost', label:'Hauling of Cane Points', type:'number', step:'0.01' },

  // Selection & counting of cane points
  { id:'selectionCountingCost', label:'Selection & Counting of Cane Points', type:'number', step:'0.01' },

  // Planting of cane points
  { 
    id:'plantingMethod', 
    label:'Planting Method', 
    type:'select', 
    options:['Manual','Mechanical','Others'] 
  },

    // Number of workers
  { id:'workers', label:'Number of Workers', type:'number' },

  { id:'plantingLaborCost', label:'Labor Cost for Planting', type:'number', step:'0.01' },

  // Total cost
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' }
],

"Replanting Operation": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { 
    id:'growthStage', 
    label:'Growth Stage / Status', 
    type:'select',
    options:[
      'Germination',
      'Tillering',
      'Grand Growth',
      'Maturing / Ripening',
      'Harvest'
    ]
  },
  { 
    id:'variety', 
    label:'Variety', 
    type:'select',
    options:[
      'PHIL 99-1793',
      'PHIL 80-13',
      'VMC 84-524',
      'VMC 84-947',
      'PHIL 93-1601',
      'PHIL 94-0913',
      'PHIL 92-0577',
      'Others'
    ]
  },
  { id:'seedRate', label:'Seed Rate (canepoints/ha)', type:'number', step:'0.01' },
  { id:'numberOfSetts', label:'Number of Setts', type:'number', step:'0.01' },
  { id:'totalCaneRequired', label:'Total Cane Required (auto-calculated)', type:'number', step:'0.01', readonly: true, computed: 'numberOfSetts * seedRate' },

  // Labor for preparation of cane points
  { id:'prepLabor', label:'Labor for Preparation of Cane Points', type:'number', step:'0.01' },

  // Hauling of cane points
  { id:'haulingCost', label:'Hauling of Cane Points', type:'number', step:'0.01' },

  // Selection & counting of cane points
  { id:'selectionCountingCost', label:'Selection & Counting of Cane Points', type:'number', step:'0.01' },

  // Planting of cane points
  { 
    id:'plantingMethod', 
    label:'Planting Method', 
    type:'select', 
    options:['Manual','Mechanical','Others'] 
  },

    // Number of workers
  { id:'workers', label:'Number of Workers', type:'number' },

  { id:'plantingLaborCost', label:'Labor Cost for Planting', type:'number', step:'0.01' },

  // Total cost
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' }
],

"Germination Monitoring": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { id:'germinationRate', label:'Germination Rate (%)', type:'number', step:'0.01' },
  { id:'cropAge', label:'Crop Age (days)', type:'number' },
  { id:'workers', label:'Number of Workers / Observers', type:'number' },
  { id:'notes', label:'Notes / Remarks', type:'textarea' }
],

"Growth Monitoring": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { id:'cropAge', label:'Crop Age (days)', type:'number' },
  { id:'growthStage', label:'Current Growth Stage', type:'select',
    options:['Germination', 'Tillering', 'Grand Growth', 'Maturing / Ripening', 'Harvest']
  },
  { id:'height', label:'Average Height (cm)', type:'number', step:'0.01' },
  { id:'tillersPerHill', label:'Tillers per Hill', type:'number', step:'0.01' },
  { id:'workers', label:'Number of Workers / Observers', type:'number' },
  { id:'notes', label:'Notes / Remarks', type:'textarea' }
],

"Pre-Harvest Assessment": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { id:'cropAge', label:'Crop Age (days)', type:'number' },
  { id:'maturityLevel', label:'Maturity Level', type:'select',
    options:['Early Mature', 'Mature', 'Over Mature']
  },
  { id:'estimatedYield', label:'Estimated Yield (tc/ha)', type:'number', step:'0.01' },
  { id:'brix', label:'Brix (%)', type:'number', step:'0.01' },
  { id:'workers', label:'Number of Workers / Assessors', type:'number' },
  { id:'notes', label:'Notes / Remarks', type:'textarea' }
],

"Post-Planting Fertilization": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { id:'fertilizerType', label:'Fertilizer Type', type:'select',
    options:[
      'Urea (46-0-0)',
      'Ammonium Sulfate (21-0-0)',
      'Complete (14-14-14)',
      'DAP (18-46-0)',
      'MOP (0-0-60)',
      '16-20-20',
      'Organic Fertilizer',
      'Liquid Fertilizer/BMOs',
      'Mudpress',
      'Rock Phosphate',
      'Others'
    ] 
  },

  { id:'amount', label:'Amount Applied (kg)', type:'number', step:'0.01' },

  { id:'applicationMethod', label:'Application Method', type:'select',
    options:[
      'Broadcasting',
      'Banding',
      'Side Dressing',
      'Foliar Spray',
      'Mudpress Application',
      'Others'
    ] 
  },

  { id:'workers', label:'Number of Workers', type:'number' },
  { id:'fertilizerCost', label:'Fertilizer Cost', type:'number', step:'0.01' },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' }
],

"Cultivation": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'method', 
    label:'Method', 
    type:'select', 
    options:['Manual','Animal-Drawn','Tractor/Mechanical','Others'] 
  },

  { 
    id:'cultivationOperation', 
    label:'Cultivation Operation', 
    type:'select', 
    options:[
      'Ridge-Busting',
      '1st Off-Barring',
      '2nd Off-Barring',
      'On-Barring / Barring',
      'Hilling-Up',
      'Off-Barring',
      'Middle Ridge',
      'Cut-Away',
      'Chipper',
      'Chisel',
      'Others'
    ]
  },

  { id:'workers', label:'Number of Workers', type:'number' },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],

"Weeding": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'method', 
    label:'Weeding Method', 
    type:'select', 
    options:['Manual Weeding','Chemical Weeding','Others'] 
  },

  // Only shown if Chemical Weeding is selected
  { 
    id:'herbicide', 
    label:'Herbicide / Chemical Name', 
    type:'select',
    options:[
      'Glyphosate',
      'Paraquat',
      '2,4-D',
      'Atrazine',
      'Simazine',
      'Others'
    ],
    dependsOn:{ field:'method', values:['Chemical Weeding'] } 
  },

  { id:'dosage', label:'Dosage (kg or L per ha)', type:'number', step:'0.01', dependsOn:{ field:'method', values:['Chemical Weeding'] } },

  { id:'areaCovered', label:'Area Covered (ha)', type:'number', step:'0.01' },
  { id:'workers', label:'Number of Workers', type:'number' },

  // Costs
  { id:'chemicalCost', label:'Chemical Cost', type:'number', step:'0.01', dependsOn:{ field:'method', values:['Chemical Weeding'] } },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],


"Drainage": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  
  { 
    id:'drainageType', 
    label:'Type of Drainage', 
    type:'select',
    options:[
      'Open Ditch',
      'Subsurface / Tile',
      'Contour Drain',
      'Raised Bed',
      'Others'
    ]
  },

  { id:'workers', label:'Number of Workers', type:'number' },

  { 
    id:'equipment', 
    label:'Equipment Used', 
    type:'select',
    options:[
      'Excavator',
      'Backhoe',
      'Tractor',
      'Manual Tools',
      'Others'
    ]
  },

  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'materialCost', label:'Material / Construction Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],


"Irrigation": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'irrigationMethod', 
    label:'Irrigation Method', 
    type:'select',
    options:[
      'Flooding',
      'Furrow',
      'Sprinkler',
      'Drip',
      'Others'
    ]
  },

  { 
    id:'waterSource', 
    label:'Water Source', 
    type:'select',
    options:[
      'Canal',
      'Well / Pump',
      'Rainfed',
      'River / Stream',
      'Others'
    ]
  },
  { id:'workers', label:'Number of Workers', type:'number' },

  { 
    id:'equipment', 
    label:'Equipment Used', 
    type:'select',
    options:[
      'Pump',
      'Sprinkler System',
      'Irrigation Canal Tools',
      'Manual Tools',
      'Others'
    ]
  },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'materialCost', label:'Material / Pump Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],


"Side Cleaning": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'cleaningMethod', 
    label:'Cleaning Method', 
    type:'select',
    options:[
      'Manual',
      'Mechanical',
      'Herbicide / Chemical',
      'Others'
    ]
  },

  { 
    id:'chemicalUsed', 
    label:'Herbicide / Chemical Name', 
    type:'select',
    options:[
      'Glyphosate',
      'Paraquat',
      '2,4-D',
      'Atrazine',
      'Others'
    ],
    dependsOn: { field:'cleaningMethod', values:['Herbicide / Chemical'] }
  },

  { id:'dosage', label:'Dosage (L or kg)', type:'number', step:'0.01', dependsOn: { field:'cleaningMethod', values:['Herbicide / Chemical'] } },
  { id:'areaCovered', label:'Area Covered (ha)', type:'number', step:'0.01' },
  { id:'workers', label:'Number of Workers', type:'number' },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'chemicalCost', label:'Chemical Cost', type:'number', step:'0.01', dependsOn: { field:'cleaningMethod', values:['Herbicide / Chemical'] } },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],

"Control of Pest & Diseases": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },
  { id:'workers', label:'Number of Workers', type:'number' },

  { 
    id:'pestDisease', 
    label:'Pest / Disease Identified', 
    type:'select', 
    options:[
      'Borer',
      'Rodents',
      'Others'
    ]
  },

  { id:'affectedArea', label:'Affected Area (ha)', type:'number', step:'0.01' },

  { 
    id:'severity', 
    label:'Severity', 
    type:'select', 
    options:['Low','Medium','High'] 
  },

  { 
    id:'controlMethod', 
    label:'Control Method', 
    type:'select',
    options:[
      'Trichogramma Release',
      'Rodent Control',
      'Chemical Spray',
      'Others'
    ]
  },
{ 
  id:'chemical', 
  label:'Chemical Used', 
  type:'select',
  options:[
    'Glyphosate',
    'Chlorpyrifos',
    'Carbofuran',
    'Imidacloprid',
    'Thiamethoxam',
    'Mancozeb',
    'Others'
  ],
  dependsOn:{ field:'controlMethod', values:['Chemical Spray'] }
},

  { 
    id:'dosage', 
    label:'Dosage (kg/L per ha)', 
    type:'number',
    step:'0.01',
    dependsOn:{ field:'controlMethod', values:['Chemical Spray'] }
  },


  { id:'areaTreated', label:'Area Treated (ha)', type:'number', step:'0.01' },
  { id:'materialCost', label:'Material Cost', type:'number', step:'0.01' },
  { id:'laborCost', label:'Labor Cost', type:'number', step:'0.01' },
  { id:'totalCost', label:'Total Cost', type:'number', step:'0.01' },

],

"Earthing-Up": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'method', 
    label:'Method Used', 
    type:'select',
    options:[
      'Manual',
      'Animal-Drawn',
      'Mechanical (Tractor)',
      'Others'
    ]
  },

  { 
    id:'depth', 
    label:'Soil Heaping Depth (cm)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'rowCoverage', 
    label:'Rows Covered', 
    type:'number'
  },

  { 
    id:'workers', 
    label:'Number of Workers', 
    type:'number'
  },

  { 
    id:'laborCost', 
    label:'Labor Cost', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'fuelCost', 
    label:'Fuel Cost', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'totalCost', 
    label:'Total Cost', 
    type:'number',
    step:'0.01'
  },

],

"Harvesting": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'harvestMethod', 
    label:'Harvesting Method', 
    type:'select',
    options:[
      'Manual',
      'Mechanical',
      'Manual + Mechanical',
      'Others'
    ]
  },

  { 
    id:'caneType', 
    label:'Cane Type', 
    type:'select',
    options:[
      'Plant Cane',
      'Ratoon Cane'
    ]
  },

  { 
    id:'yieldTcHa', 
    label:'Yield (tc/ha)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'areaHarvested', 
    label:'Area Harvested (ha)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'totalCaneYield', 
    label:'Total Cane Yield (tons)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'workers', 
    label:'Number of Workers', 
    type:'number'
  },

  { 
    id:'transportUsed', 
    label:'Transport Used', 
    type:'select',
    options:[
      'Truck',
      'Tractor + Trailer',
      'Animal-Drawn Cart',
      'Others'
    ]
  },

  { 
    id:'harvestCost', 
    label:'Harvest Cost (Cutting & Loading)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'transportCost', 
    label:'Transport Cost', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'totalCost', 
    label:'Total Cost', 
    type:'number',
    step:'0.01'
  },


], 

"Hauling": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'caneType', 
    label:'Cane Type', 
    type:'select',
    options:[
      'Plant Cane',
      'Ratoon Cane'
    ]
  },

  { 
    id:'haulingType', 
    label:'Hauling Type', 
    type:'select',
    options:[
      'Infield Hauling',
      'Mill / Outfield Hauling'
    ]
  },

  { 
    id:'transportUsed', 
    label:'Transport Used', 
    type:'select',
    options:[
      'Truck',
      'Tractor + Trailer',
      'Animal-Drawn Cart',
      'Others'
    ]
  },

  { 
    id:'distance', 
    label:'Distance Covered (km)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'caneLoaded', 
    label:'Cane Loaded (tons)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'fuelCost', 
    label:'Fuel Cost', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'laborCost', 
    label:'Labor Cost', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'haulingExpense', 
    label:'Total Hauling Expense', 
    type:'number',
    step:'0.01'
  },


],

"Ratooning": [
  { id:'startDate', label:'Start Date', type:'date' },
  { id:'endDate', label:'End Date', type:'date' },

  { 
    id:'ratoonOperation', 
    label:'Ratooning Operation', 
    type:'select',
    options:[
      'Trash Mulching',
      'Trash Burning',
      'Trash Clearing',
      'Stubble Shaving',
      'Others'
    ]
  },

  { 
    id:'method', 
    label:'Method Used', 
    type:'select',
    options:[
      'Manual',
      'Mechanical',
      'Manual + Mechanical',
      'Others'
    ]
  },

  { 
    id:'areaCovered', 
    label:'Area Covered (ha)', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'workers', 
    label:'Number of Workers', 
    type:'number'
  },

  { 
    id:'equipment', 
    label:'Equipment Used', 
    type:'select',
    options:[
      'Trash Shredder',
      'Mower',
      'Tractor',
      'Manual Tools',
      'Others'
    ]
  },

  { 
    id:'laborCost', 
    label:'Labor Cost', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'fuelCost', 
    label:'Fuel Cost', 
    type:'number',
    step:'0.01'
  },

  { 
    id:'totalCost', 
    label:'Total Cost', 
    type:'number',
    step:'0.01'
  },


],

 "Vehicle Updates": [
    {id:'startDate', label:'Start Date', type:'date'},
    {id:'endDate', label:'End Date', type:'date'},
    {id:'activeDrivers', label:'Active Drivers', type:'number'},
    {id:'returningDrivers', label:'Returning Drivers', type:'number'},
    {id:'boxes', label:'Boxes Transported', type:'number'},
    {id:'weight', label:'Total Cane Weight', type:'number'},
    {id:'fuelCost', label:'Fuel Cost', type:'fuel'}, 
    {id:'laborCost', label:'Labor Cost', type:'number'},
    {id:'totalCost', label:'Total Cost', type:'number', readonly: true},
    {id:'vehicleType', label:'Vehicle Type', type:'select', options:['Truck', 'Tractor', 'Other']},
    {id:'driverRent', label:'Is Driver/Worker Rented?', type:'select', options:['Yes','No','Other']},
  ]
};

onAuthStateChanged(auth,async user=>{
  if(!user)return location.href='../Common/farmers_login.html'
  uid=user.uid
  loadFields()
})

async function loadFields(){
  const q = query(collection(db,'fields'), where('userId','==',uid));
  const snap = await getDocs(q);

  // Add default "Select" option first
  fieldSelect.innerHTML = '<option value="">Select</option>' + 
    snap.docs.map(d => `<option value="${d.id}">${d.data().field_name}</option>`).join('');
}

// Status selection handler
statusSelect.onchange = () => {
  const status = statusSelect.value;
  
  // Reset all dependent fields
  operationSelect.value = '';
  taskType.value = '';
  dynamicForm.innerHTML = '';
  
  // Hide all fields until status is selected
  if (!status) {
    fieldWrap.classList.add('hidden');
    operationWrap.classList.add('hidden');
    taskTypeWrap.classList.add('hidden');
    dynamicForm.classList.add('hidden');
    boughtItemsSection.classList.add('hidden');
    vehicleUpdatesSection.classList.add('hidden');
    return;
  }
  
  // Show field selection
  fieldWrap.classList.remove('hidden');
  
  // Show and populate Field Operations based on Status
  const allowedOperations = statusToOperations[status] || [];
  operationSelect.innerHTML = '<option value="">Select</option>' +
    allowedOperations.map(op => `<option value="${op}">${op}</option>`).join('');
  
  operationWrap.classList.remove('hidden');
  taskTypeWrap.classList.add('hidden');
  dynamicForm.classList.add('hidden');
  boughtItemsSection.classList.add('hidden');
  vehicleUpdatesSection.classList.add('hidden');
};

// Field Operation selection handler
operationSelect.onchange = () => {
  const status = statusSelect.value;
  const operation = operationSelect.value;

  taskType.value = '';
  dynamicForm.innerHTML = '';

  if (!status || !operation) {
    taskTypeWrap.classList.add('hidden');
    dynamicForm.classList.add('hidden');
    boughtItemsSection.classList.add('hidden');
    vehicleUpdatesSection.classList.add('hidden');
    return;
  }
  
  // Get Task Types based on Status + Field Operation
  const tasks = statusOperationToTasks[status]?.[operation] || [];
  
  if (!tasks.length) {
    taskTypeWrap.classList.add('hidden');
    dynamicForm.classList.add('hidden');
    boughtItemsSection.classList.add('hidden');
    vehicleUpdatesSection.classList.add('hidden');
    return;
  }
  
  // Show Task Type dropdown
    taskTypeWrap.classList.remove('hidden');
  taskType.innerHTML = '<option value="">Select</option>' +
      tasks.map(t => `<option value="${t}">${t}</option>`).join('');
  
  dynamicForm.classList.add('hidden');
  boughtItemsSection.classList.add('hidden');
  vehicleUpdatesSection.classList.add('hidden');
};

// Task Type selection handler
taskType.onchange = () => {
  const taskDisplayName = taskType.value;
  
  if (!taskDisplayName) {
    dynamicForm.classList.add('hidden');
    boughtItemsSection.classList.add('hidden');
    vehicleUpdatesSection.classList.add('hidden');
    return;
  }
  
  // Map display name to taskFieldMap key
  const taskKey = taskNameAliases[taskDisplayName] || taskDisplayName;
  renderForm(taskKey);
  
  // Show optional sections after task fields
  boughtItemsSection.classList.remove('hidden');
  vehicleUpdatesSection.classList.remove('hidden');
}

function renderForm(type){
  dynamicForm.innerHTML = '';
  const fields = taskFieldMap[type] || [];
  
  if (!fields.length) {
    dynamicForm.classList.add('hidden');
    return;
  }
  
  dynamicForm.classList.remove('hidden');

  fields.forEach(f => {
    let inputHTML = '';

    // üîΩ SELECT WITH "Other" OPTION
    if(f.type === 'select'){
      inputHTML = `
        <select id="${f.id}" class="w-full border rounded px-3 py-2" onchange="handleOtherSelect('${f.id}')" required>
          <option value="">Select</option>
          ${f.options.map(opt=>`<option value="${opt}">${opt}</option>`).join('')}
        </select>
        <input type="text" id="${f.id}_other" placeholder="Please specify" class="w-full border rounded px-3 py-2 mt-2 hidden" />
      `;
    } 

    // üî¢ NUMBER INPUT (regular)
    else if(f.type === 'number'){
      // check kung weight or laborCost
      if(f.id === 'weight' || f.id === 'laborCost'){
        inputHTML = `
          <div id="${f.id}Container">
            <div class="flex mb-2">
              <input type="number" class="${f.id}Input border rounded px-3 py-2 mr-2" value="0" />
              <button type="button" id="add${f.id}Btn" class="border rounded px-3 py-2">+</button>
            </div>
            <div id="${f.id}Sum" class="font-bold">Total ${f.label}: 0</div>
            <input type="hidden" id="${f.id}" />
          </div>
        `;
      } else {
        const readonlyAttr = f.readonly ? 'readonly' : '';
        inputHTML = `<input type="number" step="${f.step || 1}" inputmode="decimal" id="${f.id}" class="w-full border rounded px-3 py-2" value="0" ${readonlyAttr} ${readonlyAttr ? '' : 'required'} />`;
      }
    }

    // üìÖ DATE
    else if(f.type === 'date'){
      inputHTML = `<input type="date" id="${f.id}" class="w-full border rounded px-3 py-2" required />`;
    }

    // üí∞ FUEL COST DYNAMIC INPUTS
    else if(f.type === 'fuel'){
      inputHTML = `
        <div id="fuelContainer">
          <div class="flex mb-2">
            <input type="number" class="fuelInput border rounded px-3 py-2 mr-2" value="0" />
            <button type="button" id="addFuelBtn" class="border rounded px-3 py-2">+</button>
          </div>
          <div id="fuelSum" class="font-bold">Total Fuel Cost: 0</div>
        </div>
      `;
    }

    // üìù TEXTAREA (for notes/remarks)
    else if(f.type === 'textarea'){
      inputHTML = `<textarea id="${f.id}" class="w-full border rounded px-3 py-2" rows="3" required></textarea>`;
    }

    // ‚úèÔ∏è TEXT (DEFAULT)
    else {
      inputHTML = `<input type="text" id="${f.id}" class="w-full border rounded px-3 py-2" required />`;
    }

    // Append field
    dynamicForm.innerHTML += `
      <div class="mb-4">
        <label class="text-xs font-medium">${f.label}</label>
        ${inputHTML}
      </div>
    `;
  });

  // --- SPECIAL HANDLING ---

  // --- Universal Auto-calculate Total Cost ---
  // This function calculates totalCost by summing ALL cost-related fields
  // Defined first so it's available to other functions
  function updateTotalCost(){
    const totalCostInput = document.getElementById('totalCost');
    if(!totalCostInput) return;
    
    let total = 0;
    
    // List of all possible cost-related field IDs
    const costFieldIds = [
      // Standard cost fields
      'fuelCost', 'laborCost', 'materialCost', 'fertilizerCost', 'chemicalCost',
      'haulingCost', 'harvestCost', 'transportCost', 'cost',
      // Special labor cost fields
      'prepLabor', 'plantingLaborCost', 'selectionCountingCost',
      // Other expense fields
      'haulingExpense'
    ];
    
    // Also check for 'fuel' field (special dynamic input case)
    const fuelInput = document.getElementById('fuel');
    if(fuelInput) {
      total += parseFloat(fuelInput.value) || 0;
    }
    
    // Check for 'laborCost' container (special dynamic input case)
    const laborCostContainer = document.getElementById('laborCostContainer');
    const hasLaborCostContainer = !!laborCostContainer;
    if(hasLaborCostContainer) {
      const laborCostHidden = document.getElementById('laborCost');
      if(laborCostHidden) {
        total += parseFloat(laborCostHidden.value) || 0;
      }
    }
    
    // Sum all cost-related fields that exist in the form
    costFieldIds.forEach(fieldId => {
      // Skip laborCost if it's in a container (already handled above)
      if(fieldId === 'laborCost' && hasLaborCostContainer) {
        return;
      }
      
      const field = document.getElementById(fieldId);
      if(field && field.type === 'number' && !field.readonly) {
        // Skip if it's inside a dynamic container (handled separately above)
        const container = field.closest('#' + fieldId + 'Container');
        if(!container) {
          total += parseFloat(field.value) || 0;
        }
      }
    });
    
    // Update totalCost with 2 decimal places
    totalCostInput.value = total.toFixed(2);
  }

  // 1Ô∏è‚É£ Dynamic inputs handler (weight, laborCost, fuel)
  ['weight','laborCost','fuel'].forEach(field => {
    const container = document.getElementById(field + 'Container');
    if(!container) return;

    let count = 1;
    const maxInputs = 5;

    const addBtn = document.getElementById('add' + field + 'Btn');
    if(addBtn){
      addBtn.addEventListener('click', () => {
        if(count >= maxInputs) return;
        const newDiv = document.createElement('div');
        newDiv.classList.add('flex','mb-2');
        newDiv.innerHTML = `<input type="number" class="${field}Input border rounded px-3 py-2 mr-2" value="0" />`;
        container.insertBefore(newDiv, document.getElementById(field + 'Sum'));
        count++;
        newDiv.querySelector('input').addEventListener('input', updateSum);
        updateSum();
      });
    }

    function updateSum(){
      const inputs = container.querySelectorAll('.' + field + 'Input');
      let sum = 0;
      inputs.forEach(i => sum += Number(i.value) || 0);
      document.getElementById(field + 'Sum').innerText = `Total ${field === 'weight' ? 'Cane Weight' : field==='laborCost' ? 'Labor Cost' : 'Fuel Cost'}: ${sum}`;
      const hiddenInput = document.getElementById(field);
      if(hiddenInput) hiddenInput.value = sum;
      // Trigger totalCost recalculation when dynamic fields change
      if(field === 'fuel' || field === 'laborCost') {
        updateTotalCost();
      }
    }

    // Initial attach
    container.querySelectorAll('input').forEach(i => i.addEventListener('input', updateSum));
    updateSum();
  });

  // 2Ô∏è‚É£ Attach listeners to all cost-related fields for auto-calculation
  const costFieldIds = ['fuelCost', 'laborCost', 'materialCost', 'fertilizerCost', 'chemicalCost', 
                        'haulingCost', 'harvestCost', 'transportCost', 'cost', 'prepLabor', 
                        'plantingLaborCost', 'selectionCountingCost', 'haulingExpense'];
  
  // Handle dynamic container fields (fuel, laborCost) - listeners already added in updateSum
  // Just need to make sure they trigger updateTotalCost, which is already done in updateSum
  
  // Attach listeners to all regular cost fields
  costFieldIds.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if(field && field.type === 'number' && !field.readonly) {
      field.addEventListener('input', updateTotalCost);
      field.addEventListener('change', updateTotalCost);
    }
  });
  
  // Also listen for any cost-related fields that might be dynamically created
  // Use event delegation on the form container
  const dynamicFormEl = document.getElementById('dynamicForm');
  if(dynamicFormEl) {
    // Remove any existing listener to avoid duplicates
    const newHandler = (e) => {
      if(e.target.type === 'number' && !e.target.readonly) {
        const fieldId = e.target.id;
        // Check if it's a cost-related field
        if(costFieldIds.includes(fieldId) || 
           (fieldId.toLowerCase().includes('cost') && fieldId !== 'totalCost') || 
           fieldId === 'prepLabor' || 
           fieldId === 'plantingLaborCost' || 
           fieldId === 'selectionCountingCost') {
          updateTotalCost();
        }
      }
    };
    dynamicFormEl.addEventListener('input', newHandler);
  }
  
  // Initial calculation
  updateTotalCost();

  // --- Handle computed fields ---
  // Total Cane Required = Number of Setts √ó Seed Rate
  const numberOfSettsInput = document.getElementById('numberOfSetts');
  const seedRateInput = document.getElementById('seedRate');
  const totalCaneRequiredInput = document.getElementById('totalCaneRequired');
  
  if (numberOfSettsInput && seedRateInput && totalCaneRequiredInput) {
    const updateTotalCaneRequired = () => {
      const setts = parseFloat(numberOfSettsInput.value) || 0;
      const rate = parseFloat(seedRateInput.value) || 0;
      totalCaneRequiredInput.value = (setts * rate).toFixed(2);
    };
    
    numberOfSettsInput.addEventListener('input', updateTotalCaneRequired);
    seedRateInput.addEventListener('input', updateTotalCaneRequired);
    updateTotalCaneRequired();
  }

  // --- Handle Mechanical selection to show "Was a truck rented?" ---
  const mechanicalFields = ['equipment', 'method', 'plantingMethod', 'cleaningMethod', 'harvestMethod'];
  mechanicalFields.forEach(fieldId => {
    const select = document.getElementById(fieldId);
    if (select && (select.options && Array.from(select.options).some(opt => opt.value === 'Mechanical' || opt.value.includes('Mechanical')))) {
      select.addEventListener('change', function() {
        const truckRentedContainer = document.getElementById('truckRentedContainer');
        if (this.value === 'Mechanical' || this.value.includes('Mechanical')) {
          // Check if container already exists
          if (!truckRentedContainer) {
            // Find the parent div and insert after the current field
            const currentFieldDiv = this.closest('.mb-4');
            if (currentFieldDiv) {
              const newDiv = document.createElement('div');
              newDiv.id = 'truckRentedContainer';
              newDiv.className = 'mb-4';
              newDiv.innerHTML = `
                <label class="text-xs font-medium">Was a truck rented? <span class="text-red-500">*</span></label>
                <select id="truckRented" class="w-full border rounded px-3 py-2" required>
                  <option value="">Select</option>
                  <option value="Yes">Yes</option>
                  <option value="No">No</option>
                </select>
              `;
              currentFieldDiv.parentNode.insertBefore(newDiv, currentFieldDiv.nextSibling);
            }
          } else {
            truckRentedContainer.classList.remove('hidden');
          }
        } else {
          if (truckRentedContainer) {
            truckRentedContainer.classList.add('hidden');
            const truckRentedSelect = document.getElementById('truckRented');
            if (truckRentedSelect) truckRentedSelect.value = '';
          }
        }
      });
    }
  });

  // --- Calculate labor cost from dates (Rate per day √ó Number of days) ---
  const startDateInput = document.getElementById('startDate');
  const endDateInput = document.getElementById('endDate');
  const laborRateInput = document.getElementById('laborRatePerDay');
  const laborCostInput = document.getElementById('laborCost');
  
  if (startDateInput && endDateInput && laborCostInput && !laborCostInput.closest('#' + laborCostInput.id + 'Container')) {
    // Only if laborCost is a regular input, not the dynamic container type
    const updateLaborCostFromDates = () => {
      const startDate = startDateInput.value;
      const endDate = endDateInput.value;
      const laborRate = laborRateInput ? (parseFloat(laborRateInput.value) || 0) : 0;
      
      if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const diffTime = Math.abs(end - start);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end days
        
        if (laborRate > 0) {
          laborCostInput.value = (laborRate * diffDays).toFixed(2);
        }
      }
    };
    
    if (laborRateInput) {
      laborRateInput.addEventListener('input', updateLaborCostFromDates);
    }
    startDateInput.addEventListener('change', updateLaborCostFromDates);
    endDateInput.addEventListener('change', updateLaborCostFromDates);
    updateLaborCostFromDates();
  }

}

// Handle ‚ÄúOther‚Äù input for selects
function handleOtherSelect(id){
  const select = document.getElementById(id);
  const otherInput = document.getElementById(`${id}_other`);
  if(select.value === 'Other' || select.value === 'Others'){
    otherInput.classList.remove('hidden');
    otherInput.required = true;
  } else {
    otherInput.classList.add('hidden');
    otherInput.required = false;
    otherInput.value = '';
  }
}


// Optional sections handlers
let boughtItemsCount = 0;

const toggleBoughtItemsBtn = document.getElementById('toggleBoughtItems');
const boughtItemsContent = document.getElementById('boughtItemsContent');
const boughtItemsList = document.getElementById('boughtItemsList');
const addBoughtItemBtn = document.getElementById('addBoughtItemBtn');

if (toggleBoughtItemsBtn && boughtItemsContent) {
  toggleBoughtItemsBtn.onclick = () => {
    const isHidden = boughtItemsContent.classList.contains('hidden');
    if (isHidden) {
      boughtItemsContent.classList.remove('hidden');
      toggleBoughtItemsBtn.textContent = 'Hide Section';
    } else {
      boughtItemsContent.classList.add('hidden');
      toggleBoughtItemsBtn.textContent = 'Show Section';
    }
  };
}

if (addBoughtItemBtn && boughtItemsList) {
  addBoughtItemBtn.onclick = () => {
    boughtItemsCount++;
    const itemDiv = document.createElement('div');
    itemDiv.className = 'border rounded p-3 space-y-2';
    itemDiv.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <span class="text-xs font-medium">Item ${boughtItemsCount}</span>
        <button type="button" class="text-red-500 text-xs" onclick="this.closest('.border').remove()">Remove</button>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
        <div>
          <label class="text-xs">Item Name</label>
          <input type="text" class="bought-item-name w-full px-2 py-1 border rounded text-sm" />
        </div>
        <div>
          <label class="text-xs">Quantity</label>
          <input type="number" step="0.01" class="bought-item-qty w-full px-2 py-1 border rounded text-sm" />
        </div>
        <div>
          <label class="text-xs">Unit</label>
          <select class="bought-item-unit w-full px-2 py-1 border rounded text-sm">
            <option value="">Select unit</option>
            <option value="kg">Kilogram (kg)</option>
            <option value="bag">Bag/s</option>
            <option value="sack">Sack/s</option>
            <option value="ton">Ton/s</option>
            <option value="liter">Liter/s</option>
            <option value="gallon">Gallon/s</option>
            <option value="pcs">Piece/s</option>
            <option value="bundle">Bundle/s</option>
            <option value="box">Box/es</option>
            <option value="hectare">Hectare/s</option>
            <option value="others">Others</option>
          </select>
        </div>
        <div>
          <label class="text-xs">Price</label>
          <input type="number" step="0.01" class="bought-item-price w-full px-2 py-1 border rounded text-sm" />
        </div>
        <div>
          <label class="text-xs">Total</label>
          <input type="number" step="0.01" class="bought-item-total w-full px-2 py-1 border rounded text-sm" readonly />
        </div>
        <div>
          <label class="text-xs">Supplier</label>
          <input type="text" class="bought-item-supplier w-full px-2 py-1 border rounded text-sm" />
        </div>
        <div class="md:col-span-2">
          <label class="text-xs">Notes</label>
          <input type="text" class="bought-item-notes w-full px-2 py-1 border rounded text-sm" />
        </div>
      </div>
    `;
    
    // Auto-calculate total
    const qtyInput = itemDiv.querySelector('.bought-item-qty');
    const priceInput = itemDiv.querySelector('.bought-item-price');
    const totalInput = itemDiv.querySelector('.bought-item-total');
    
    const updateTotal = () => {
      const qty = parseFloat(qtyInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      totalInput.value = (qty * price).toFixed(2);
    };
    
    qtyInput.addEventListener('input', updateTotal);
    priceInput.addEventListener('input', updateTotal);
    
    boughtItemsList.appendChild(itemDiv);
  };
}

const toggleVehicleUpdatesBtn = document.getElementById('toggleVehicleUpdates');
if (toggleVehicleUpdatesBtn) {
  toggleVehicleUpdatesBtn.onclick = () => {
    const content = document.getElementById('vehicleUpdatesContent');
    if (!content) return;
    const isHidden = content.classList.contains('hidden');
    if (isHidden) {
      content.classList.remove('hidden');
      toggleVehicleUpdatesBtn.textContent = 'Hide Section';
    } else {
      content.classList.add('hidden');
      toggleVehicleUpdatesBtn.textContent = 'Show Section';
    }
  };
}

// Auto-calculate vehicle total cost
function updateVehicleTotalCost() {
  const vehicleFuelCostEl = document.getElementById('vehicleFuelCost');
  const vehicleLaborCostEl = document.getElementById('vehicleLaborCost');
  const vehicleTotalCostEl = document.getElementById('vehicleTotalCost');
  
  if (!vehicleFuelCostEl || !vehicleLaborCostEl || !vehicleTotalCostEl) return;
  
  const fuel = parseFloat(vehicleFuelCostEl.value) || 0;
  const labor = parseFloat(vehicleLaborCostEl.value) || 0;
  vehicleTotalCostEl.value = (fuel + labor).toFixed(2);
}

// Attach event listeners using event delegation (works even if elements are added dynamically)
document.addEventListener('input', function(e) {
  if (e.target.id === 'vehicleFuelCost' || e.target.id === 'vehicleLaborCost') {
    updateVehicleTotalCost();
  }
});

// Also attach on initial load if elements exist
const vehicleFuelCostEl = document.getElementById('vehicleFuelCost');
const vehicleLaborCostEl = document.getElementById('vehicleLaborCost');
if (vehicleFuelCostEl) vehicleFuelCostEl.addEventListener('input', updateVehicleTotalCost);
if (vehicleLaborCostEl) vehicleLaborCostEl.addEventListener('input', updateVehicleTotalCost);

submitBtn.onclick = async () => {
  const requiredFields = [statusSelect, fieldSelect, operationSelect, taskType];
  let hasEmpty = false;

  requiredFields.forEach(el => {
    if(!el.value){
      el.classList.add('border-red-500');
      el.focus();
      const removeRed = () => {
        el.classList.remove('border-red-500');
        el.removeEventListener('input', removeRed);
        el.removeEventListener('change', removeRed);
      };
      el.addEventListener('input', removeRed);
      el.addEventListener('change', removeRed);
      hasEmpty = true;
    }
  });

  if(hasEmpty) return;

  // Map display name to taskFieldMap key (same logic as in taskType.onchange)
  const taskDisplayName = taskType.value;
  const taskKey = taskNameAliases[taskDisplayName] || taskDisplayName;
  const fields = taskFieldMap[taskKey] || [];
  const recordData = {};

for(const f of fields){
  const value = getFinalValue(f.id);
  
  // Include readonly fields in data (computed or not), but skip validation
  if(f.readonly) {
    recordData[f.id] = value;
    continue;
  }

  // Validate non-readonly fields
  // allow 0 for numbers, but not empty string for text
  if(value === '' || value === null){
    const el = document.getElementById(f.id);
    const other = document.getElementById(f.id + '_other');
    el?.classList.add('border-red-500');
    other?.classList.add('border-red-500');
    el?.focus();

    const removeRed = () => {
      el?.classList.remove('border-red-500');
      other?.classList.remove('border-red-500');
      el?.removeEventListener('input', removeRed);
      el?.removeEventListener('change', removeRed);
    };
    el?.addEventListener('input', removeRed);
    el?.addEventListener('change', removeRed);

    return;
  }

  recordData[f.id] = value;
}

  // Also collect truckRented if it exists (from Mechanical selection)
  // Validate it if it's visible (required field)
  const truckRented = document.getElementById('truckRented');
  const truckRentedContainer = document.getElementById('truckRentedContainer');
  if(truckRented && truckRentedContainer && !truckRentedContainer.classList.contains('hidden')) {
    if(!truckRented.value) {
      truckRented.classList.add('border-red-500');
      truckRented.focus();
      const removeRed = () => {
        truckRented.classList.remove('border-red-500');
        truckRented.removeEventListener('change', removeRed);
      };
      truckRented.addEventListener('change', removeRed);
      return;
    }
    recordData.truckRented = truckRented.value;
  }

  // Collect optional bought items
  const boughtItems = [];
  const boughtItemsListEl = document.getElementById('boughtItemsList');
  if (boughtItemsListEl) {
    const boughtItemElements = boughtItemsListEl.querySelectorAll('.border.rounded');
    boughtItemElements.forEach(itemEl => {
    const itemName = itemEl.querySelector('.bought-item-name')?.value?.trim();
    const quantity = parseFloat(itemEl.querySelector('.bought-item-qty')?.value) || 0;
    const unit = itemEl.querySelector('.bought-item-unit')?.value?.trim();
    const price = parseFloat(itemEl.querySelector('.bought-item-price')?.value) || 0;
    const total = parseFloat(itemEl.querySelector('.bought-item-total')?.value) || 0;
    const supplier = itemEl.querySelector('.bought-item-supplier')?.value?.trim();
    const notes = itemEl.querySelector('.bought-item-notes')?.value?.trim();
    
    if (itemName || quantity > 0 || price > 0) {
      boughtItems.push({
        itemName: itemName || '',
        quantity: quantity,
        unit: unit || '',
        price: price,
        total: total,
        supplier: supplier || '',
        notes: notes || ''
      });
    }
    });
  }

  // Collect optional vehicle updates
  let vehicleUpdates = null;
  const vehicleUpdatesContentEl = document.getElementById('vehicleUpdatesContent');
  if (vehicleUpdatesContentEl) {
    const vehicleType = vehicleUpdatesContentEl.querySelector('#vehicleType')?.value?.trim();
    const tripsBoxes = parseFloat(vehicleUpdatesContentEl.querySelector('#tripsBoxes')?.value) || 0;
    const vehicleFuelCost = parseFloat(vehicleUpdatesContentEl.querySelector('#vehicleFuelCost')?.value) || 0;
    const vehicleLaborCost = parseFloat(vehicleUpdatesContentEl.querySelector('#vehicleLaborCost')?.value) || 0;
    const vehicleTotalCost = parseFloat(vehicleUpdatesContentEl.querySelector('#vehicleTotalCost')?.value) || 0;
    const vehicleRoute = vehicleUpdatesContentEl.querySelector('#vehicleRoute')?.value?.trim();
    
    if (vehicleType || tripsBoxes > 0 || vehicleFuelCost > 0 || vehicleLaborCost > 0) {
      vehicleUpdates = {
        vehicleType: vehicleType || '',
        tripsBoxes: tripsBoxes,
        fuelCost: vehicleFuelCost,
        laborCost: vehicleLaborCost,
        totalCost: vehicleTotalCost,
        route: vehicleRoute || ''
      };
    }
  }

  // Extract date from record data for timeline sorting (prefer startDate, fallback to endDate)
  let recordDate = null;
  const dateFields = ['startDate', 'endDate', 'date', 'observationDate', 'assessmentDate', 'plantingDate', 'harvestDate', 'replantingDate'];
  for (const dateField of dateFields) {
    if (recordData[dateField]) {
      const dateValue = recordData[dateField];
      // Handle both Date objects and date strings
      if (dateValue instanceof Date) {
        recordDate = dateValue;
      } else if (typeof dateValue === 'string') {
        recordDate = new Date(dateValue);
      } else {
        recordDate = dateValue;
      }
      break;
    }
  }
  if (!recordDate) {
    recordDate = new Date(); // Use current date if no date field found
  }

  // Convert to Timestamp for Firestore
  const { Timestamp } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
  const recordDateTimestamp = recordDate instanceof Date ? Timestamp.fromDate(recordDate) : Timestamp.fromDate(new Date(recordDate));

  pendingPayload = {
    userId: uid,
    fieldId: fieldSelect.value,
    status: statusSelect.value,
    operation: operationSelect.value,
    taskType: taskType.value,
    data: recordData,
    boughtItems: boughtItems.length > 0 ? boughtItems : null,
    vehicleUpdates: vehicleUpdates,
    recordDate: recordDateTimestamp,
    createdAt: serverTimestamp()
  };

  confirmModal.classList.remove('hidden');
};


window.confirmSave = async () => {
  console.log('Saving...', pendingPayload);

  // Check if offline
  const isOnline = getOnlineStatus();
  // Always allow offline save if on Input Records page
  const canSaveOffline = window.location.pathname.includes('Input-Records.html');

  if (!isOnline && canSaveOffline) {
    // Save offline
    try {
      showLoading(true);
      closeConfirm();
      
      // Convert Firestore objects to serializable format for IndexedDB
      const serializeForIndexedDB = (obj) => {
        if (obj && typeof obj === 'object') {
          if (obj.toDate && typeof obj.toDate === 'function') {
            // Firestore Timestamp - convert to serializable format
            return {
              _type: 'Timestamp',
              seconds: obj.seconds,
              nanoseconds: obj.nanoseconds
            };
          }
          if (obj._methodName === 'serverTimestamp') {
            // serverTimestamp placeholder
            return { _methodName: 'serverTimestamp' };
          }
          if (Array.isArray(obj)) {
            return obj.map(serializeForIndexedDB);
          }
          const serialized = {};
          for (const key in obj) {
            serialized[key] = serializeForIndexedDB(obj[key]);
          }
          return serialized;
        }
        return obj;
      };
      
      const offlinePayload = serializeForIndexedDB(pendingPayload);
      
      await addPendingRecord(offlinePayload);
      
      showLoading(false);
      
      // Show floating notification about auto-sync (NO PAGE REFRESH)
      showNotification('success', 'Record Saved Offline', 'This record will sync automatically when the internet is restored.', [
        {
          text: 'OK',
          type: 'primary',
          action: () => {
            // DO NOT refresh page - just dismiss notification
            // Allow user to continue inputting records offline
            hideNotification();
          }
        }
      ]);
      
      return;
    } catch (error) {
      console.error('Error saving offline:', error);
      showLoading(false);
      showNotification('error', 'Failed to Save Offline', 'An error occurred while saving offline. Please try again.');
      return;
    }
  }

  // Online save (original logic)
  // Show loading state
  showLoading(true);
  closeConfirm();

  try {
    // Prepare main record payload (without subcollections)
    const { boughtItems, vehicleUpdates, ...mainPayload } = pendingPayload;
    
    // Save main record
    const recordRef = await addDoc(collection(db, 'records'), mainPayload);
    const recordId = recordRef.id;

    // Save bought items as subcollection if present
    if (boughtItems && boughtItems.length > 0) {
      const boughtItemsCollection = collection(db, 'records', recordId, 'bought_items');
      for (const item of boughtItems) {
        await addDoc(boughtItemsCollection, {
          ...item,
          createdAt: serverTimestamp()
        });
      }
    }

    // Save vehicle updates as subcollection if present
    if (vehicleUpdates) {
      const vehicleUpdatesCollection = collection(db, 'records', recordId, 'vehicle_updates');
      await addDoc(vehicleUpdatesCollection, {
        ...vehicleUpdates,
        createdAt: serverTimestamp()
      });
    }

    // Handle predicted harvest logic for planting operations
    if (pendingPayload.status === 'Germination' && 
        (pendingPayload.taskType === 'Planting Operation' || pendingPayload.taskType === 'Replanting / Gap Filling')) {
      try {
        // Get planting date - check startDate (new standard), then old field names for backward compatibility
        const plantingDate = pendingPayload.data.startDate || pendingPayload.data.plantingDate || pendingPayload.data.replantingDate || pendingPayload.data.date;
        const variety = pendingPayload.data.variety;
        
        if (plantingDate && variety) {
          // Import growth tracker functions
          const { calculateExpectedHarvestDate, getHarvestDaysRange } = await import('../../backend/Handler/growth-tracker.js');
          
          // Use the calculateExpectedHarvestDate function which handles variety-specific harvest days ranges
          // Uses max value from range for conservative planning
          const plantingDateObj = plantingDate instanceof Date ? plantingDate : new Date(plantingDate);
          const predictedHarvestDate = calculateExpectedHarvestDate(plantingDateObj, variety);
          
          if (!predictedHarvestDate) {
            console.error('Failed to calculate predicted harvest date');
            return;
          }
          
          // Get harvest days range for logging
          const harvestRange = getHarvestDaysRange(variety);
          console.log(`üìÖ Variety: ${variety}, Harvest Days Range: ${harvestRange.min}-${harvestRange.max} days, Predicted Harvest (using max): ${predictedHarvestDate.toLocaleDateString()}`);
          
          // Update field with predicted harvest date
          const { updateDoc, doc, Timestamp } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
          const fieldRef = doc(db, 'fields', pendingPayload.fieldId);
          
          await updateDoc(fieldRef, {
            plantingDate: Timestamp.fromDate(plantingDateObj),
            sugarcane_variety: variety,
            expectedHarvestDate: Timestamp.fromDate(predictedHarvestDate),
            currentGrowthStage: 'Germination',
            status: 'active'
          });
          
          console.log('‚úÖ Predicted harvest date updated:', predictedHarvestDate.toLocaleDateString());
        }
      } catch (error) {
        console.error('Error updating predicted harvest:', error);
        // Don't fail the whole submission if harvest prediction fails
      }
    }

    // Hide loading and show success notification with action buttons
    showLoading(false);
    const fieldId = pendingPayload.fieldId;
    showNotification('success', 'Record Saved Successfully!', 'Your input record has been saved and will appear in the Growth Tracker timeline.', [
      {
        text: 'View in Growth Tracker',
        type: 'primary',
        action: () => {
          window.location.href = `GrowthTracker.html?fieldId=${fieldId}`;
        }
      },
      {
        text: 'Stay Here',
        type: 'secondary',
        action: () => {
          location.reload();
        }
      }
    ]);
  } catch(e) {
    console.error('Error saving record:', e);
    showLoading(false);
    showNotification('error', 'Failed to Save Record', e.message || 'An error occurred while saving. Please try again.');
  }
}


window.closeConfirm=()=>confirmModal.classList.add('hidden')

// Modern Notification System
let notificationTimeout = null;
let notificationCallbacks = [];

function showNotification(type, title, message, actions = null) {
  const banner = document.getElementById('notificationBanner');
  const content = document.getElementById('notificationContent');
  const icon = document.getElementById('notificationIcon');
  const iconI = document.getElementById('notificationIconI');
  const titleEl = document.getElementById('notificationTitle');
  const messageEl = document.getElementById('notificationMessage');
  const actionsEl = document.getElementById('notificationActions');
  
  // Clear any existing timeout
  if (notificationTimeout) {
    clearTimeout(notificationTimeout);
    notificationTimeout = null;
  }
  
  // Clear callbacks
  notificationCallbacks = [];
  
  // Remove all type classes
  content.classList.remove('success', 'error', 'loading', 'info');
  icon.classList.remove('success', 'error', 'loading', 'info');
  
  // Set type classes
  content.classList.add(type);
  icon.classList.add(type);
  
  // Set icon based on type
  if (type === 'success') {
    iconI.className = 'fas fa-check-circle';
  } else if (type === 'error') {
    iconI.className = 'fas fa-exclamation-circle';
  } else if (type === 'loading') {
    iconI.className = 'fas fa-spinner fa-spin';
  } else if (type === 'info') {
    iconI.className = 'fas fa-info-circle';
  }
  
  // Set content
  titleEl.textContent = title;
  messageEl.textContent = message;
  
  // Clear and populate actions
  actionsEl.innerHTML = '';
  if (actions && Array.isArray(actions)) {
    actions.forEach(action => {
      const btn = document.createElement('button');
      btn.className = `notification-btn notification-btn-${action.type || 'primary'}`;
      btn.textContent = action.text;
      if (action.icon) {
        const iconEl = document.createElement('i');
        iconEl.className = action.icon;
        btn.insertBefore(iconEl, btn.firstChild);
      }
      btn.onclick = () => {
        hideNotification();
        if (action.action) {
          setTimeout(() => action.action(), 400); // Wait for animation
        }
      };
      actionsEl.appendChild(btn);
    });
    notificationCallbacks = actions.map(a => a.action).filter(Boolean);
  } else if (actions && typeof actions === 'function') {
    // Backward compatibility: single callback
    notificationCallbacks = [actions];
  }
  
  // Show notification with animation
  setTimeout(() => {
    content.classList.add('show');
  }, 10);
  
  // Auto-hide after 8 seconds for success (longer to allow button clicks), 5 seconds for errors
  const autoHideDelay = type === 'error' ? 5000 : 8000;
  notificationTimeout = setTimeout(() => {
    hideNotification();
  }, autoHideDelay);
}

function hideNotification() {
  const content = document.getElementById('notificationContent');
  content.classList.remove('show');
  
  if (notificationTimeout) {
    clearTimeout(notificationTimeout);
    notificationTimeout = null;
  }
  
  // Clear callbacks (they're handled by button clicks)
  notificationCallbacks = [];
}

function showLoading(show) {
  const overlay = document.getElementById('loadingOverlay');
  if (show) {
    overlay.classList.add('show');
  } else {
    overlay.classList.remove('show');
  }
}

// Legacy toast function for backward compatibility
function toast(msg, err = false) {
  showNotification(err ? 'error' : 'success', err ? 'Error' : 'Success', msg);
}


window.handleOthers = (id) => {
  const select = document.getElementById(id);
  const otherInput = document.getElementById(id + '_other');

  if(!select || !otherInput) return;

  if(select.value === 'Others' || select.value === 'Other'){
    otherInput.classList.remove('hidden');
    otherInput.required = true;
  } else {
    otherInput.classList.add('hidden');
    otherInput.required = false;
    otherInput.value = '';
  }
};

// Also make handleOtherSelect available (for inline handlers)
window.handleOtherSelect = handleOtherSelect;

function getFinalValue(id){
  const el = document.getElementById(id);
  const other = document.getElementById(id + '_other');
  if(!el) return null;

  if(el.tagName === 'SELECT' && (el.value === 'Others' || el.value === 'Other')){
    return other?.value || '';
  }

  // ‚úÖ Convert number inputs to number type
  if(el.type === 'number') return parseFloat(el.value) || 0;
  
  // ‚úÖ Handle textarea
  if(el.tagName === 'TEXTAREA') return el.value;

  return el.value;
}

// Old toast element removed - using modern notification system instead
</script>

</body>
</html>
