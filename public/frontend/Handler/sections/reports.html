<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>CaneMap - Reports</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- PDF Generation Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --cane-50: #f7fee7;
      --cane-100: #ecfcca;
      --cane-200: #d8f999;
      --cane-300: #bbf451;
      --cane-400: #9ae600;
      --cane-500: #7ccf00;
      --cane-600: #5ea500;
      --cane-700: #497d00;
      --cane-800: #3c6300;
      --cane-900: #35530e;
      --cane-950: #192e03;
    }

    .section-card {
      background: white;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .inner-box {
      background: var(--cane-50);
      border: 1px solid var(--cane-200);
    }

    .drop-zone {
      border: 2px dashed var(--cane-200);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--cane-700), var(--cane-800));
      color: #fff;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--cane-800), var(--cane-900));
    }

    .search-input {
      padding: 0.65rem 0.85rem;
      padding-left: 2.5rem;
      border-radius: 0.75rem;
      border: 1px solid #d9e2ec;
      background: #fff;
      font-size: 0.85rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--cane-500);
      box-shadow: 0 0 0 3px rgba(124, 207, 0, 0.15);
    }

    table thead th {
      background: #f8fafc;
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #6b7280;
      font-weight: 600;
      padding: 1rem;
    }

    table tbody tr {
      transition: background-color 0.15s ease;
    }

    table tbody tr:hover {
      background-color: #f9fafb;
    }

    table tbody td {
      padding: 1.25rem 1rem;
      font-size: 0.95rem;
    }

    #reportModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }

    #reportModal.active {
      display: flex;
    }

    #reportModal .modal-content {
      background: linear-gradient(135deg, #ecfcca, #f7fee7);
      border-radius: 1rem;
      max-width: 1100px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
      margin: auto;
    }

    /* Desktop: Adjust modal position based on sidebar state */
    @media (min-width: 1024px) {
      #reportModal {
        left: 16rem;
        /* Default: sidebar expanded (256px = 16rem) */
        width: calc(100vw - 16rem);
      }

      /* When sidebar is collapsed */
      body.sidebar-collapsed #reportModal {
        left: 5rem;
        /* Collapsed sidebar width (80px = 5rem) */
        width: calc(100vw - 5rem);
      }
    }

    /* Mobile responsiveness: Prevent reports section from causing horizontal scroll */
    @media (max-width: 768px) {
      body {
        overflow-x: hidden;
        max-width: 100vw;
      }

      main {
        overflow-x: hidden;
        max-width: 100%;
        width: 100%;
      }

      .section-card {
        overflow-x: hidden;
        max-width: 100%;
        width: 100%;
        box-sizing: border-box;
      }

      /* Ensure table container doesn't overflow */
      .section-card>div:last-of-type {
        max-width: 100%;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
    }

    /* Android WebView specific fixes */
    @supports (-webkit-appearance: none) {
      .section-card {
        max-width: 100vw;
        box-sizing: border-box;
      }

      .section-card>div:last-of-type {
        max-width: 100%;
      }
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen p-6">

  <main class="container mx-auto px-4 lg:px-6 py-6 mt-12 mb-10">
    <!-- Reports List Section -->
    <div class="section-card rounded-2xl p-6">
      <div class="mb-5">
        <h2 class="text-2xl font-bold text-[var(--cane-950)] mb-1 flex items-center gap-2">
          <span
            class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-[var(--cane-100)] text-[var(--cane-700)]">
            <i class="fas fa-file-alt"></i>
          </span>
          My Reports
        </h2>
        <p class="text-sm text-gray-600">Manage and track all submitted reports to SRA.</p>
      </div>

      <!-- Action Bar -->
      <div class="mb-4 flex flex-col sm:flex-row justify-between gap-3">
        <button id="createReportBtn"
          class="btn-primary px-5 py-2.5 rounded-lg font-semibold shadow-md transition-all hover:shadow-lg">
          <i class="fas fa-plus mr-2"></i>Create Report
        </button>
        <div class="flex gap-3 flex-1 justify-end">
          <select id="fieldFilter"
            class="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-[var(--cane-600)]">
            <option value="all">All Fields</option>
          </select>
          <div class="relative flex-1 sm:max-w-xs">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-sm text-gray-400"></i>
            <input id="searchReports" type="text" placeholder="Search reports..." class="search-input pl-9 w-full" />
          </div>
        </div>
      </div>

      <!-- Reports Table -->
      <div class="rounded-xl border border-gray-200"
        style="width: 100%; max-width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; box-sizing: border-box;">
        <table style="min-width: 100%; width: auto; table-layout: auto;">
          <thead>
            <tr>
              <th class="text-left">Date Submitted</th>
              <th class="text-left">Report Type</th>
              <th class="text-left">Field</th>
              <th class="text-left">Status</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="reportsTbody">
            <!-- Reports will be loaded dynamically from Firestore -->
          </tbody>
        </table>
      </div>

      <!-- Empty State (hidden by default) -->
      <div id="reportsEmpty"
        class="hidden mt-4 rounded-xl border border-dashed border-gray-300 bg-gray-50 p-8 text-center">
        <div
          class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-white text-gray-400 shadow-inner">
          <i class="fas fa-file-alt text-2xl"></i>
        </div>
        <h3 class="mt-4 text-lg font-semibold text-gray-900">No reports yet</h3>
        <p class="mt-2 text-sm text-gray-600">Create your first report to submit to SRA.</p>
      </div>
    </div>
  </main>

  <!-- Modal for Report Form -->
  <div id="reportModal" class="modal">
    <div class="modal-content p-8">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <button id="closeModalBtn" class="text-gray-600 hover:text-gray-800">
            <i class="fas fa-arrow-left text-xl"></i>
          </button>
          <h2 class="text-2xl font-bold text-[var(--cane-900)]">Create Report</h2>
        </div>
      </div>

      <!-- Report Type Selection -->
      <div id="reportTypeSelection">
        <p class="text-sm text-[var(--cane-800)] mb-6">Select the type of report you want to create</p>
        <div id="reportTypesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
          <!-- Report type cards will be dynamically loaded here -->
        </div>
      </div>

      <!-- Dynamic Report Form Container -->
      <div id="reportFormContainer" class="hidden"></div>
    </div>
  </div>
  </main>

  <script type="module">
    import { db, auth } from '../../../backend/Common/firebase-config.js';
    import { collection, addDoc, query, where, getDocs, getDoc, doc, orderBy, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
    import { getReportTypes, renderReportForm } from '../../../backend/Handler/reports.js?v=1763445366';

    let currentUserId = null;
    let allReportsData = []; // Store all reports for filtering
    let fieldsMap = new Map(); // Store field names

    onAuthStateChanged(auth, user => {
      if (user) {
        currentUserId = user.uid;
        loadFieldsForFilter();
        loadReports();

        // Check if a report was requested via notification
        checkForRequestedReport();
      }
    });

    // Check if SRA requested a specific report and auto-open it
    function checkForRequestedReport() {
      const requestedType = sessionStorage.getItem('requestedReportType');
      if (requestedType) {
        // Clear the session storage
        sessionStorage.removeItem('requestedReportType');

        // Open modal and load report types
        modal.classList.add('active');
        loadReportTypes();

        // Automatically select the requested report type
        setTimeout(() => {
          selectReportType(requestedType);
        }, 100);
      }
    }

    // Load fields for the filter dropdown
    async function loadFieldsForFilter() {
      try {
        const fieldsQuery = query(
          collection(db, 'fields'),
          where('userId', '==', currentUserId),
          where('status', 'in', ['reviewed', 'active'])
        );
        const fieldsSnapshot = await getDocs(fieldsQuery);

        const fieldFilter = document.getElementById('fieldFilter');
        fieldFilter.innerHTML = '<option value="all">All Fields</option>';

        fieldsSnapshot.forEach(doc => {
          const field = doc.data();
          const fieldName = field.field_name || field.fieldName || 'Unnamed Field';
          fieldsMap.set(doc.id, fieldName);

          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = fieldName;
          fieldFilter.appendChild(option);
        });

        // Add filter change listener
        fieldFilter.addEventListener('change', () => {
          renderFilteredReports();
        });

      } catch (error) {
        console.error('Error loading fields for filter:', error);
      }
    }

    // Render reports with current filter
    function renderFilteredReports() {
      const tbody = document.getElementById('reportsTbody');
      const emptyState = document.getElementById('reportsEmpty');
      const fieldFilter = document.getElementById('fieldFilter');
      const selectedField = fieldFilter ? fieldFilter.value : 'all';

      // Filter reports by field
      let filteredReports = allReportsData;
      if (selectedField !== 'all') {
        filteredReports = allReportsData.filter(report => report.fieldId === selectedField);
      }

      tbody.innerHTML = '';

      if (filteredReports.length === 0) {
        emptyState.classList.remove('hidden');
        tbody.parentElement.parentElement.classList.add('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      tbody.parentElement.parentElement.classList.remove('hidden');

      const reportTypes = getReportTypes();
      const statusColors = {
        'pending_review': 'bg-yellow-100 text-yellow-700',
        'approved': 'bg-green-100 text-green-700',
        'rejected': 'bg-red-100 text-red-700'
      };
      const statusLabels = {
        'pending_review': 'Pending Review',
        'approved': 'Approved',
        'rejected': 'Rejected'
      };

      filteredReports.forEach(report => {
        const reportId = report.id;
        const dateStr = report.submittedDate
          ? report.submittedDate.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
          : '‚Äî';

        const reportTypeLabel = reportTypes[report.reportType]?.label || report.reportType || 'Unknown';

        const status = report.status || 'pending_review';
        const statusColor = statusColors[status] || 'bg-gray-100 text-gray-700';
        const statusLabel = statusLabels[status] || status;

        // Get field name from fieldsMap
        const fieldName = report.fieldId && fieldsMap.has(report.fieldId)
          ? fieldsMap.get(report.fieldId)
          : (report.fieldId ? 'Loading...' : 'No field');

        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="text-gray-600">${dateStr}</td>
          <td class="text-gray-900 font-medium">${reportTypeLabel}</td>
          <td class="text-gray-600">${fieldName}</td>
          <td>
            <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
              ${statusLabel}
            </span>
          </td>
          <td class="text-right">
            <button class="text-blue-600 hover:text-blue-800 text-sm font-medium" onclick="viewReportDetails('${reportId}')">
              <i class="fas fa-eye mr-1"></i> View
            </button>
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    // Load reports from Firestore with REAL-TIME updates
    async function loadReports() {
      const tbody = document.getElementById('reportsTbody');
      const emptyState = document.getElementById('reportsEmpty');

      tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">Loading reports...</td></tr>';

      try {
        const reportsQuery = query(
          collection(db, 'reports'),
          where('handlerId', '==', currentUserId),
          orderBy('submittedDate', 'desc')
        );

        // üî• REAL-TIME listener using onSnapshot with optimization
        onSnapshot(reportsQuery, (snapshot) => {
          // Prevent double-rendering from local writes
          if (snapshot.metadata.hasPendingWrites) {
            console.log('‚è≠Ô∏è Skipping render - pending local writes');
            return;
          }

          // Store all reports data
          allReportsData = snapshot.docs.map(docSnap => ({
            id: docSnap.id,
            ...docSnap.data()
          }));

          // Render with current filter
          renderFilteredReports();
        }, (error) => {
          console.error('‚ùå Reports listener error:', error);
          tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Error loading reports</td></tr>';
        });
      } catch (err) {
        console.error('Error loading reports:', err);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Error loading reports</td></tr>';
      }
    }

    // View report details
    window.viewReportDetails = async function (reportId) {
      try {
        const reportDoc = await getDoc(doc(db, 'reports', reportId));
        if (!reportDoc.exists()) {
          alert('Report not found');
          return;
        }

        const report = reportDoc.data();
        const reportTypes = getReportTypes();
        const reportTypeLabel = reportTypes[report.reportType]?.label || report.reportType;

        // Create modal to show report details
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black/40';

        let dataHTML = '';
        if (report.data && typeof report.data === 'object') {
          dataHTML = Object.entries(report.data).map(([key, value]) => {
            const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());

            // Check if value is a photo URL or array of photo URLs
            const isPhotoURL = (val) => typeof val === 'string' && (
              val.includes('firebase') ||
              val.includes('storage.googleapis.com') ||
              val.startsWith('http') && (val.includes('.jpg') || val.includes('.png') || val.includes('.jpeg') || val.includes('.webp'))
            );

            if (isPhotoURL(value)) {
              // Single photo
              return `
                <div class="py-3 border-b border-gray-200">
                  <span class="font-medium text-gray-700 block mb-2">${label}:</span>
                  <img src="${value}" alt="Report photo" class="w-48 h-48 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-80 transition" crossorigin="anonymous" onclick="window.viewPhotoModal('${value}')">
                </div>
              `;
            } else if (Array.isArray(value) && value.length > 0 && isPhotoURL(value[0])) {
              // Array of photos
              return `
                <div class="py-3 border-b border-gray-200">
                  <span class="font-medium text-gray-700 block mb-2">${label}:</span>
                  <div class="grid grid-cols-3 gap-2">
                    ${value.map(url => `
                      <img src="${url}" alt="Report photo" class="w-full h-24 object-cover rounded-lg border border-gray-200 cursor-pointer hover:opacity-80 transition" crossorigin="anonymous" onclick="window.viewPhotoModal('${url}')">
                    `).join('')}
                  </div>
                </div>
              `;
            } else {
              // Regular text value
              return `
                <div class="flex justify-between py-2 border-b border-gray-200">
                  <span class="font-medium text-gray-700">${label}:</span>
                  <span class="text-gray-900">${Array.isArray(value) ? value.join(', ') : value}</span>
                </div>
              `;
            }
          }).join('');
        }

        modal.innerHTML = `
          <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto" id="reportDetailContent">
            <div class="p-6">
              <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-900">${reportTypeLabel}</h3>
                <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600 print:hidden">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>

              <!-- Report Metadata -->
              <div class="mb-4 p-4 bg-gray-50 rounded-lg space-y-2">
                <div class="flex items-center text-sm">
                  <span class="font-medium text-gray-700 w-32">Status:</span>
                  <span class="inline-flex px-3 py-1 text-xs font-medium rounded-full ${report.status === 'approved' ? 'bg-green-100 text-green-700' : report.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
                    ${report.status === 'approved' ? 'Approved' : report.status === 'rejected' ? 'Rejected' : 'Pending Review'}
                  </span>
                </div>
                <div class="flex items-center text-sm">
                  <span class="font-medium text-gray-700 w-32">Submitted:</span>
                  <span class="text-gray-900">${report.submittedDate ? report.submittedDate.toDate().toLocaleString() : 'Unknown'}</span>
                </div>
              </div>

              <!-- Report Data -->
              <h4 class="text-sm font-semibold text-gray-700 mb-2">Report Details</h4>
              <div class="space-y-2">
                ${dataHTML}
              </div>

              ${report.remarks ? `
                <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                  <p class="text-sm font-medium text-yellow-800">SRA Remarks:</p>
                  <p class="text-sm text-yellow-700 mt-1">${report.remarks}</p>
                </div>
              ` : ''}

              <!-- Export Actions -->
              <div class="flex items-center justify-end gap-2 mt-6 pt-4 border-t border-gray-200 print:hidden">
                <button onclick="window.downloadReportPDF('${reportId}', '${reportTypeLabel}')" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg font-medium transition flex items-center gap-2" id="downloadReportBtn_${reportId}">
                  <i class="fas fa-download"></i> Download PDF
                </button>
                <button onclick="window.printReport()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg font-medium transition flex items-center gap-2">
                  <i class="fas fa-print"></i> Print Report
                </button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modal);
      } catch (error) {
        console.error('Error viewing report:', error);
        alert('Failed to load report details');
      }
    };

    // View photo in modal (enlarge)
    window.viewPhotoModal = function (photoUrl) {
      const photoModal = document.createElement('div');
      photoModal.className = 'fixed inset-0 z-[99999] flex items-center justify-center bg-black/80';
      photoModal.innerHTML = `
        <div class="relative max-w-4xl max-h-[90vh] p-4">
          <button onclick="this.closest('.fixed').remove()" class="absolute top-6 right-6 text-white bg-black/50 rounded-full p-2 hover:bg-black/70 transition z-10">
            <i class="fas fa-times text-xl"></i>
          </button>
          <img src="${photoUrl}" alt="Photo" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl">
        </div>
      `;
      photoModal.addEventListener('click', (e) => {
        if (e.target === photoModal) {
          photoModal.remove();
        }
      });
      document.body.appendChild(photoModal);
    };

    // Helper function to convert image URL to base64
    async function imageUrlToBase64(url) {
      try {
        const response = await fetch(url, {
          mode: 'cors',
          credentials: 'include'
        });
        const blob = await response.blob();
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onloadend = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(blob);
        });
      } catch (error) {
        console.warn('Failed to convert image to base64:', url, error);
        return url; // Fallback to original URL
      }
    }

    // Download report as PDF
    window.downloadReportPDF = async function (reportId, reportTypeLabel) {
      // Find and show loading on download button
      const downloadBtn = document.getElementById(`downloadReportBtn_${reportId}`) ||
        document.querySelector(`button[onclick*="downloadReportPDF('${reportId}'"]`) ||
        event?.target?.closest('button');
      const originalContent = downloadBtn ? downloadBtn.innerHTML : '';
      if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
      }

      try {
        const element = document.getElementById('reportDetailContent');
        if (!element) {
          alert('Report content not found');
          return;
        }

        // Check if html2pdf library is loaded
        if (typeof window.html2pdf === 'undefined') {
          alert('PDF library not loaded. Please refresh the page and try again.');
          return;
        }

        // Clone the element to modify it for PDF
        const clone = element.cloneNode(true);

        // Remove buttons from the clone
        const buttons = clone.querySelectorAll('button');
        buttons.forEach(btn => btn.remove());

        // Convert all images to base64 to avoid CORS issues
        const images = clone.querySelectorAll('img');
        const imageConversionPromises = Array.from(images).map(async (img) => {
          if (img.src && img.src.includes('firebasestorage.googleapis.com')) {
            try {
              const base64 = await imageUrlToBase64(img.src);
              img.src = base64;
              // Set crossOrigin attribute for any remaining external images
              img.crossOrigin = 'anonymous';
            } catch (error) {
              console.warn('Failed to convert image:', img.src);
            }
          }
          // Wait for image to load
          return new Promise((resolve) => {
            if (img.complete) {
              resolve();
            } else {
              img.onload = resolve;
              img.onerror = resolve;
            }
          });
        });

        await Promise.all(imageConversionPromises);

        // Configure PDF options
        const filename = `${reportTypeLabel.replace(/\s+/g, '_')}_${new Date().toLocaleDateString().replace(/\//g, '-')}.pdf`;
        const opt = {
          margin: 10,
          filename: filename,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: {
            scale: 2,
            useCORS: true,
            allowTaint: true,
            logging: false
          },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        // Generate PDF - use downloadFile for both browser and Android (faster)
        const { downloadFile } = await import('../../../backend/Common/android-download.js');

        // Generate blob and use download utility (works for both browser and Android)
        const pdfBlob = await new Promise((resolve, reject) => {
          window.html2pdf().set(opt).from(clone).outputPdf('blob').then(resolve).catch(reject);
        });
        await downloadFile(pdfBlob, filename);

        // Small delay to ensure download starts before hiding animation
        await new Promise(resolve => setTimeout(resolve, 500));
        console.log('‚úÖ PDF generated successfully');
      } catch (error) {
        console.error('Error generating PDF:', error);
        alert('Failed to generate PDF. Please try again.');
      } finally {
        // Hide loading animation
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.innerHTML = originalContent;
        }
      }
    };

    // Print report
    window.printReport = function () {
      const reportContent = document.getElementById('reportDetailContent');
      if (!reportContent) return;

      const printWindow = window.open('', '', 'height=800,width=800');
      printWindow.document.write('<html><head><title>Print Report</title>');
      printWindow.document.write('<style>');
      printWindow.document.write('body { font-family: Arial, sans-serif; padding: 20px; }');
      printWindow.document.write('.flex { display: flex; justify-content: space-between; }');
      printWindow.document.write('.border-b { border-bottom: 1px solid #e5e7eb; padding: 10px 0; }');
      printWindow.document.write('.font-medium { font-weight: 600; }');
      printWindow.document.write('img { max-width: 200px; margin: 10px 0; }');
      printWindow.document.write('button { display: none; }');
      printWindow.document.write('</style></head><body>');
      printWindow.document.write(reportContent.innerHTML);
      printWindow.document.write('</body></html>');
      printWindow.document.close();
      printWindow.focus();
      setTimeout(() => {
        printWindow.print();
        printWindow.close();
      }, 250);
    };

    // Modal controls
    const modal = document.getElementById('reportModal');
    const createReportBtn = document.getElementById('createReportBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const reportTypeSelection = document.getElementById('reportTypeSelection');
    const reportFormContainer = document.getElementById('reportFormContainer');
    const reportTypesGrid = document.getElementById('reportTypesGrid');

    // Populate report types
    function loadReportTypes() {
      const reportTypes = getReportTypes();
      reportTypesGrid.innerHTML = '';

      Object.entries(reportTypes).forEach(([key, config]) => {
        const card = document.createElement('div');
        card.className = 'bg-white border border-[var(--cane-200)] rounded-lg p-4 hover:shadow-lg transition-all cursor-pointer hover:border-[var(--cane-500)]';
        card.innerHTML = `
          <div class="flex flex-col items-center text-center">
            <div class="w-12 h-12 bg-[var(--cane-100)] rounded-full flex items-center justify-center mb-3">
              <i class="fas ${config.icon} text-[var(--cane-700)] text-xl"></i>
            </div>
            <h3 class="font-semibold text-[var(--cane-900)] text-sm">${config.label}</h3>
          </div>
        `;
        card.addEventListener('click', () => {
          selectReportType(key);
        });
        reportTypesGrid.appendChild(card);
      });
    }

    // Select report type and show form
    function selectReportType(reportType) {
      reportTypeSelection.classList.add('hidden');
      reportFormContainer.classList.remove('hidden');
      reportFormContainer.innerHTML = '';
      renderReportForm(reportType, 'reportFormContainer');

      // Add back button functionality
      const backBtn = document.createElement('button');
      backBtn.className = 'mb-4 text-[var(--cane-700)] hover:text-[var(--cane-800)] font-medium';
      backBtn.innerHTML = '<i class="fas fa-arrow-left mr-2"></i> Back to report types';
      backBtn.addEventListener('click', () => {
        reportFormContainer.classList.add('hidden');
        reportTypeSelection.classList.remove('hidden');
      });
      reportFormContainer.insertBefore(backBtn, reportFormContainer.firstChild);
    }

    createReportBtn.addEventListener('click', () => {
      modal.classList.add('active');
      loadReportTypes();
      reportTypeSelection.classList.remove('hidden');
      reportFormContainer.classList.add('hidden');
    });

    closeModalBtn.addEventListener('click', () => {
      modal.classList.remove('active');
      reportTypeSelection.classList.remove('hidden');
      reportFormContainer.classList.add('hidden');
    });

    // Close modal when clicking outside
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        reportTypeSelection.classList.remove('hidden');
        reportFormContainer.classList.add('hidden');
      }
    });

    // Search functionality
    document.getElementById('searchReports').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#reportsTbody tr');

      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
      });
    });
  </script>

</body>

</html>