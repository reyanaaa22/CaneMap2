<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CaneMap - Driver Dashboard</title>

  <!-- Tailwind CSS -->
  <link rel="stylesheet" href="../../css/output.css" />

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <!-- SweetAlert2 for modals -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <!-- FullCalendar -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <!-- Leaflet CSS and JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root {
      --cane-50: #f7fee7;
      --cane-100: #ecfcca;
      --cane-200: #d8f999;
      --cane-300: #bbf451;
      --cane-400: #9ae600;
      --cane-500: #7ccf00;
      --cane-600: #5ea500;
      --cane-700: #497d00;
      --cane-800: #3c6300;
      --cane-900: #35530e;
      --cane-950: #192e03;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--cane-500), var(--cane-600));
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, var(--cane-600), var(--cane-700));
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(94, 165, 0, 0.3);
    }

    .btn-secondary {
      background: linear-gradient(135deg, var(--cane-200), var(--cane-300));
      color: var(--cane-800);
      transition: all 0.3s ease;
    }

    .btn-secondary:hover {
      background: linear-gradient(135deg, var(--cane-300), var(--cane-400));
      transform: translateY(-1px);
    }

    .section-card {
      background: linear-gradient(135deg, white, var(--cane-50));
      border: 1px solid var(--cane-200);
      transition: all 0.3s ease;
    }

    .section-card:hover {
      box-shadow: 0 8px 25px rgba(94, 165, 0, 0.15);
      transform: translateY(-2px);
    }

    .badge-indicator {
      background: linear-gradient(135deg, var(--cane-400), var(--cane-500));
      color: white;
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 600;
    }

    .driver-feature {
      border-left: 4px solid var(--cane-500);
      background: linear-gradient(135deg, var(--cane-50), white);
    }

    /* Sidebar transitions */
    .sidebar-transition {
      transition: transform 0.3s ease-in-out;
    }

    /* Mobile sidebar overlay */
    .sidebar-overlay {
      transition: opacity 0.3s ease-in-out;
    }

    /* Desktop collapsed sidebar */
    @media (min-width: 1024px) {
      body.sidebar-collapsed #sidebar {
        width: 5rem;
      }

      body.sidebar-collapsed #sidebar .nav-item span:not(.section-header) {
        opacity: 0;
        width: 0;
        overflow: hidden;
        display: none;
      }

      body.sidebar-collapsed #sidebar .nav-item {
        justify-content: center;
        padding-left: 0.75rem;
        padding-right: 0.75rem;
      }

      body.sidebar-collapsed #sidebar .nav-item i {
        margin: 0;
      }

      body.sidebar-collapsed #sidebar #sidebarUserName,
      body.sidebar-collapsed #sidebar #sidebarUserType {
        display: none;
      }

      body.sidebar-collapsed #sidebar .flex.items-center.space-x-3>div:not(:first-child) {
        display: none;
      }

      body.sidebar-collapsed #sidebar .space-x-3 {
        gap: 0;
      }
    }

    /* Hide section headers when sidebar is collapsed */
    @media (min-width: 1024px) {
      body.sidebar-collapsed #sidebar .section-header {
        display: none !important;
      }
    }

    /* Ensure content/header shift with sidebar state on desktop */
    @media (min-width: 1024px) {
      body:not(.sidebar-collapsed) #driverMainWrapper {
        margin-left: 16rem !important;
      }

      body.sidebar-collapsed #driverMainWrapper {
        margin-left: 5rem !important;
      }

      body:not(.sidebar-collapsed) #driverHeaderContainer {
        padding-left: 16rem !important;
      }

      body.sidebar-collapsed #driverHeaderContainer {
        padding-left: 5rem !important;
      }
    }

    /* FullCalendar customization */
    .fc {
      font-family: inherit;
      background: white;
      border-radius: 0.75rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      overflow: hidden;
      font-size: 0.875rem;
    }

    .fc {
      height: auto !important;
    }

    .fc .fc-scroller {
      overflow: visible !important;
    }

    .fc-toolbar {
      background: linear-gradient(135deg, var(--cane-50), white);
      border-bottom: 1px solid var(--cane-200);
      padding: 0.5rem;
    }

    .fc-toolbar-title {
      color: var(--cane-800);
      font-weight: 600;
      font-size: 1rem;
    }

    .fc-button-primary {
      background: linear-gradient(135deg,
          var(--cane-500),
          var(--cane-600)) !important;
      border: none !important;
      border-radius: 0.375rem !important;
      padding: 0.25rem 0.5rem !important;
      font-weight: 500 !important;
      font-size: 0.75rem !important;
      box-shadow: 0 1px 2px rgba(94, 165, 0, 0.2) !important;
      transition: all 0.3s ease !important;
      min-height: auto !important;
      line-height: 1.2 !important;
    }

    .fc-button-primary:hover {
      background: linear-gradient(135deg,
          var(--cane-600),
          var(--cane-700)) !important;
      transform: translateY(-1px) !important;
      box-shadow: 0 4px 8px rgba(94, 165, 0, 0.3) !important;
    }

    .task-filter-btn {
      background: #f1f5f9;
      color: #64748b;
      border: 1px solid #e2e8f0;
      transition: all 0.2s;
    }

    .task-filter-btn:hover {
      background: #e2e8f0;
      color: #475569;
    }

    .task-filter-btn.active {
      background: var(--cane-600);
      color: white;
      border-color: var(--cane-600);
    }

    /* Task Filter Select Dropdown */
    .task-filter-select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%235ea500' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 0.75rem center;
      padding-right: 2.5rem;
      transition: all 0.2s;
    }

    .task-filter-select:hover {
      border-color: var(--cane-600);
      box-shadow: 0 2px 4px rgba(94, 165, 0, 0.1);
    }

    .task-filter-select:focus {
      outline: none;
      border-color: var(--cane-600);
      box-shadow: 0 0 0 3px rgba(94, 165, 0, 0.1);
    }
  </style>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Header -->
  <header class="shadow-lg bg-white relative z-30">
    <div id="driverHeaderContainer" class="container mx-auto px-6 py-3 lg:pl-64">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <!-- Hamburger (header, left) -->
          <button id="hamburgerBtn"
            class="lg:hidden text-gray-800 hover:text-cane-600 transition-colors hamburger-icon p-3 -ml-2"
            onclick="toggleSidebar()" aria-label="Toggle menu">
            <i class="fas fa-bars text-xl"></i>
          </button>
        </div>
        <div class="text-center">
          <div class="flex items-center justify-center space-x-2">
            <span id="badgeIndicator" class="badge-indicator hidden">Driver Badge</span>
          </div>
        </div>
        <div class="flex items-center space-x-4">
          <!-- Notification Bell -->
          <div class="relative">
            <button id="notificationBtn" class="text-gray-700 hover:text-cane-600 transition-colors relative">
              <i class="fas fa-bell text-lg"></i>
              <span id="notificationCount"
                class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center hidden">0</span>
            </button>

            <!-- Notification Dropdown -->
            <div id="notificationDropdown"
              class="hidden fixed lg:absolute bottom-auto lg:bottom-auto top-16 lg:top-auto right-4 lg:right-0 lg:left-auto lg:mt-2 w-80 lg:w-80 bg-white rounded-lg shadow-xl border border-[var(--cane-200)] z-50 max-h-[70vh] overflow-y-auto">
              <div class="p-3 border-b border-gray-200 flex items-center justify-between">
                <h3 class="font-semibold text-[var(--cane-900)]">Notifications</h3>
                <div class="flex items-center gap-2">
                  <button id="markAllReadBtn"
                    class="text-[var(--cane-600)] hover:text-[var(--cane-700)] transition-colors"
                    title="Mark all as read">
                    <i class="fas fa-check-double text-sm"></i>
                  </button>
                  <button id="refreshNotifications"
                    class="text-[var(--cane-600)] hover:text-[var(--cane-700)] transition-colors" title="Refresh">
                    <i class="fas fa-sync-alt text-sm"></i>
                  </button>
                  <button id="closeNotificationDropdown" class="text-gray-400 hover:text-gray-600 transition-colors"
                    title="Close">
                    <i class="fas fa-times text-sm"></i>
                  </button>
                </div>
              </div>
              <div id="notificationsList" class="divide-y divide-gray-100">
                <!-- Notifications will be loaded here -->
              </div>
            </div>
          </div>

          <!-- Profile Dropdown -->
          <div class="relative">
            <button id="profileDropdownBtn"
              class="group flex items-center space-x-2 text-gray-700 hover:text-cane-600 transition-all duration-300">
              <div
                class="w-8 h-8 bg-gradient-to-br from-[var(--cane-400)] to-[var(--cane-500)] rounded-full flex items-center justify-center shadow-md border border-white/30 overflow-hidden"
                id="profileIconContainer">
                <i class="fas fa-user text-white text-sm" id="profileIconDefault" style="display: flex; align-items: center; justify-content: center;"></i>
                <img id="profilePhoto" class="w-full h-full object-cover hidden" alt="Profile" />
              </div>
              <span class="font-medium uppercase tracking-wider text-sm" id="userName">Driver</span>
              <i
                class="fas fa-chevron-down text-gray-600 text-xs ml-1 transition-transform duration-200 transform group-hover:translate-y-0.5"></i>
            </button>

            <div id="profileDropdown"
              class="absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl border border-[var(--cane-200)] opacity-0 invisible transition-all duration-300 transform scale-95 origin-top-right z-50">
              <div class="py-2">
                <div class="px-4 py-3 border-b border-[var(--cane-100)]">
                  <p class="text-sm font-medium text-[var(--cane-900)]" id="dropdownUserName">
                    Driver
                  </p>
                  <p class="text-xs text-[var(--cane-600)]" id="dropdownUserType">
                    Driver
                  </p>
                </div>
                <a href="../Common/profile-settings.html"
                  class="flex items-center px-4 py-2 text-sm text-[var(--cane-700)] hover:bg-[var(--cane-50)] transition-colors">
                  <i class="fas fa-user-edit mr-3 text-[var(--cane-500)]"></i>
                  Profile Information
                </a>
                <a href="../Common/lobby.html"
                  class="flex items-center px-4 py-2 text-sm text-[var(--cane-700)] hover:bg-[var(--cane-50)] transition-colors"
                  id="lobbyBtn">
                  <i class="fas fa-home mr-3 text-[var(--cane-500)]"></i>
                  Lobby
                </a>
                <button
                  class="w-full text-left flex items-center px-4 py-2 text-sm text-[var(--cane-700)] hover:bg-[var(--cane-50)] transition-colors"
                  id="openRentalBtn">
                  <i class="fas fa-truck-moving mr-3 text-[var(--cane-500)]"></i>
                  Open a Rental
                </button>
                <div class="border-t border-[var(--cane-100)] mt-2">
                  <button id="driverLogoutBtn"
                    class="flex items-center w-full px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    Logout
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content with Sidebar -->
  <div id="driverMainWrapper" class="flex relative lg:ml-64">
    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden hidden"
      style="z-index: 45;"></div>

    <!-- Left Sidebar -->
    <aside id="sidebar"
      class="fixed left-0 top-0 h-full w-64 shadow-lg transform -translate-x-full lg:translate-x-0 z-50 transition-all duration-300 ease-in-out flex flex-col"
      style="background: linear-gradient(180deg, var(--cane-700) 0%, var(--cane-600) 100%);">
      <div class="p-6">
        <!-- Close button for mobile -->
        <div class="flex justify-between items-center mb-4">
          <!-- Desktop collapse button -->
          <button id="collapseSidebarBtn"
            class="hidden lg:inline-flex items-center justify-center text-gray-300 hover:text-white p-2 rounded"
            title="Collapse sidebar" onclick="toggleSidebarCollapse()">
            <i class="fas fa-bars"></i>
          </button>
          <!-- Close button for mobile -->
          <div class="lg:hidden">
            <button id="closeSidebarBtn" class="text-gray-400 hover:text-white">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
        </div>

        <!-- Driver Profile (compact) -->
        <div class="flex items-center space-x-3 mb-5">
          <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center overflow-hidden flex-shrink-0"
            id="sidebarProfileImageContainer">
            <i class="fas fa-user text-white text-xl" id="sidebarProfileIconDefault" style="display: flex; align-items: center; justify-content: center;"></i>
            <img id="sidebarProfilePhoto" class="w-full h-full object-cover hidden" alt="Profile" />
          </div>
          <div class="text-left">
            <p class="text-sm font-medium text-white uppercase tracking-wider" id="sidebarUserName">Driver</p>
            <p class="text-xs text-white/80" id="sidebarUserType">Driver</p>
          </div>
        </div>
        <div class="border-b border-gray-700 mb-4"></div>

        <!-- Navigation Menu -->
        <nav class="space-y-2">
          <!-- Dashboard -->
          <a href="#"
            class="nav-item flex items-center gap-3 p-3 text-white/90 hover:bg-white/10 rounded-lg transition-all duration-200 text-lg"
            data-section="dashboard">
            <i class="fas fa-gauge-high w-5 h-5"></i>
            <span>Dashboard</span>
          </a>
          <p class="section-header text-xs font-medium text-white/70 uppercase tracking-wider px-4 pt-1 pb-2">Overview</p>

          <!-- My Fields -->
          <a href="#"
            class="nav-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors text-lg"
            data-section="my-fields">
            <i class="fas fa-map-marked-alt w-5 h-5"></i>
            <span>My Fields</span>
          </a>

          <!-- My Tasks -->
          <a href="#"
            class="nav-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors text-lg"
            data-section="my-tasks">
            <i class="fas fa-clipboard-check w-5 h-5"></i>
            <span>My Tasks</span>
          </a>

          <!-- Transport/Rentals -->
          <a href="#"
            class="nav-item flex items-center space-x-3 px-4 py-3 text-gray-300 hover:bg-gray-700 hover:text-white rounded-lg transition-colors text-lg"
            data-section="transport">
            <i class="fas fa-truck-fast w-5 h-5"></i>
            <span>Transport</span>
          </a>
        </nav>
      </div>
    </aside>

    <!-- Main Content Area -->
    <main id="mainContent" class="w-full px-4 py-8 lg:px-8">
      <!-- Dashboard Section -->
      <div id="dashboard" class="content-section">
        <div class="-mt-2">
          <h2 class="text-3xl font-bold text-[var(--cane-950)] -mb-1">Driver Dashboard</h2>
          <div>
            <p class="text-[var(--cane-700)] text-sm -mt-1">Overview of your tasks, rentals, and transport assignments
            </p>
            <div style="height: 1px; background: var(--cane-400); margin: 0.25rem 0 1.5rem 0; opacity: 0.7;"></div>
          </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="section-card rounded-xl p-6 hover:shadow-md transition relative border-t-4 border-[#3EBE3C] cursor-pointer" data-section="my-fields">
            <div class="absolute top-3 right-3">
              <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                Live
              </span>
            </div>
            <div class="w-full">
              <div class="flex-1 min-w-0">
                <p class="text-base font-semibold text-gray-700 mb-1">Active Fields</p>
                <p class="text-4xl font-bold text-[var(--cane-900)] mb-1" id="activeFieldsCount">0</p>
                <p class="text-xs text-gray-500 font-normal">Fields currently being monitored</p>
              </div>
            </div>
          </div>

          <div class="section-card rounded-xl p-6 hover:shadow-md transition relative border-t-4 border-[#3EBE3C] cursor-pointer" data-section="my-tasks">
            <div class="absolute top-3 right-3">
              <span class="bg-gray-200 text-gray-700 text-xs font-medium px-2.5 py-0.5 rounded-full">
                All
              </span>
            </div>
            <div class="w-full">
              <div class="flex-1 min-w-0">
                <p class="text-base font-semibold text-gray-700 mb-1">Total Tasks</p>
                <p class="text-4xl font-bold text-[var(--cane-900)] mb-1" id="totalTasksCount">0</p>
                <p class="text-xs text-gray-500 font-normal">All tasks assigned to you</p>
              </div>
            </div>
          </div>

          <div class="section-card rounded-xl p-6 hover:shadow-md transition relative border-t-4 border-[#3EBE3C] cursor-pointer" data-section="my-tasks">
            <div class="absolute top-3 right-3">
              <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                Pending
              </span>
            </div>
            <div class="w-full">
              <div class="flex-1 min-w-0">
                <p class="text-base font-semibold text-gray-700 mb-1">Pending Tasks</p>
                <p class="text-4xl font-bold text-[var(--cane-900)] mb-1" id="pendingTasksCount">0</p>
                <p class="text-xs text-gray-500 font-normal">Tasks awaiting your action</p>
              </div>
            </div>
          </div>

          <div class="section-card rounded-xl p-6 hover:shadow-md transition relative border-t-4 border-[#3EBE3C] cursor-pointer" data-section="transport">
            <div class="absolute top-3 right-3">
              <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
                Requests
              </span>
            </div>
            <div class="w-full">
              <div class="flex-1 min-w-0">
                <p class="text-base font-semibold text-gray-700 mb-1">Pending Rentals</p>
                <p class="text-4xl font-bold text-[var(--cane-900)] mb-1" id="pendingRentalsCount">0</p>
                <p class="text-xs text-gray-500 font-normal">Equipment requests awaiting approval</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="section-card rounded-xl p-6 hover:shadow-md transition">
          <h3 class="text-lg font-bold text-[var(--cane-900)] mb-4 flex items-center gap-2">
            <i class="fas fa-bolt text-[var(--cane-600)]"></i>
            Recent Activity
          </h3>
          <ul id="recentActivityList" class="divide-y divide-gray-200 text-sm">
            <li class="py-3 text-center text-gray-500">
              <i class="fas fa-spinner fa-spin mr-2"></i>
              Loading recent activity...
            </li>
          </ul>
        </div>
      </div>

      <!-- My Tasks Section -->
      <div id="my-tasks" class="content-section hidden">
        <div class="section-card rounded-xl p-6 shadow-sm">
          <div class="flex flex-col gap-4 mb-6">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
              <div>
                <h2 class="text-2xl font-bold text-[var(--cane-950)]">
                  My Tasks
                </h2>
                <p class="text-[var(--cane-700)] text-sm mt-1">
                  Tasks assigned to you across all fields
                </p>
              </div>
              <button id="createWorkLogBtn" onclick="openDriverLogWorkModal()"
                class="px-6 py-3 bg-gradient-to-r from-[var(--cane-600)] to-[var(--cane-700)] hover:from-[var(--cane-700)] hover:to-[var(--cane-800)] text-white rounded-xl font-semibold transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 sm:whitespace-nowrap">
                <i class="fas fa-plus mr-2"></i>Log Work
              </button>
            </div>
          </div>

          <!-- Task Filters -->
          <div class="mb-4">
            <select id="taskFilterSelect" class="task-filter-select w-48 px-4 py-2 rounded-lg text-sm font-medium border-2 border-[var(--cane-500)] bg-white text-[var(--cane-700)] cursor-pointer appearance-none">
              <option value="all" selected>All Tasks</option>
              <option value="pending">Pending</option>
              <option value="done">Completed</option>
            </select>
          </div>

          <div id="myTasksList" class="space-y-3">
            <div class="text-center py-8">
              <i class="fas fa-spinner fa-spin text-[var(--cane-500)] text-2xl mb-3"></i>
              <p class="text-[var(--cane-600)]">Loading your tasks...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- My Fields Section -->
      <div id="my-fields" class="content-section hidden">
        <div class="section-card rounded-xl p-6 shadow-sm">
          <div class="mb-6">
            <h2 class="text-2xl font-bold text-[var(--cane-950)]">
              My Fields
            </h2>
            <p class="text-[var(--cane-700)] text-sm mt-1">
              Fields where you are actively assigned
            </p>
          </div>
          <div id="myFieldsList" class="space-y-3">
            <div class="text-center py-8">
              <i class="fas fa-spinner fa-spin text-[var(--cane-500)] text-2xl mb-3"></i>
              <p class="text-[var(--cane-600)]">Loading your fields...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Transport Section -->
      <div id="transport" class="content-section hidden">
        <div class="section-card rounded-xl p-6 shadow-sm">
          <div class="mb-6">
            <h2 class="text-2xl font-bold text-[var(--cane-950)]">
              Transport & Rentals
            </h2>
            <p class="text-[var(--cane-700)] text-sm mt-1">
              Manage your driver rental requests and transport assignments
            </p>
          </div>

          <!-- Rental Requests List -->
          <div id="rentalRequestsList" class="space-y-3">
            <div class="flex items-center justify-center py-12 text-gray-500">
              <i class="fas fa-spinner fa-spin text-3xl"></i>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Driver Dashboard JavaScript -->
  <script type="module" src="../../backend/Common/activity-logger.js"></script>
  <script type="module" src="../../backend/Common/sw-register.js"></script>
  <script type="module" src="../../backend/Driver/Driver_Dashboard.js"></script>
  <script type="module" src="../../backend/Driver/driver-ui.js"></script>
  <script type="module" src="../../backend/Driver/driver-init.js"></script>

  <script>
    // SPA-style section switcher
    function showSection(sectionId) {
      document
        .querySelectorAll(".content-section")
        .forEach((s) => s.classList.add("hidden"));
      const el = document.getElementById(sectionId);
      if (el) el.classList.remove("hidden");

      // Active nav styling
      document.querySelectorAll(".nav-item").forEach((a) => {
        a.classList.remove("text-white", "bg-gray-800");
        a.classList.add("text-gray-300");
      });
      const active = document.querySelector(
        `.nav-item[data-section="${sectionId}"]`
      );
      if (active) {
        active.classList.remove("text-gray-300");
        active.classList.add("text-white", "bg-gray-800");
      }

      // Initialize sidebar state
      function initSidebar() {
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');

        // Ensure sidebar is closed by default on mobile
        if (window.innerWidth < 1024) {
          if (sidebar) sidebar.classList.add('-translate-x-full');
          if (overlay) overlay.classList.add('hidden');
        } else {
          if (sidebar) sidebar.classList.remove('-translate-x-full');
          if (overlay) overlay.classList.add('hidden');
        }

        // Set up event listeners
        const sidebarToggleBtns = document.querySelectorAll('#hamburgerBtn, #closeSidebarBtn');
        sidebarToggleBtns.forEach(btn => {
          if (btn) {
            btn.addEventListener('click', function (e) {
              e.preventDefault();
              const isMobile = window.innerWidth < 1024;

              if (isMobile) {
                if (sidebar) sidebar.classList.toggle('-translate-x-full');
                if (overlay) overlay.classList.toggle('hidden');
              } else {
                toggleSidebarCollapse();
              }
            });
          }
        });

        // Close sidebar when clicking on nav items on mobile
        document.querySelectorAll('.nav-item').forEach(item => {
          item.addEventListener('click', function () {
            if (window.innerWidth < 1024) {
              if (sidebar) sidebar.classList.add('-translate-x-full');
              if (overlay) overlay.classList.add('hidden');
            }
          });
        });

        // Close sidebar when clicking outside on mobile
        if (overlay) {
          overlay.addEventListener('click', function () {
            if (window.innerWidth < 1024) {
              if (sidebar) sidebar.classList.add('-translate-x-full');
              overlay.classList.add('hidden');
            }
          });
        }

        // Handle window resize
        window.addEventListener('resize', handleResize);
      }

      // Initialize when DOM is loaded
      document.addEventListener('DOMContentLoaded', function () {
        initSidebar();
        handleResize();
      });

      // Close mobile sidebar if open
      const sidebar = document.getElementById("sidebar");
      const overlay = document.getElementById("sidebarOverlay");
      if (sidebar && overlay) {
        sidebar.classList.add("-translate-x-full");
        overlay.classList.add("hidden");
      }
    }

    // Handle main nav items
    document.querySelectorAll(".nav-item").forEach((a) => {
      a.addEventListener("click", (e) => {
        const section = a.getAttribute("data-section");
        if (section) {
          e.preventDefault();
          showSection(section);
        }
      });
    });

    // Handle dashboard card clicks
    document.querySelectorAll(".section-card[data-section]").forEach((card) => {
      card.addEventListener("click", () => {
        const section = card.getAttribute("data-section");
        if (section) {
          showSection(section);
        }
      });
    });

    // Hamburger menu
    const hamburgerBtn = document.getElementById("hamburgerBtn");
    if (hamburgerBtn) {
      hamburgerBtn.addEventListener("click", () => {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        if (sidebar && overlay) {
          sidebar.classList.remove("-translate-x-full");
          overlay.classList.remove("hidden");
        }
      });
    }

    // Close sidebar (mobile)
    const closeSidebarBtn = document.getElementById("closeSidebarBtn");
    if (closeSidebarBtn) {
      closeSidebarBtn.addEventListener("click", () => {
        const sidebar = document.getElementById("sidebar");
        const overlay = document.getElementById("sidebarOverlay");
        if (sidebar && overlay) {
          sidebar.classList.add("-translate-x-full");
          overlay.classList.add("hidden");
        }
      });
    }

    // Sidebar overlay click
    const sidebarOverlay = document.getElementById("sidebarOverlay");
    if (sidebarOverlay) {
      sidebarOverlay.addEventListener("click", () => {
        const sidebar = document.getElementById("sidebar");
        sidebar.classList.add("-translate-x-full");
        sidebarOverlay.classList.add("hidden");
      });
    }

    // Collapse sidebar (desktop)
    const collapseSidebarBtn = document.getElementById("collapseSidebarBtn");
    if (collapseSidebarBtn) {
      collapseSidebarBtn.addEventListener("click", () => {
        document.body.classList.toggle("sidebar-collapsed");
      });
    }

    // Task filter buttons
    document.querySelectorAll(".task-filter-btn").forEach((btn) => {
      btn.addEventListener("click", () => {
        document
          .querySelectorAll(".task-filter-btn")
          .forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        const filter = btn.getAttribute("data-filter");
        // Filter logic will be handled by driver-ui.js
        if (window.filterDriverTasks) {
          window.filterDriverTasks(filter);
        }
      });
    });
  </script>

  <script>
    // Driver rental header button: try to use shared lobby helpers if available,
    // otherwise create a simple iframe overlay fallback.
    (function () {
      function createFallbackOverlay() {
        let wrapper = document.getElementById('driverRentalModalWrapper');
        if (!wrapper) {
          wrapper = document.createElement('div');
          wrapper.id = 'driverRentalModalWrapper';
          wrapper.style.position = 'fixed';
          wrapper.style.inset = '0';
          wrapper.style.background = 'rgba(0,0,0,0.45)';
          wrapper.style.zIndex = '60';
          wrapper.style.display = 'flex';
          wrapper.style.alignItems = 'center';
          wrapper.style.justifyContent = 'center';
          wrapper.style.padding = '0 1rem'; // Add horizontal padding on mobile

          // Add responsive class for mobile
          wrapper.classList.add('driver-rental-wrapper');

          // Add responsive styles
          const style = document.createElement('style');
          style.textContent = `
              @media (max-width: 640px) {
                .driver-rental-wrapper {
                  padding: 0 1rem;
                  align-items: flex-start;
                  padding-top: 2rem;
                }
                #driverRentalFrame {
                  width: 100% !important;
                  max-width: 100%;
                  height: 90vh !important;
                  border-radius: 8px;
                }
              }
            `;
          document.head.appendChild(style);

          const frame = document.createElement('iframe');
          frame.id = 'driverRentalFrame';
          frame.src = '../Driver/Driver_Rental.html';
          frame.style.width = '980px';
          frame.style.maxWidth = '100%';
          frame.style.height = '640px';
          frame.style.border = '0';
          frame.style.borderRadius = '8px';
          frame.style.boxShadow = '0 12px 40px rgba(0,0,0,0.5)';
          frame.style.backgroundColor = 'white';
          wrapper.appendChild(frame);
          wrapper.addEventListener('click', function (e) { if (e.target === wrapper) wrapper.remove(); });
          document.body.appendChild(wrapper);
        }
        return wrapper;
      }

      function openFallback() { createFallbackOverlay(); }
      function closeFallback() { const w = document.getElementById('driverRentalModalWrapper'); if (w) w.remove(); }

      document.addEventListener('DOMContentLoaded', function () {
        // Handle both the original button and the dropdown button
        const rentalBtns = [
          document.getElementById('btnDriverRental'),
          document.getElementById('openRentalBtn')
        ].filter(btn => btn);

        if (rentalBtns.length === 0) return;

        // Show button for drivers (best-effort). If you want it always visible, remove condition.
        try {
          if (localStorage.getItem('userRole') === 'driver') {
            rentalBtns.forEach(btn => btn.classList.remove('hidden'));
          }
        } catch (_) {
          rentalBtns.forEach(btn => btn.classList.remove('hidden'));
        }

        function handleRentalClick(e) {
          e.preventDefault();
          // Close the dropdown if it's open
          const dropdown = document.getElementById('profileDropdown');
          if (dropdown) {
            dropdown.classList.remove('opacity-100', 'visible', 'scale-100');
            dropdown.classList.add('opacity-0', 'invisible', 'scale-95');
          }
          // Prefer shared helper if present
          if (window.openDriverRentalIframe && typeof window.openDriverRentalIframe === 'function') {
            try { window.openDriverRentalIframe(); return; } catch (_) { }
          }
          // Fallback overlay
          openFallback();
        }

        // Add click handlers to all rental buttons
        rentalBtns.forEach(btn => {
          btn.addEventListener('click', handleRentalClick);
        });

        // Also expose open/close for other scripts
        window.openDriverRentalModal = function () {
          if (window.openDriverRentalIframe) return window.openDriverRentalIframe();
          return openFallback();
        };
        window.closeDriverRentalModal = closeFallback;
      });
    })();
  </script>

  <!-- Custom Logout Confirmation Modal -->
  <div id="logoutModal"
    class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 opacity-0 invisible transition-opacity duration-200 ease-out z-[80]">
    <div
      class="bg-white rounded-xl shadow-2xl w-full max-w-sm border border-[var(--cane-200)] transform transition-all duration-200 ease-out translate-y-2 scale-95 opacity-0 pointer-events-none"
      id="logoutDialog" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <div class="px-5 pt-5 pb-3">
        <h3 id="logoutTitle" class="text-lg font-bold text-[var(--cane-950)]">Confirm Logout</h3>
        <p class="mt-2 text-[var(--cane-900)]/90 text-sm">Are you sure you want to log out?</p>
      </div>
      <div class="px-5 pb-5 flex justify-end gap-2">
        <button id="logoutCancel"
          class="px-4 py-2 rounded-lg border border-[var(--cane-300)] text-[var(--cane-900)] bg-white hover:bg-[var(--cane-50)]">No</button>
        <button id="logoutConfirm" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700">Yes</button>
      </div>
    </div>
  </div>
</body>

</html>
<script>
  function toggleSidebar() {
    const isDesktop = window.innerWidth >= 1024;
    if (isDesktop) {
      // On desktop, toggle collapse state (icon-only mode)
      toggleSidebarCollapse();
    } else {
      // On mobile, toggle sidebar visibility
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar && overlay) {
        const isHidden = sidebar.classList.contains('-translate-x-full');
        if (isHidden) {
          sidebar.classList.remove('-translate-x-full');
          overlay.classList.remove('hidden');
        } else {
          sidebar.classList.add('-translate-x-full');
          overlay.classList.add('hidden');
        }
      }
    }
  }

  function toggleSidebarCollapse() {
    const body = document.body;
    const mainWrapper = document.getElementById('driverMainWrapper');
    const header = document.getElementById('driverHeaderContainer');
    const sidebar = document.getElementById('sidebar');
    if (!mainWrapper || !sidebar) return;

    const isDesktop = window.innerWidth >= 1024;
    if (!isDesktop) return; // Only allow collapse on desktop

    body.classList.toggle('sidebar-collapsed');
    const isCollapsed = body.classList.contains('sidebar-collapsed');

    // Update margins and padding
    mainWrapper.style.marginLeft = isCollapsed ? '5rem' : '16rem';
    if (header) header.style.paddingLeft = isCollapsed ? '5rem' : '16rem';
  }

  (function () {
    const closeBtn = document.getElementById('closeSidebarBtn');
    const overlay = document.getElementById('sidebarOverlay');
    const collapseBtn = document.getElementById('collapseSidebarBtn');

    if (closeBtn) closeBtn.addEventListener('click', function () {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.add('-translate-x-full');
      if (overlay) overlay.classList.add('hidden');
    });

    if (overlay) overlay.addEventListener('click', function () {
      const sidebar = document.getElementById('sidebar');
      if (sidebar) sidebar.classList.add('-translate-x-full');
      overlay.classList.add('hidden');
    });

    if (collapseBtn) {
      collapseBtn.addEventListener('click', function (e) {
        e.preventDefault();
        toggleSidebarCollapse();
      });
    }

    // Toggle notification dropdown
    document.addEventListener('click', function (e) {
      const notificationBtn = document.getElementById('notificationBtn');
      const notificationDropdown = document.getElementById('notificationDropdown');
      const isMobile = window.innerWidth < 1024;

      if (e.target === notificationBtn || notificationBtn.contains(e.target)) {
        e.preventDefault();
        e.stopPropagation();

        // Toggle dropdown
        const isHidden = notificationDropdown.classList.toggle('hidden');

        if (!isHidden) {
          if (isMobile) {
            // Position dropdown below the header on mobile
            const header = document.querySelector('header');
            const headerRect = header.getBoundingClientRect();
            notificationDropdown.style.position = 'fixed';
            notificationDropdown.style.top = `${headerRect.bottom + window.scrollY + 5}px`;
            notificationDropdown.style.left = '1rem';
            notificationDropdown.style.right = '1rem';
            notificationDropdown.style.maxWidth = 'calc(100% - 2rem)';
            notificationDropdown.style.width = 'auto';
          } else {
            // Desktop: position relative to button
            const btnRect = notificationBtn.getBoundingClientRect();
            notificationDropdown.style.position = 'absolute';
            notificationDropdown.style.top = `${btnRect.bottom + 8}px`;
            notificationDropdown.style.right = '0';
            notificationDropdown.style.left = 'auto';
            notificationDropdown.style.maxWidth = 'none';
            notificationDropdown.style.width = '20rem';
          }
        }

        // Close other dropdowns
        document.querySelectorAll('[id$="Dropdown"]').forEach(dropdown => {
          if (dropdown !== notificationDropdown && !dropdown.classList.contains('hidden')) {
            dropdown.classList.add('hidden');
          }
        });
      } else if (!notificationDropdown.contains(e.target)) {
        notificationDropdown.classList.add('hidden');
      }
    });

    // Close dropdown when scrolling on mobile
    window.addEventListener('scroll', function () {
      if (window.innerWidth < 1024) {
        const notificationDropdown = document.getElementById('notificationDropdown');
        if (!notificationDropdown.classList.contains('hidden')) {
          notificationDropdown.classList.add('hidden');
        }
      }
    }, { passive: true });

    window.addEventListener('resize', function () {
      const mainWrapper = document.getElementById('driverMainWrapper');
      const header = document.getElementById('driverHeaderContainer');
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      const isDesktop = window.innerWidth >= 1024;

      if (isDesktop) {
        // On desktop, ensure sidebar is visible and respect collapsed state
        if (sidebar) sidebar.classList.remove('-translate-x-full');
        if (overlay) overlay.classList.add('hidden');

        const isCollapsed = document.body.classList.contains('sidebar-collapsed');
        if (mainWrapper) mainWrapper.style.marginLeft = isCollapsed ? '5rem' : '16rem';
        if (header) header.style.paddingLeft = isCollapsed ? '5rem' : '16rem';
      } else {
        // On mobile, reset to default hidden state
        if (mainWrapper) mainWrapper.style.marginLeft = '0';
        if (header) header.style.paddingLeft = '0';
        // Remove collapsed class on mobile
        document.body.classList.remove('sidebar-collapsed');
      }
    });
  })();
</script>