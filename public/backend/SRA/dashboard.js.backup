console.log('üî•üî•üî• SRA DASHBOARD.JS LOADED - VERSION 3.0 WITH IMPORT LOGGING üî•üî•üî•');

import { showPopupMessage } from '../Common/ui-popup.js';
import { notifyReportApproval, notifyReportRejection } from '../Common/notifications.js';
import { renderReportsTable, showRequestReportModal } from './reports-sra.js';

// =============================
// üîî Notifications Bell (Same as Handler Dashboard)
// =============================

function formatRelativeTime(ts) {
  const date = ts && ts.toDate ? ts.toDate() : ts ? new Date(ts) : new Date();
  const diff = Math.floor((Date.now() - date.getTime()) / 1000);

  if (diff < 60) return "Just now";
  if (diff < 3600) return `${Math.floor(diff / 60)} min ago`;
  if (diff < 86400) return `${Math.floor(diff / 3600)} hr ago`;
  if (diff < 604800) return `${Math.floor(diff / 86400)} day${Math.floor(diff / 86400) > 1 ? "s" : ""} ago`;
  return date.toLocaleDateString();
}

let notificationsUnsub = null;

async function initNotifications(userId) {
  const { db } = await import('../Common/firebase-config.js');
  const { collection, query, where, orderBy, limit, onSnapshot, doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');

  const bellBtn = document.getElementById("notificationBellBtn");
  const dropdown = document.getElementById("notificationDropdown");
  const badge = document.getElementById("notificationBadge");
  const list = document.getElementById("notificationList");
  const refreshBtn = document.getElementById("notificationRefreshBtn");

  if (!bellBtn || !dropdown || !badge || !list) return;

  const closeDropdown = (event) => {
    if (!dropdown.contains(event.target) && !bellBtn.contains(event.target)) {
      dropdown.classList.add("hidden");
    }
  };

  bellBtn.addEventListener("click", (event) => {
    event.stopPropagation();
    dropdown.classList.toggle("hidden");
  });

  document.addEventListener("click", closeDropdown);
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") dropdown.classList.add("hidden");
  });

  // Helper function to format notification titles
  const getNotificationTitle = (notification) => {
    // If there's an explicit title, use it
    if (notification.title) return notification.title;

    // Otherwise, generate title from type
    const typeToTitle = {
      'report_requested': 'Report Requested',
      'report_approved': 'Report Approved',
      'report_rejected': 'Report Rejected',
      'field_approved': 'Field Registration Approved',
      'field_rejected': 'Field Registration Rejected',
      'field_registration': 'New Field Registration',
      'badge_approved': 'Driver Badge Approved',
      'badge_rejected': 'Driver Badge Rejected'
    };

    return typeToTitle[notification.type] || 'Notification';
  };

  const renderNotifications = (docs = []) => {
    // Fix: use 'read' boolean field instead of 'status' string field
    const unread = docs.filter((doc) => !doc.read);

    if (unread.length > 0) {
      badge.textContent = String(unread.length);
      badge.classList.remove("hidden");
    } else {
      badge.classList.add("hidden");
    }

    if (docs.length === 0) {
      list.innerHTML = '<div class="p-4 text-sm text-gray-500 text-center">No notifications yet.</div>';
      return;
    }

    list.innerHTML = docs
      .map((item) => {
        const title = getNotificationTitle(item);
        const message = item.message || "";
        const meta = formatRelativeTime(item.timestamp || item.createdAt);
        const isRead = item.read === true;
        const statusClass = isRead ? "bg-gray-100" : "bg-[var(--cane-50)]";
        const safeMessage = typeof message === "string" ? message : "";

        return `<button data-id="${item.id}" class="w-full text-left px-4 py-3 border-b border-gray-100 hover:bg-gray-50 focus:outline-none ${statusClass}">
          <div class="flex items-start gap-2">
            <div class="mt-1 h-2 w-2 rounded-full ${isRead ? "bg-gray-300" : "bg-[var(--cane-600)]"}"></div>
            <div class="flex-1">
              <div class="flex items-center justify-between">
                <p class="text-sm font-semibold text-[var(--cane-900)]">${title}</p>
                <span class="text-xs text-[var(--cane-600)]">${meta}</span>
              </div>
              <p class="mt-1 text-sm text-[var(--cane-700)] leading-snug">${safeMessage}</p>
            </div>
          </div>
        </button>`;
      })
      .join("");

    Array.from(list.querySelectorAll("button[data-id]"))
      .forEach(btn => {
        btn.addEventListener("click", async () => {
          const notificationId = btn.dataset.id;
          try {
            await updateDoc(doc(db, "notifications", notificationId), {
              read: true,
              readAt: serverTimestamp()
            });
            console.log(`‚úÖ Marked notification ${notificationId} as read`);
          } catch (err) {
            console.warn("Failed to update notification status", err);
          }
        });
      });
  };

  const fetchNotifications = () => {
    if (notificationsUnsub) notificationsUnsub();

    const notificationsRef = collection(db, "notifications");

    // SRA needs TWO queries: personal notifications AND broadcast notifications for role 'sra'
    let personalNotifs = [];
    let broadcastNotifs = [];

    // Query 1: Personal notifications
    const personalQuery = query(
      notificationsRef,
      where("userId", "==", userId),
      orderBy("timestamp", "desc"),
      limit(25)
    );

    // Query 2: Broadcast notifications for SRA role
    // NOTE: No orderBy to avoid requiring composite index (role + timestamp)
    // Sorting is done client-side in mergeAndRender() function below
    const broadcastQuery = query(
      notificationsRef,
      where("role", "==", "sra"),
      limit(50) // Increased limit since we filter and sort client-side
    );

    // Subscribe to personal notifications
    const unsubPersonal = onSnapshot(personalQuery, (snapshot) => {
      personalNotifs = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
      mergeAndRender();
    }, (error) => {
      console.error("Personal notifications stream failed", error);
    });

    // Subscribe to broadcast notifications
    const unsubBroadcast = onSnapshot(broadcastQuery, (snapshot) => {
      broadcastNotifs = snapshot.docs.map((docSnap) => ({ id: docSnap.id, ...docSnap.data() }));
      mergeAndRender();
    }, (error) => {
      console.error("Broadcast notifications stream failed", error);
    });

    // Merge and render function
    const mergeAndRender = () => {
      // Combine both arrays and remove duplicates by ID
      const allNotifs = [...personalNotifs, ...broadcastNotifs];
      const uniqueNotifs = Array.from(new Map(allNotifs.map(n => [n.id, n])).values());

      // Sort by timestamp (newest first)
      uniqueNotifs.sort((a, b) => {
        const ta = a.timestamp && a.timestamp.seconds ? a.timestamp.seconds : 0;
        const tb = b.timestamp && b.timestamp.seconds ? b.timestamp.seconds : 0;
        return tb - ta;
      });

      console.log(`üîî SRA notifications loaded: ${personalNotifs.length} personal + ${broadcastNotifs.length} broadcast = ${uniqueNotifs.length} total`);
      renderNotifications(uniqueNotifs.slice(0, 25)); // Limit to 25 after merging
    };

    // Store both unsubscribe functions
    notificationsUnsub = () => {
      unsubPersonal();
      unsubBroadcast();
    };
  };

  if (refreshBtn) {
    refreshBtn.addEventListener("click", (event) => {
      event.stopPropagation();
      fetchNotifications();
    });
  }

  fetchNotifications();
}

    // Global variables
        let currentSection = 'dashboard';

        // Initialize dashboard when DOM is loaded
        document.addEventListener('DOMContentLoaded', async function() {
            setupEventListeners();
            try {
                const { auth, db } = await import('../Common/firebase-config.js');
                const { onAuthStateChanged, signOut } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js');
                const { collection, collectionGroup, query, orderBy, limit, getDocs, doc, getDoc, onSnapshot, where } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        // Check if user is verified
                        if (!user.emailVerified) {
                            await showPopupMessage('Please verify your email before accessing the SRA dashboard.', 'warning');
                            window.location.href = '../Common/farmers_login.html';
                            return;
                        }
                        
                        // Check user role in Firestore
                        const userRef = doc(db, 'users', user.uid);
                        const userSnap = await getDoc(userRef);
                        const userRole = userSnap.exists() ? userSnap.data().role : 'farmer';
                        
                        if (userRole !== 'sra') {
                            await showPopupMessage('Access denied. This dashboard is only for SRA Officers.', 'error');
                            window.location.href = '../Common/lobby.html';
                            return;
                        }
                        
                        const display = user.displayName || user.email || 'SRA Officer';
                        const headerName = document.getElementById('headerUserName');
                        const sideName = document.getElementById('sidebarUserName');
                        if (headerName) headerName.textContent = display;
                        if (sideName) sideName.textContent = display;
                        
                    //Recent Field Applications loader with REAL-TIME updates
                        try {
                        const list = document.getElementById("recentAppsList");
                        if (list) {
                            list.innerHTML = `<p class="text-gray-500 text-sm italic">Loading recent field applications...</p>`;

                            // import Firestore helpers (we re-import same helpers so this block is self-contained)
                            const { collection, collectionGroup, getDocs, onSnapshot, query, orderBy, doc, getDoc } =
                            await import("https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js");

                            // helper to resolve applicant name from uid if needed
                            const userCache = {};

                            // normalize function (lightweight; keep fields consistent)
                            function normalizeDoc(d, isNested = false) {
                            const data = d.data();
                            const status = data.status || "pending";
                            let applicantName = data.applicantName || data.requestedBy || data.userId || "‚Äî";

                            // resolve applicant UID -> display name if needed
                            async function resolveApplicant(uid) {
                                if (!uid) return uid;
                                if (userCache[uid]) return userCache[uid];
                                try {
                                const uSnap = await getDoc(doc(db, "users", uid));
                                if (uSnap.exists()) {
                                    const u = uSnap.data();
                                    const display = u.name || u.fullName || u.displayName || u.email || uid;
                                    userCache[uid] = display;
                                    return display;
                                }
                                } catch (err) {
                                console.warn("User lookup failed for", uid, err);
                                }
                                return uid;
                            }

                            return {
                                id: d.id,
                                path: d.ref?.path || null,
                                raw: data,
                                status,
                                barangay: data.barangay || data.location || "‚Äî",
                                fieldName: data.field_name || data.fieldName || data.title || '‚Äî',
                                street: data.street || data.sitio || '‚Äî',
                                createdAt: (data.submittedAt && data.submittedAt.toDate) ? data.submittedAt.toDate() : (data.createdAt && data.createdAt.toDate ? data.createdAt.toDate() : new Date()),
                                // applicantName may be uid ‚Äî resolve below
                                _applicantCandidate: applicantName,
                                isNested
                            };
                            }

                            // üî• Set up REAL-TIME listener using onSnapshot for top-level fields collection
                            try {
                                const fieldsQuery = query(collection(db, "fields"), orderBy("createdAt", "desc"));
                                onSnapshot(fieldsQuery, async (fieldsSnap) => {
                                    console.log('üîÑ Recent Apps: Real-time update triggered');
                                    const fieldApps = fieldsSnap.docs.map(d => normalizeDoc(d, false));

                                    // Resolve applicant names
                                    const all = fieldApps;
                                    for (const a of all) {
                                        const cand = a._applicantCandidate;
                                        if (cand && typeof cand === 'string' && cand.length < 40 && !cand.includes(' ')) {
                                            const resolved = await (async () => {
                                                if (userCache[cand]) return userCache[cand];
                                                try {
                                                    const uSnap = await getDoc(doc(db, "users", cand));
                                                    if (uSnap.exists()) {
                                                        const u = uSnap.data();
                                                        const display = u.name || u.fullName || u.displayName || u.email || cand;
                                                        userCache[cand] = display;
                                                        return display;
                                                    }
                                                } catch (err) {
                                                    return cand;
                                                }
                                                return cand;
                                            })();
                                            a.applicantName = resolved || cand;
                                        } else {
                                            a.applicantName = cand || '‚Äî';
                                        }
                                    }

                                    // ‚úÖ All fields from top-level collection (no filtering needed)
                                    // Deduplicate by userId + field details
                                    const byKey = {};
                                    for (const a of all) {
                                        const userId = a.raw.userId || a.raw.requestedBy || 'unknown';
                                        const key = `${userId}|${a.fieldName}|${a.barangay}|${a.street}`.toLowerCase();
                                        if (!byKey[key] || new Date(a.createdAt) > new Date(byKey[key].createdAt)) {
                                            byKey[key] = a;
                                        }
                                    }
                                    const applications = Object.values(byKey);
                                    applications.sort((x, y) => new Date(y.createdAt) - new Date(x.createdAt));

                                    // Render
                                    list.innerHTML = "";
                                    const visible = applications.slice(0, 3);
                                    for (const app of visible) {
                                        const card = document.createElement("div");
                                        card.className = "flex justify-between items-center bg-white border border-gray-200 rounded-lg p-3 mb-2 shadow-sm hover:shadow-md transition cursor-pointer";
                                        const displayCreated = formatFullDate(app.createdAt || app.raw?.updatedAt || app.raw?.statusUpdatedAt);
                                        card.innerHTML = `
                                        <div>
                                            <p class="font-semibold text-[var(--cane-900)]">${app.applicantName}</p>
                                            <p class="text-sm text-[var(--cane-700)]">
                                            ${app.fieldName ? app.fieldName + ' ¬∑ ' : ''}Brgy. ${app.barangay}${app.street ? ' ¬∑ ' + app.street : ''}
                                            </p>
                                            <p class="text-xs text-green-600 font-medium mt-0.5">${displayCreated}</p>
                                        </div>
                                        <span class="text-xs font-medium px-2 py-1 rounded-full ${
                                            app.status === "reviewed" ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-700"
                                        }">${app.status}</span>
                                        `;
                                        card.addEventListener('click', async (e) => {
                                            e.stopPropagation();
                                            try {
                                                const container = document.getElementById('fieldDocsContainer');
                                                if (container && container.childElementCount === 0) {
                                                    const cacheBust = `?v=${Date.now()}`;
                                                    const html = await fetch(`SRA_FieldDocuments.html${cacheBust}`).then(r => r.text());
                                                    container.innerHTML = html;
                                                }
                                                const mod = await import(`./Review.js${cacheBust}`);
                                                if (mod && mod.SRAReview && typeof mod.SRAReview.init === 'function') {
                                                    mod.SRAReview.init();
                                                }
                                                showSection('field-documents');
                                            } catch (_) {}
                                        });
                                        list.appendChild(card);
                                    }
                                }, (error) => {
                                    console.error("Recent apps real-time listener failed:", error);
                                    if (list) list.innerHTML = `<p class="text-red-500 text-sm">Failed to load recent field applications.</p>`;
                                });
                            } catch (err) {
                                console.error("Recent apps setup failed:", err);
                                if (list) list.innerHTML = `<p class="text-red-500 text-sm">Failed to load recent field applications.</p>`;
                            }
                        }
                        } catch (err) {
                        console.error("Recent apps unified loader failed:", err);
                        const list = document.getElementById("recentAppsList");
                        if (list) list.innerHTML = `<p class="text-red-500 text-sm">Failed to load recent field applications.</p>`;
                        }


                                                // Live metrics listeners
                                                try {
                                                    const { collection, collectionGroup, query, where, onSnapshot } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
                                                    // Elements
                                                    const elTotal = document.getElementById('metricTotalSubmissions');
                                                    const elPending = document.getElementById('metricPendingReview');
                                                    const elReviewedToday = document.getElementById('metricReviewedToday');
                                                    const elActiveFields = document.getElementById('metricActiveFields');

                            // ‚úÖ Total Submissions - count from top-level fields collection
                            function recomputeTotals(fieldsSnap){
                                const allDocs = fieldsSnap.docs;

                                if (elTotal) elTotal.textContent = String(allDocs.length);
                                if (elPending) {
                                    let pendingCount = 0;
                                    allDocs.forEach(d => {
                                        const data = d.data();
                                        const s = (data.status == null) ? 'pending' : String(data.status).toLowerCase();
                                        if (s === 'pending') pendingCount += 1;
                                    });
                                    elPending.textContent = String(pendingCount);
                                }
                                console.log(`üìä Dashboard Metrics: ${allDocs.length} total submissions, ${elPending ? elPending.textContent : '?'} pending`);
                            }

                            // ‚úÖ Listen to top-level fields collection
                            onSnapshot(collection(db, 'fields'), (snap) => { recomputeTotals(snap); });

                            // ‚úÖ Reviewed Today: status==='reviewed' with statusUpdatedAt today
                            function computeReviewedToday(docs){
                                const today = new Date();
                                const y = today.getFullYear(), m = today.getMonth(), d = today.getDate();
                                const start = new Date(y, m, d, 0, 0, 0, 0);
                                const end = new Date(y, m, d, 23, 59, 59, 999);
                                let count = 0;
                                docs.forEach(docu => {
                                    const data = docu.data();
                                    const ts = data.statusUpdatedAt || data.reviewedAt || data.submittedAt || data.createdAt;
                                    const t = ts && ts.seconds ? new Date(ts.seconds * 1000) : (ts ? new Date(ts) : null);
                                    if (t && t >= start && t <= end) count += 1;
                                });
                                return count;
                            }

                            // ‚úÖ Listen to reviewed fields from top-level collection
                            onSnapshot(query(collection(db, 'fields'), where('status', '==', 'reviewed')), (snap) => {
                                if (elReviewedToday) elReviewedToday.textContent = String(computeReviewedToday(snap.docs));
                            });

                            // Active Fields: count reviewed, active, and harvested fields from top-level 'fields' collection
                            onSnapshot(query(collection(db, 'fields'), where('status', 'in', ['reviewed', 'active', 'harvested'])), (snap) => {
                                if (elActiveFields) {
                                    elActiveFields.textContent = String(snap.size);
                                    console.log(`üìä Active Fields: ${snap.size} (reviewed, active, and harvested)`);
                                }
                            });
                        } catch(_) {}

                        // --- START: SRA map block (replace existing block) ---
                        try {
                            const mapContainer = document.getElementById('sraFieldsMap');
                            if (mapContainer) {

                                // ---------- Utility: safely pick first existing key ----------
                                function pickFirst(obj, keys = []) {
                                    for (const k of keys) {
                                        if (obj && Object.prototype.hasOwnProperty.call(obj, k) && obj[k] != null && obj[k] !== '') {
                                            return obj[k];
                                        }
                                    }
                                    return null;
                                }

                                // ---------- Process snapshot into field objects ----------
                                async function processFieldsSnapshot(snap) {
                                    if (snap.empty) {
                                        console.warn('‚ö†Ô∏è No reviewed fields found.');
                                        return [];
                                    }

                                    const fields = snap.docs.map(d => {
                                            const data = d.data();
                                            const lat = pickFirst(data, ['lat', 'latitude']);
                                            const lng = pickFirst(data, ['lng', 'longitude']);
                                            return {
                                                id: d.id,
                                                path: d.ref.path,
                                                raw: data,
                                                lat: typeof lat === 'string' ? parseFloat(lat) : lat,
                                                lng: typeof lng === 'string' ? parseFloat(lng) : lng,
                                                barangay: pickFirst(data, ['barangay', 'location']) || '‚Äî',
                                                fieldName: pickFirst(data, ['field_name', 'fieldName']) || '‚Äî',
                                                street: pickFirst(data, ['street', 'sitio']) || '‚Äî',
                                                size: pickFirst(data, ['field_size', 'size', 'fieldSize']) || '‚Äî',
                                                terrain: pickFirst(data, ['terrain_type', 'terrain']) || '‚Äî',
                                                applicantName: pickFirst(data, ['applicantName', 'requestedBy', 'userId', 'requester']) || '‚Äî',
                                                status: pickFirst(data, ['status']) || 'pending'
                                            };
                                        });

                                        // Enrich applicantName using the UID from path if necessary
                                        const userCache = {};
                                        for (const f of fields) {
                                            const pathParts = f.path.split('/');
                                            const uidFromPath = pathParts.length >= 2 ? pathParts[1] : null;
                                            let possibleUid = null;

                                            if (f.applicantName && f.applicantName.length < 25 && !f.applicantName.includes(' ')) {
                                                possibleUid = f.applicantName;
                                            } else if (uidFromPath) {
                                                possibleUid = uidFromPath;
                                            }

                                            if (possibleUid) {
                                                if (userCache[possibleUid]) {
                                                    f.applicantName = userCache[possibleUid];
                                                    continue;
                                                }
                                                try {
                                                    const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
                                                    const userSnap = await getDoc(doc(db, 'users', possibleUid));
                                                    if (userSnap.exists()) {
                                                        const u = userSnap.data();
                                                        const displayName = u.name || u.fullName || u.displayName || u.email || possibleUid;
                                                        f.applicantName = displayName;
                                                        userCache[possibleUid] = displayName;
                                                    }
                                                } catch (err) {
                                                    console.warn('User lookup failed for', possibleUid, err);
                                                }
                                            }
                                        }

                                        console.info(`‚úÖ Processed ${fields.length} reviewed fields`);
                                        return fields;
                                }

                                // ---------- Show reviewed fields on map with REAL-TIME updates ----------
                                let currentMarkerGroup = null; // Store marker group to clear on updates

                                async function renderFieldsOnMap(map, fields) {
                                    try {
                                        const caneIcon = L.icon({
                                            iconUrl: '../../frontend/img/PIN.png',
                                            iconSize: [32, 32],
                                            iconAnchor: [16, 30],
                                            popupAnchor: [0, -28]
                                        });

                                        // Clear existing markers
                                        if (currentMarkerGroup) {
                                            map.removeLayer(currentMarkerGroup);
                                        }

                                        // Create new marker group
                                        currentMarkerGroup = L.layerGroup().addTo(map);

                                        if (!Array.isArray(fields) || fields.length === 0) {
                                            console.warn('‚ö†Ô∏è No reviewed fields to display.');
                                            window.__caneMarkers = [];
                                            return;
                                        }

                                        window.__caneMarkers = []; // store markers for searching later

                                        fields.forEach(f => {
                                            if (!f.lat || !f.lng) return;

                                            const marker = L.marker([f.lat, f.lng], { icon: caneIcon }).addTo(currentMarkerGroup);

                                            const tooltipHtml = `
                                            <div style="font-size:12px; line-height:1.4; max-width:250px; color:#14532d;">
                                                <b style="font-size:14px; color:#166534;">${f.fieldName}</b>
                                                <br><span style="font-size:10px; color:#15803d;">üè†Ô∏é <i>${f.street}, Brgy. ${f.barangay},<br>Ormoc City, Leyte</i></span>
                                                <br><a href="#" class="seeFieldDetails" style="font-size:10px; color:gray; display:inline-block; margin-top:3px;">Click to see more details.</a>
                                            </div>
                                            `;

                                            marker.bindTooltip(tooltipHtml, {
                                                permanent: false,
                                                direction: 'top',
                                                offset: [0, -25],
                                                opacity: 0.9
                                            });

                                            marker.on('mouseover', () => marker.openTooltip());
                                            marker.on('mouseout', () => marker.closeTooltip());
                                            marker.on('click', () => openFieldDetailsModal(f));

                                            window.__caneMarkers.push({ marker, data: f });
                                        });

                                        console.info(`‚úÖ Displayed ${fields.length} reviewed field markers on map.`);
                                    } catch (err) {
                                        console.error('renderFieldsOnMap() failed:', err);
                                    }
                                }

                                // ---------- Setup REAL-TIME listener for approved fields ----------
                                async function setupRealtimeFieldsListener(map) {
                                    try {
                                        const { db } = await import('../Common/firebase-config.js');
                                        const { collection, onSnapshot, query, where } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');

                                        // Listen to reviewed, active, and harvested fields in real-time (top-level collection)
                                        const q = query(collection(db, 'fields'), where('status', 'in', ['reviewed', 'active', 'harvested']));

                                        onSnapshot(q, async (snap) => {
                                            console.log('üó∫Ô∏è Map: Real-time update triggered, processing fields...');
                                            const fields = await processFieldsSnapshot(snap);
                                            await renderFieldsOnMap(map, fields);
                                        }, (error) => {
                                            console.error('‚ùå Map real-time listener failed:', error);
                                        });

                                        console.info('‚úÖ Real-time map listener initialized');
                                    } catch (err) {
                                        console.error('setupRealtimeFieldsListener() failed:', err);
                                    }
                                }

                                // ---------- Barangays list (copy from lobby.js) ----------
                                const barangays = [
                                    { name: "Airport", coords: [11.0583, 124.5541] },
                                    { name: "Alegria", coords: [11.0130, 124.6300] },
                                    { name: "Alta Vista", coords: [11.0174, 124.6260] },
                                    { name: "Bagong", coords: [11.0230, 124.6000] },
                                    { name: "Bagong Buhay", coords: [11.0300, 124.5900] },
                                    { name: "Bantigue", coords: [11.0200, 124.5800] },
                                    { name: "Batuan", coords: [11.0100, 124.5800] },
                                    { name: "Bayog", coords: [11.0400, 124.5900] },
                                    { name: "Biliboy", coords: [11.0565, 124.5792] },
                                    { name: "Cabaon-an", coords: [11.0333, 124.5458] },
                                    { name: "Cabintan", coords: [11.1372, 124.7777] },
                                    { name: "Cabulihan", coords: [11.0094, 124.5700] },
                                    { name: "Cagbuhangin", coords: [11.0180, 124.5700] },
                                    { name: "Camp Downes", coords: [11.0300, 124.6500] },
                                    { name: "Can-adieng", coords: [11.0240, 124.5940] },
                                    { name: "Can-untog", coords: [11.0320, 124.5880] },
                                    { name: "Catmon", coords: [11.0110, 124.6000] },
                                    { name: "Cogon Combado", coords: [11.0125, 124.6035] },
                                    { name: "Concepcion", coords: [11.0140, 124.6130] },
                                    { name: "Curva", coords: [10.9940, 124.6240] },
                                    { name: "Danao", coords: [11.072680, 124.701324] },
                                    { name: "Danhug", coords: [10.961806, 124.648155] },
                                    { name: "Dayhagan", coords: [11.0090, 124.5560] },
                                    { name: "Dolores", coords: [11.073484, 124.625336] },
                                    { name: "Domonar", coords: [11.063030, 124.533590] },
                                    { name: "Don Felipe Larrazabal", coords: [11.0250, 124.6100] },
                                    { name: "Don Potenciano Larrazabal", coords: [11.0150, 124.6100] },
                                    { name: "Do√±a Feliza Z. Mejia", coords: [11.0210, 124.6080] },
                                    { name: "Don Carlos B. Rivilla Sr. (Boroc)", coords: [11.0400, 124.6050] },
                                    { name: "Donghol", coords: [11.0064, 124.6075] },
                                    { name: "East (Poblacion)", coords: [11.0110, 124.6075] },
                                    { name: "Esperanza", coords: [10.9780, 124.6210] },
                                    { name: "Gaas", coords: [11.0750, 124.7000] },
                                    { name: "Green Valley", coords: [11.0320, 124.6350] },
                                    { name: "Guintigui-an", coords: [11.0010, 124.6210] },
                                    { name: "Hibunawon", coords: [11.116922, 124.634636] },
                                    { name: "Hugpa", coords: [11.017476, 124.663765] },
                                    { name: "Ipil", coords: [11.0190, 124.6220] },
                                    { name: "Juaton", coords: [11.073599, 124.593590] },
                                    { name: "Kadaohan", coords: [11.110463, 124.573050] },
                                    { name: "Labrador", coords: [11.069711, 124.548433] },
                                    { name: "Lao", coords: [11.014082, 124.565109] },
                                    { name: "Leondoni", coords: [11.093463, 124.525435] },
                                    { name: "Libertad", coords: [11.0290, 124.5700] },
                                    { name: "Liberty", coords: [11.025092, 124.704627] },
                                    { name: "Licuma", coords: [11.039680, 124.528900] },
                                    { name: "Liloan", coords: [11.040502, 124.549866] },
                                    { name: "Linao", coords: [11.0160, 124.5900] },
                                    { name: "Luna", coords: [11.0080, 124.5800] },
                                    { name: "Mabato", coords: [11.039920, 124.535580] },
                                    { name: "Mabini", coords: [10.993786, 124.678680] },
                                    { name: "Macabug", coords: [11.0500, 124.5800] },
                                    { name: "Magaswi", coords: [11.048665, 124.612040] },
                                    { name: "Mahayag", coords: [11.0400, 124.5700] },
                                    { name: "Mahayahay", coords: [10.976500, 124.688850] },
                                    { name: "Manlilinao", coords: [11.105776, 124.499760] },
                                    { name: "Margen", coords: [11.015798, 124.529884] },
                                    { name: "Mas-in", coords: [11.062307, 124.515160] },
                                    { name: "Matica-a", coords: [11.0300, 124.5600] },
                                    { name: "Milagro", coords: [11.0250, 124.6300] },
                                    { name: "Monterico", coords: [11.119205, 124.514590] },
                                    { name: "Nasunogan", coords: [11.0100, 124.5800] },
                                    { name: "Naungan", coords: [11.0200, 124.6200] },
                                    { name: "Nueva Sociedad", coords: [11.0180, 124.6320] },
                                    { name: "Nueva Vista", coords: [11.093860, 124.619290] },
                                    { name: "Patag", coords: [11.0280, 124.5700] },
                                    { name: "Punta", coords: [11.0150, 124.5700] },
                                    { name: "Quezon Jr.", coords: [11.005818, 124.667200] },
                                    { name: "Rufina M. Tan", coords: [11.085495, 124.525894] },
                                    { name: "Sabang Bao", coords: [11.0100, 124.6400] },
                                    { name: "Salvacion", coords: [11.059892, 124.583080] },
                                    { name: "San Antonio", coords: [10.966187, 124.647060] },
                                    { name: "San Isidro", coords: [11.022854, 124.585710] },
                                    { name: "San Jose", coords: [11.0064, 124.6075] },
                                    { name: "San Juan", coords: [11.0090, 124.6070] },
                                    { name: "San Pablo", coords: [11.047495, 124.606026] },
                                    { name: "San Vicente", coords: [11.0120, 124.6100] },
                                    { name: "Santo Ni√±o", coords: [11.0140, 124.6050] },
                                    { name: "South (Poblacion)", coords: [11.0000, 124.6075] },
                                    { name: "Sumangga", coords: [10.9900, 124.5600] },
                                    { name: "Tambulilid", coords: [11.0470, 124.5960] },
                                    { name: "Tongonan", coords: [11.1240, 124.7810] },
                                    { name: "Valencia", coords: [11.0140, 124.6250] },
                                    { name: "West (Poblacion)", coords: [11.0064, 124.6000] },
                                    // placeholder barangays (if needed)
                                    { name: "Barangay 1", coords: [null, null] },
                                    { name: "Barangay 2", coords: [null, null] },
                                    // ... keep rest if you want them listed
                                ];

                                // ---------- Field Details Modal (same as lobby but Join hidden for SRA) ----------
                                function openFieldDetailsModal(field) {
                                    const old = document.getElementById('fieldDetailsModal');
                                    if (old) old.remove();

                                    const modal = document.createElement('div');
                                    modal.id = 'fieldDetailsModal';
                                    modal.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-[9999]';

                                    modal.innerHTML = `
                                        <div class="bg-white rounded-xl p-5 w-[90%] max-w-sm relative text-[var(--cane-900)] border border-[var(--cane-200)] shadow-md">
                                            <button id="closeFieldModal" class="absolute top-3 right-4 text-gray-500 hover:text-gray-700 text-xl font-bold transition">&times;</button>

                                            <div class="flex items-center justify-center mb-3">
                                                <div class="w-11 h-11 bg-[var(--cane-100)] text-[var(--cane-700)] rounded-full flex items-center justify-center border border-[var(--cane-200)]">
                                                    <i class="fas fa-map-marker-alt text-lg"></i>
                                                </div>
                                            </div>

                                            <h2 class="text-lg font-bold text-center text-[var(--cane-900)] mb-2">${field.fieldName}</h2>

                                            <p class="text-sm text-center mb-3 text-[var(--cane-700)]">
                                                <span class="font-semibold">Owner:</span> ${field.applicantName}
                                            </p>

                                            <div class="text-[13px] text-[var(--cane-800)] bg-[var(--cane-50)] p-3 rounded-md border border-[var(--cane-200)] leading-relaxed mb-2 text-center">
                                                üè†Ô∏é ${field.street}, Brgy. ${field.barangay}, Ormoc City, Leyte
                                            </div>

                                            <div class="text-[11px] text-[var(--cane-600)] italic text-center mb-4">
                                                ‚üü Lat: ${Number(field.lat).toFixed(5)} | Lng: ${Number(field.lng).toFixed(5)}
                                            </div>

                                            <button id="joinBtn" class="w-full py-2.5 rounded-md bg-[var(--cane-700)] text-white font-semibold hover:bg-[var(--cane-800)] transition">
                                                Join Field
                                            </button>
                                        </div>
                                    `;
                                    document.body.appendChild(modal);
                                    document.getElementById('closeFieldModal').onclick = () => modal.remove();

                                    const joinBtn = document.getElementById('joinBtn');
                                    const userRole = (localStorage.getItem('userRole') || '').toLowerCase();

                                    // Hide Join button for SRA
                                    if (userRole === 'sra') {
                                        if (joinBtn) joinBtn.style.display = 'none';
                                        return;
                                    }

                                    // For other roles, keep lobby behaviour (if you want the Join flow here, implement openJoinModal)
                                    if (joinBtn) {
                                        joinBtn.onclick = () => {
                                            // if you want the join modal on SRA dashboard for non-SRA roles, call openJoinModal(field)
                                            openJoinModal && openJoinModal(field);
                                        };
                                    }
                                }

                                // ---------- Initialize Leaflet map and wire search (same UX as lobby) ----------
                                // Load Leaflet if missing
                                async function ensureLeaflet() {
                                    if (window.L) return;
                                    const css = document.createElement('link');
                                    css.rel = 'stylesheet';
                                    css.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                                    document.head.appendChild(css);
                                    await new Promise((res, rej) => {
                                        const s = document.createElement('script');
                                        s.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                                        s.onload = res;
                                        s.onerror = rej;
                                        document.body.appendChild(s);
                                    });
                                }

                                (async () => {
                                    await ensureLeaflet();

                                    const map = L.map(mapContainer, {
                                        zoomControl: true,
                                        scrollWheelZoom: false,
                                    }).setView([11.0064, 124.6075], 12);

                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        attribution: '¬© OpenStreetMap contributors',
                                    }).addTo(map);

                                    const bounds = L.latLngBounds(L.latLng(10.85, 124.45), L.latLng(11.20, 124.80));
                                    map.setMaxBounds(bounds);
                                    map.on('drag', () => map.panInsideBounds(bounds, { animate: true }));

                                    // üî• Setup REAL-TIME listener for reviewed field pins
                                    setupRealtimeFieldsListener(map);

                                    // unified search (uses same input/button IDs used in other pages)
                                    const input = document.getElementById('mapSearchInput');
                                    const btn = document.getElementById('mapSearchBtn');

                                    function showToast(msg, color = 'green') {
                                        let container = document.getElementById('toastContainer');
                                        if (!container) {
                                            container = document.createElement('div');
                                            container.id = 'toastContainer';
                                            Object.assign(container.style, {
                                                position: 'fixed',
                                                top: '20px',
                                                right: '20px',
                                                display: 'flex',
                                                flexDirection: 'column',
                                                gap: '10px',
                                                zIndex: 99999
                                            });
                                            document.body.appendChild(container);
                                        }
                                        const toast = document.createElement('div');
                                        toast.innerHTML = msg;
                                        Object.assign(toast.style, {
                                            background: color === 'green' ? '#166534' : (color === 'gray' ? '#6b7280' : '#b91c1c'),
                                            color: 'white',
                                            padding: '12px 18px',
                                            borderRadius: '8px',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                            boxShadow: '0 2px 10px rgba(0,0,0,0.3)',
                                            opacity: '0',
                                            transform: 'translateY(-10px)',
                                            transition: 'opacity 0.3s ease, transform 0.3s ease'
                                        });
                                        container.appendChild(toast);
                                        setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; }, 50);
                                        setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
                                    }

                                    const searchHandler = () => {
                                        const val = (input && input.value ? input.value.trim().toLowerCase() : '');
                                        if (!val) {
                                            map.setView([11.0064, 124.6075], 12);
                                            if (window.__caneMarkers && window.__caneMarkers.length) {
                                                window.__caneMarkers.forEach(({ marker }) => marker.addTo(map));
                                            }
                                            showToast('üîÑ Map reset to default view.', 'gray');
                                            return;
                                        }

                                        // 1) try field match in window.__caneMarkers
                                        const matchedFields = (window.__caneMarkers || []).filter(m => {
                                            const d = m.data;
                                            return (
                                                (d.fieldName && d.fieldName.toLowerCase().includes(val)) ||
                                                (d.barangay && d.barangay.toLowerCase().includes(val)) ||
                                                (d.street && d.street.toLowerCase().includes(val)) ||
                                                (String(d.lat).toLowerCase().includes(val)) ||
                                                (String(d.lng).toLowerCase().includes(val))
                                            );
                                        });

                                        if (matchedFields.length > 0) {
                                            const { marker, data } = matchedFields[0];
                                            map.setView([data.lat, data.lng], 15);
                                            marker.openTooltip();
                                            // small bounce (if icon DOM exists)
                                            try { marker._icon.classList.add('leaflet-marker-bounce'); setTimeout(() => marker._icon.classList.remove('leaflet-marker-bounce'), 1200); } catch(_) {}
                                            showToast(`üìç Found: ${data.fieldName} (${data.barangay})`, 'green');
                                            return;
                                        }

                                        // 2) try barangays fallback
                                        const brgyMatch = barangays.find(b => b.name.toLowerCase().includes(val));
                                        if (brgyMatch && brgyMatch.coords[0] && brgyMatch.coords[1]) {
                                            const caneIcon = L.icon({
                                                iconUrl: '../../frontend/img/PIN.png',
                                                iconSize: [36, 36],
                                                iconAnchor: [18, 34],
                                                popupAnchor: [0, -28]
                                            });
                                            map.setView(brgyMatch.coords, 14);
                                            L.marker(brgyMatch.coords, { icon: caneIcon })
                                                .addTo(map)
                                                .bindPopup(`<b>${brgyMatch.name}</b>`)
                                                .openPopup();

                                            showToast(`üìç Barangay: ${brgyMatch.name}`, 'green');
                                            return;
                                        }

                                        showToast('‚ùå No matching field or barangay found.', 'gray');
                                    };

                                    if (btn) {
                                        btn.addEventListener('click', (e) => { e.preventDefault(); searchHandler(); });
                                    }
                                    if (input) {
                                        input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); searchHandler(); }});
                                    }

                                    window.map = map;
                                })();
                            }
                        } catch (err) {
                            console.error('SRA Field Map initialization failed:', err);
                        }


                        // Initialize notifications bell (same as handler dashboard)
                        initNotifications(user.uid);

                        // OLD NOTIFICATIONS CODE - NOW USING BELL
                        /*
                        // Live notifications (for SRA officer)
                        try {
                            const nList = document.getElementById('notificationsList');
                            const badge = document.getElementById('notificationsBadge');
                            const bellList = document.getElementById('bellPopupList');
                            const notifContainer = document.getElementById('notifList');
                            const notifSearch = document.getElementById('notifSearch');
                            const notifSort = document.getElementById('notifSort');
                            if (nList && badge) {
                                nList.innerHTML = '<div class="text-sm text-[var(--cane-700)] p-4">Loading notifications‚Ä¶</div>';
                                const notiRef = collection(db, 'notifications');
                                const { onSnapshot, where } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
                                const currentUserId = user.uid;

                                // Merge notifications from TWO sources:
                                // 1. Personal notifications (userId)
                                // 2. Broadcast notifications (role: 'sra')
                                let personalNotifs = [];
                                let broadcastNotifs = [];

                                // Query 1: Personal notifications
                                const personalQuery = query(notiRef, where('userId', '==', currentUserId), orderBy('timestamp', 'desc'), limit(50));

                                // Query 2: Broadcast notifications for SRA role
                                const broadcastQuery = query(notiRef, where('role', '==', 'sra'), orderBy('timestamp', 'desc'), limit(50));

                                // Function to merge and render all notifications
                                const mergeAndRender = () => {
                                    // Merge both arrays and remove duplicates by ID
                                    const allNotifs = [...personalNotifs, ...broadcastNotifs];
                                    const uniqueNotifs = Array.from(new Map(allNotifs.map(n => [n.id, n])).values());

                                    // Sort by timestamp (newest first)
                                    uniqueNotifs.sort((a, b) => {
                                        const ta = a.timestamp && a.timestamp.seconds ? a.timestamp.seconds : 0;
                                        const tb = b.timestamp && b.timestamp.seconds ? b.timestamp.seconds : 0;
                                        return tb - ta;
                                    });

                                    renderAllNotifications(uniqueNotifs);
                                };

                                // Subscribe to personal notifications
                                onSnapshot(personalQuery, (nsnap) => {
                                    personalNotifs = nsnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                    console.log(`‚úÖ SRA Personal Notifications: ${personalNotifs.length}`);
                                    mergeAndRender();
                                });

                                // Subscribe to broadcast notifications
                                onSnapshot(broadcastQuery, (nsnap) => {
                                    broadcastNotifs = nsnap.docs.map(d => ({ id: d.id, ...d.data() }));
                                    console.log(`‚úÖ SRA Broadcast Notifications: ${broadcastNotifs.length}`);
                                    mergeAndRender();
                                });

                                // Render function that handles merged notifications
                                const renderAllNotifications = (docs) => {
                                    const unreadCount = docs.filter(d => !d.read && d.status !== 'read').length;
                                    badge.textContent = String(unreadCount);
                                    console.log(`‚úÖ SRA Notifications Merged Results:`);
                                    console.log(`   - Total notifications: ${docs.length}`);
                                    console.log(`   - Unread notifications: ${unreadCount}`);
                                    if (docs.length > 0) {
                                        console.log(`   - Sample notification:`, docs[0]);
                                    }
                                    if (docs.length === 0) {
                                        nList.innerHTML = '<div class="text-sm text-[var(--cane-700)] p-4 text-center">No notifications</div>';
                                        if (bellList) bellList.innerHTML = '<div class="text-sm text-[var(--cane-700)] p-3">No notifications</div>';
                                        if (notifContainer) notifContainer.innerHTML = '<div class="text-sm text-[var(--cane-700)] p-4 text-center">No notifications</div>';
                                        return;
                                    }
                                    nList.innerHTML = '';
                                    if (bellList) bellList.innerHTML = '';
                                    docs.slice(0, 8).forEach(n => {
                                        const isRead = n.read === true || n.status === 'read';
                                        const row = document.createElement('div');
                                        row.className = 'flex items-start space-x-3';
                                        row.innerHTML = `<div class="w-2 h-2 ${isRead ? 'bg-gray-400' : 'bg-[var(--cane-500)]'} rounded-full mt-2"></div>`+
                                            '<div><p class="text-sm font-medium text-[var(--cane-800)]">'+(n.title||n.message||'Notification')+'</p>'+
                                            '<p class="text-xs text-[var(--cane-600)]">'+formatRelativeTime(n.timestamp)+'</p></div>';
                                        nList.appendChild(row);
                                    });
                                    // Bell popup items
                                    docs.slice(0, 6).forEach(n => {
                                        if (!bellList) return;
                                        const isRead = n.read === true || n.status === 'read';
                                        const row = document.createElement('a');
                                        row.href = '#';
                                        row.className = `block px-4 py-2 hover:bg-[var(--cane-50)] ${isRead ? 'opacity-60' : ''}`;
                                        row.innerHTML = '<div class="text-sm font-medium text-[var(--cane-800)]">'+(n.title||n.message||'Notification')+'</div>'+
                                            '<div class="text-xs text-[var(--cane-600)]">'+(n.type||'info')+' ¬∑ '+formatRelativeTime(n.timestamp)+'</div>';
                                        row.addEventListener('click', async (e)=>{
                                            e.preventDefault();
                                            // Mark as read
                                            if (!isRead) {
                                                try {
                                                    const { updateDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
                                                    await updateDoc(doc(db, 'notifications', n.id), {
                                                        read: true,
                                                        readAt: serverTimestamp(),
                                                        status: 'read'
                                                    });
                                                } catch(err) {
                                                    console.error('Failed to mark notification as read:', err);
                                                }
                                            }
                                            showSection('notifications');
                                            const popup = document.getElementById('bellPopup'); if (popup) popup.classList.add('hidden');
                                        });
                                        bellList.appendChild(row);
                                    });

                                    // Render full notifications list with search and sort
                                    function renderNotifications() {
                                        if (!notifContainer) return;
                                        let filtered = docs.slice();
                                        const q = (notifSearch && notifSearch.value ? notifSearch.value.trim().toLowerCase() : '');
                                        if (q) {
                                            filtered = filtered.filter(n =>
                                                String(n.title||'').toLowerCase().includes(q) ||
                                                String(n.message||'').toLowerCase().includes(q) ||
                                                String(n.type||'').toLowerCase().includes(q)
                                            );
                                        }
                                        const sort = notifSort ? notifSort.value : 'newest';
                                        filtered.sort((a,b)=>{
                                            if (sort === 'oldest') {
                                                const ta = a.timestamp && a.timestamp.seconds ? a.timestamp.seconds : 0;
                                                const tb = b.timestamp && b.timestamp.seconds ? b.timestamp.seconds : 0;
                                                return ta - tb;
                                            }
                                            if (sort === 'type') {
                                                return String(a.type||'').localeCompare(String(b.type||''));
                                            }
                                            if (sort === 'title') {
                                                return String(a.title||'').localeCompare(String(b.title||''));
                                            }
                                            const ta = a.timestamp && a.timestamp.seconds ? a.timestamp.seconds : 0;
                                            const tb = b.timestamp && b.timestamp.seconds ? b.timestamp.seconds : 0;
                                            return tb - ta;
                                        });
                                        notifContainer.innerHTML = '';
                                        filtered.forEach(n => {
                                            const isRead = n.read === true || n.status === 'read';
                                            const row = document.createElement('div');
                                            row.className = `px-4 py-3 hover:bg-[var(--cane-50)] cursor-pointer ${isRead ? 'bg-gray-50' : ''}`;
                                            row.innerHTML = '<div class="flex items-start justify-between">'
                                                +'<div class="flex-1">'
                                                +'<div class="text-sm font-medium text-[var(--cane-800)]">'+(n.title||n.message||'Notification')+'</div>'
                                                +'<div class="text-xs text-[var(--cane-600)]">'+(n.type||'info')+' ¬∑ '+formatRelativeTime(n.timestamp)+'</div>'
                                                +'</div>'
                                                +`<div class="ml-2"><div class="w-2 h-2 ${isRead ? 'bg-gray-400' : 'bg-[var(--cane-500)]'} rounded-full"></div></div>`
                                                +'</div>'
                                                +'<div class="text-sm text-[var(--cane-700)] mt-1 line-clamp-2">'+(n.message||'')+'</div>';
                                            row.addEventListener('click', async ()=>{
                                                // Mark as read
                                                if (!isRead) {
                                                    try {
                                                        const { updateDoc, doc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');
                                                        await updateDoc(doc(db, 'notifications', n.id), {
                                                            read: true,
                                                            readAt: serverTimestamp(),
                                                            status: 'read'
                                                        });
                                                    } catch(err) {
                                                        console.error('Failed to mark notification as read:', err);
                                                    }
                                                }
                                                // Detail modal
                                                const m = document.createElement('div');
                                                m.className = 'fixed inset-0 bg-black/40 flex items-center justify-center z-50';
                                                m.innerHTML = '<div class="bg-white rounded-xl p-5 shadow-2xl max-w-md w-[92%]">'
                                                    +'<div class="flex items-center justify-between mb-2">'
                                                    +'<div class="text-lg font-semibold">'+(n.title||n.message||'Notification')+'</div>'
                                                    +'<button id="closeNotifModalBtn" class="text-xl">&times;</button>'
                                                    +'</div>'
                                                    +'<div class="text-xs text-[var(--cane-600)] mb-3">'+(n.type||'info')+' ¬∑ '+formatRelativeTime(n.timestamp)+'</div>'
                                                    +'<div class="text-[var(--cane-900)] text-sm whitespace-pre-wrap">'+(n.message||'')+'</div>'
                                                    +'</div>';
                                                document.body.appendChild(m);
                                                document.getElementById('closeNotifModalBtn').onclick = function(){ m.remove(); };
                                            });
                                            notifContainer.appendChild(row);
                                        });
                                    }
                                    if (notifContainer) renderNotifications();
                                    if (notifSearch) notifSearch.addEventListener('input', renderNotifications);
                                    if (notifSort) notifSort.addEventListener('change', renderNotifications);
                                };
                                // End of renderAllNotifications function
                            }
                        } catch(err) {
                            console.error('‚ùå Error setting up SRA notifications:', err);
                        }
                        */

                        // üî• Request Report Button Handler (reports table populated by renderReportsTable in showSection)
                        const requestReportBtn = document.getElementById('requestReportBtn');
                        if (requestReportBtn) {
                            requestReportBtn.addEventListener('click', async () => {
                                await showRequestReportModal();
                            });
                        }
                    } else {
                        // redirect to login if needed
                    }
                });
                const profileBtn = document.getElementById('profileBtn');

                                async function loadSRAReports(statusFilter = null) {
                                    reportsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading reports...</td></tr>';

                                    try {
                                        let reportsQuery;
                                        if (statusFilter && statusFilter !== 'all') {
                                            reportsQuery = query(
                                                collection(db, 'reports'),
                                                where('status', '==', statusFilter),
                                                orderBy('submittedDate', 'desc')
                                            );
                                        } else {
                                            reportsQuery = query(
                                                collection(db, 'reports'),
                                                orderBy('submittedDate', 'desc')
                                            );
                                        }

                                        // üî• Real-time listener with optimization
                                        onSnapshot(reportsQuery, async (snapshot) => {
                                            // Prevent double-rendering from local writes
                                            if (snapshot.metadata.hasPendingWrites) {
                                                console.log('‚è≠Ô∏è Skipping render - pending local writes');
                                                return;
                                            }

                                            console.log(`üîÑ SRA Reports: Real-time update triggered (${snapshot.size} reports)`);
                                            reportsTableBody.innerHTML = '';

                                            if (snapshot.empty) {
                                                reportsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-500">No reports found</td></tr>';
                                                return;
                                            }

                                            for (const docSnap of snapshot.docs) {
                                                const report = docSnap.data();
                                                const reportId = docSnap.id;

                                                // Get handler name with caching
                                                let handlerName = 'Unknown Handler';
                                                if (report.handlerId) {
                                                    if (nameCache.users[report.handlerId]) {
                                                        handlerName = nameCache.users[report.handlerId];
                                                    } else {
                                                        try {
                                                            const handlerDoc = await getDoc(doc(db, 'users', report.handlerId));
                                                            if (handlerDoc.exists()) {
                                                                const handlerData = handlerDoc.data();
                                                                handlerName = handlerData.name || handlerData.full_name || handlerData.fullName || handlerData.email || 'Unknown';
                                                                nameCache.users[report.handlerId] = handlerName;
                                                            }
                                                        } catch (err) {
                                                            console.warn('Failed to fetch handler name:', err);
                                                        }
                                                    }
                                                }

                                                // Format date
                                                const dateStr = report.submittedDate
                                                    ? report.submittedDate.toDate().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                                                    : '‚Äî';

                                                // Get report type label
                                                const reportTypeLabels = {
                                                    'crop_planting_records': 'Crop Planting Records',
                                                    'growth_updates': 'Growth Updates',
                                                    'harvest_schedules': 'Harvest Schedules',
                                                    'fertilizer_usage': 'Fertilizer Usage',
                                                    'land_titles': 'Land Titles',
                                                    'barangay_certifications': 'Barangay Certifications',
                                                    'production_costs': 'Production Costs'
                                                };
                                                const reportTypeLabel = reportTypeLabels[report.reportType] || report.reportType || 'Unknown';

                                                // Status badge
                                                const statusColors = {
                                                    'pending_review': 'bg-yellow-100 text-yellow-700',
                                                    'approved': 'bg-green-100 text-green-700',
                                                    'rejected': 'bg-red-100 text-red-700'
                                                };
                                                const statusLabels = {
                                                    'pending_review': 'Pending Review',
                                                    'approved': 'Approved',
                                                    'rejected': 'Rejected'
                                                };
                                                const status = report.status || 'pending_review';
                                                const statusColor = statusColors[status] || 'bg-gray-100 text-gray-700';
                                                const statusLabel = statusLabels[status] || status;

                                                const row = document.createElement('tr');
                                                row.className = 'hover:bg-gray-50 border-b';
                                                row.innerHTML = `
                                                    <td class="py-3 px-4 text-sm text-gray-900">${dateStr}</td>
                                                    <td class="py-3 px-4 text-sm text-gray-900">${handlerName}</td>
                                                    <td class="py-3 px-4 text-sm text-gray-700">${reportTypeLabel}</td>
                                                    <td class="py-3 px-4">
                                                        <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full ${statusColor}">
                                                            ${statusLabel}
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4 text-right">
                                                        <button onclick="window.viewSRAReport('${reportId}')" class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition mr-2">
                                                            <i class="fas fa-eye mr-1"></i> View
                                                        </button>
                                                        ${status === 'pending_review' ? `
                                                            <button onclick="window.approveSRAReport('${reportId}')" class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded hover:bg-green-200 transition mr-2">
                                                                <i class="fas fa-check mr-1"></i> Approve
                                                            </button>
                                                            <button onclick="window.rejectSRAReport('${reportId}')" class="px-3 py-1 text-xs bg-red-100 text-red-700 rounded hover:bg-red-200 transition">
                                                                <i class="fas fa-times mr-1"></i> Reject
                                                            </button>
                                                        ` : ''}
                                                    </td>
                                                `;
                                                reportsTableBody.appendChild(row);
                                            }
                                        }, (error) => {
                                            console.error('‚ùå SRA Reports listener error:', error);
                                            reportsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Error loading reports</td></tr>';
                                        });

                                    } catch (err) {
                                        console.error('Error setting up SRA reports:', err);
                                        reportsTableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-red-500">Error loading reports</td></tr>';
                                    }
                                }

                                // Load reports initially
                                loadSRAReports();

                                // Handle status filter change
                                if (reportStatusFilter) {
                                    reportStatusFilter.addEventListener('change', (e) => {
                                        const filterValue = e.target.value;
                                        loadSRAReports(filterValue === 'all' ? null : filterValue);
                                    });
                                }

                                // Global functions for report actions
                                window.viewSRAReport = async function(reportId) {
                                    try {
                                        const reportDoc = await getDoc(doc(db, 'reports', reportId));
                                        if (!reportDoc.exists()) {
                                            alert('Report not found');
                                            return;
                                        }

                                        const report = reportDoc.data();
                                        const reportTypeLabels = {
                                            'crop_planting_records': 'Crop Planting Records',
                                            'growth_updates': 'Growth Updates',
                                            'harvest_schedules': 'Harvest Schedules',
                                            'fertilizer_usage': 'Fertilizer Usage',
                                            'land_titles': 'Land Titles',
                                            'barangay_certifications': 'Barangay Certifications',
                                            'production_costs': 'Production Costs'
                                        };
                                        const reportTypeLabel = reportTypeLabels[report.reportType] || report.reportType;

                                        // Create modal
                                        const modal = document.createElement('div');
                                        modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black/40';

                                        let dataHTML = '';
                                        if (report.data && typeof report.data === 'object') {
                                            dataHTML = Object.entries(report.data).map(([key, value]) => {
                                                const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                                return `
                                                    <div class="flex justify-between py-2 border-b border-gray-200">
                                                        <span class="font-medium text-gray-700">${label}:</span>
                                                        <span class="text-gray-900">${Array.isArray(value) ? value.join(', ') : value}</span>
                                                    </div>
                                                `;
                                            }).join('');
                                        }

                                        modal.innerHTML = `
                                            <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-xl">
                                                <div class="flex items-center justify-between mb-4">
                                                    <h3 class="text-xl font-bold text-gray-900">${reportTypeLabel}</h3>
                                                    <button onclick="this.closest('.fixed').remove()" class="text-gray-400 hover:text-gray-600">
                                                        <i class="fas fa-times text-xl"></i>
                                                    </button>
                                                </div>

                                                <div class="mb-4">
                                                    <span class="inline-flex px-3 py-1 text-sm font-medium rounded-full ${report.status === 'approved' ? 'bg-green-100 text-green-700' : report.status === 'rejected' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
                                                        ${report.status === 'approved' ? 'Approved' : report.status === 'rejected' ? 'Rejected' : 'Pending Review'}
                                                    </span>
                                                    <p class="text-sm text-gray-600 mt-2">Submitted: ${report.submittedDate ? report.submittedDate.toDate().toLocaleString() : 'Unknown'}</p>
                                                </div>

                                                <div class="space-y-2">
                                                    ${dataHTML}
                                                </div>

                                                ${report.remarks ? `
                                                    <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                                        <p class="text-sm font-medium text-yellow-800">Remarks:</p>
                                                        <p class="text-sm text-yellow-700 mt-1">${report.remarks}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                        document.body.appendChild(modal);
                                    } catch (error) {
                                        console.error('Error viewing report:', error);
                                        alert('Failed to load report details');
                                    }
                                };

                                window.approveSRAReport = async function(reportId) {
                                    // Create styled approval modal
                                    const modal = document.createElement('div');
                                    modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50';
                                    modal.innerHTML = `
                                        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                                            <div class="p-6">
                                                <div class="flex items-center gap-4 mb-4">
                                                    <div class="flex-shrink-0 w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                                                        <i class="fas fa-check-circle text-2xl text-green-600"></i>
                                                    </div>
                                                    <div>
                                                        <h3 class="text-lg font-bold text-gray-900">Approve Report</h3>
                                                        <p class="text-sm text-gray-600">This action will notify the handler</p>
                                                    </div>
                                                </div>

                                                <p class="text-gray-700 mb-6">Are you sure you want to approve this report? The handler will be notified immediately.</p>

                                                <div class="flex items-center justify-end gap-3">
                                                    <button id="cancelApproveBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium transition">
                                                        Cancel
                                                    </button>
                                                    <button id="confirmApproveBtn" class="px-4 py-2 rounded-lg bg-green-600 hover:bg-green-700 text-white font-semibold transition">
                                                        <i class="fas fa-check mr-2"></i>Approve Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(modal);

                                    // Handle cancel
                                    modal.querySelector('#cancelApproveBtn').addEventListener('click', () => {
                                        modal.remove();
                                    });

                                    // Handle confirm
                                    modal.querySelector('#confirmApproveBtn').addEventListener('click', async () => {
                                        const confirmBtn = modal.querySelector('#confirmApproveBtn');
                                        confirmBtn.disabled = true;
                                        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Approving...';

                                        try {
                                            // Get report data first
                                            const reportDoc = await getDoc(doc(db, 'reports', reportId));
                                            if (!reportDoc.exists()) {
                                                alert('Report not found');
                                                modal.remove();
                                                return;
                                            }

                                            const reportData = reportDoc.data();
                                            const { updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');

                                            await updateDoc(doc(db, 'reports', reportId), {
                                                status: 'approved',
                                                reviewedBy: user.uid,
                                                reviewedAt: serverTimestamp()
                                            });

                                            // Get report type label
                                            const reportTypeLabels = {
                                                'crop_planting_records': 'Crop Planting Records',
                                                'growth_updates': 'Growth Updates',
                                                'harvest_schedules': 'Harvest Schedules',
                                                'fertilizer_usage': 'Fertilizer Usage',
                                                'land_titles': 'Land Titles',
                                                'barangay_certifications': 'Barangay Certifications',
                                                'production_costs': 'Production Costs'
                                            };
                                            const reportTypeLabel = reportTypeLabels[reportData.reportType] || reportData.reportType;

                                            // Send notification to handler
                                            if (reportData.handlerId) {
                                                console.log(`üì§ Sending approval notification to handler: ${reportData.handlerId}`);
                                                try {
                                                    await notifyReportApproval(reportData.handlerId, reportTypeLabel, reportId);
                                                    console.log('‚úÖ Approval notification sent successfully');
                                                } catch (notifError) {
                                                    console.error('‚ùå Failed to send approval notification:', notifError);
                                                }
                                            } else {
                                                console.warn('‚ö†Ô∏è No handlerId found in report data');
                                            }

                                            // Remove modal
                                            modal.remove();

                                            // Show success message
                                            const successDiv = document.createElement('div');
                                            successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999]';
                                            successDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Report approved successfully';
                                            document.body.appendChild(successDiv);
                                            setTimeout(() => successDiv.remove(), 3000);
                                        } catch (error) {
                                            console.error('Error approving report:', error);
                                            modal.remove();
                                            alert('Failed to approve report');
                                        }
                                    });
                                };

                                window.rejectSRAReport = async function(reportId) {
                                    // Create styled rejection modal
                                    const modal = document.createElement('div');
                                    modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50';
                                    modal.innerHTML = `
                                        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                                            <div class="p-6">
                                                <div class="flex items-center gap-4 mb-4">
                                                    <div class="flex-shrink-0 w-12 h-12 rounded-full bg-red-100 flex items-center justify-center">
                                                        <i class="fas fa-times-circle text-2xl text-red-600"></i>
                                                    </div>
                                                    <div>
                                                        <h3 class="text-lg font-bold text-gray-900">Reject Report</h3>
                                                        <p class="text-sm text-gray-600">Provide feedback to the handler</p>
                                                    </div>
                                                </div>

                                                <div class="mb-4">
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                        Rejection Remarks (Optional)
                                                    </label>
                                                    <textarea id="rejectionRemarks" rows="4"
                                                              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent resize-none"
                                                              placeholder="Explain why this report is being rejected..."></textarea>
                                                    <p class="text-xs text-gray-500 mt-1">The handler will see these remarks in their notification</p>
                                                </div>

                                                <div class="flex items-center justify-end gap-3">
                                                    <button id="cancelRejectBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium transition">
                                                        Cancel
                                                    </button>
                                                    <button id="confirmRejectBtn" class="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition">
                                                        <i class="fas fa-times mr-2"></i>Reject Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(modal);

                                    const remarksTextarea = modal.querySelector('#rejectionRemarks');
                                    remarksTextarea.focus();

                                    // Handle cancel
                                    modal.querySelector('#cancelRejectBtn').addEventListener('click', () => {
                                        modal.remove();
                                    });

                                    // Handle confirm
                                    modal.querySelector('#confirmRejectBtn').addEventListener('click', async () => {
                                        const confirmBtn = modal.querySelector('#confirmRejectBtn');
                                        const remarks = remarksTextarea.value.trim();

                                        confirmBtn.disabled = true;
                                        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Rejecting...';

                                        try {
                                            // Get report data first
                                            const reportDoc = await getDoc(doc(db, 'reports', reportId));
                                            if (!reportDoc.exists()) {
                                                alert('Report not found');
                                                modal.remove();
                                                return;
                                            }

                                            const reportData = reportDoc.data();
                                            const { updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js');

                                            await updateDoc(doc(db, 'reports', reportId), {
                                                status: 'rejected',
                                                reviewedBy: user.uid,
                                                reviewedAt: serverTimestamp(),
                                                remarks: remarks || ''
                                            });

                                            // Get report type label
                                            const reportTypeLabels = {
                                                'crop_planting_records': 'Crop Planting Records',
                                                'growth_updates': 'Growth Updates',
                                                'harvest_schedules': 'Harvest Schedules',
                                                'fertilizer_usage': 'Fertilizer Usage',
                                                'land_titles': 'Land Titles',
                                                'barangay_certifications': 'Barangay Certifications',
                                                'production_costs': 'Production Costs'
                                            };
                                            const reportTypeLabel = reportTypeLabels[reportData.reportType] || reportData.reportType;

                                            // Send notification to handler
                                            if (reportData.handlerId) {
                                                console.log(`üì§ Sending rejection notification to handler: ${reportData.handlerId}`);
                                                try {
                                                    await notifyReportRejection(reportData.handlerId, reportTypeLabel, reportId, remarks);
                                                    console.log('‚úÖ Rejection notification sent successfully');
                                                } catch (notifError) {
                                                    console.error('‚ùå Failed to send rejection notification:', notifError);
                                                }
                                            } else {
                                                console.warn('‚ö†Ô∏è No handlerId found in report data');
                                            }

                                            // Remove modal
                                            modal.remove();

                                            // Show success message
                                            const successDiv = document.createElement('div');
                                            successDiv.className = 'fixed top-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999]';
                                            successDiv.innerHTML = '<i class="fas fa-times-circle mr-2"></i> Report rejected';
                                            document.body.appendChild(successDiv);
                                            setTimeout(() => successDiv.remove(), 3000);
                                        } catch (error) {
                                            console.error('Error rejecting report:', error);
                                            modal.remove();
                                            alert('Failed to reject report');
                                        }
                                    });
                                };

                                // Request Report Button Handler
                                const requestReportBtn = document.getElementById('requestReportBtn');
                                if (requestReportBtn) {
                                    requestReportBtn.addEventListener('click', async () => {
                                        await showRequestReportModal();
                                    });
                                }

                                // Show Request Report Modal
                                async function showRequestReportModal() {
                                    const modal = document.createElement('div');
                                    modal.className = 'fixed inset-0 z-[9999] flex items-center justify-center bg-black bg-opacity-50';
                                    modal.innerHTML = `
                                        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                                            <div class="p-6">
                                                <div class="flex items-center gap-4 mb-4">
                                                    <div class="flex-shrink-0 w-12 h-12 rounded-full bg-[var(--cane-100)] flex items-center justify-center">
                                                        <i class="fas fa-file-invoice text-2xl text-[var(--cane-600)]"></i>
                                                    </div>
                                                    <div>
                                                        <h3 class="text-lg font-bold text-gray-900">Request Report</h3>
                                                        <p class="text-sm text-gray-600">Send notification to handler</p>
                                                    </div>
                                                </div>

                                                <div class="mb-4">
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                        Select Handler <span class="text-red-500">*</span>
                                                    </label>
                                                    <select id="requestHandlerSelect" required
                                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--cane-600)] focus:border-transparent">
                                                        <option value="">Loading handlers...</option>
                                                    </select>
                                                </div>

                                                <div class="mb-4">
                                                    <label class="block text-sm font-medium text-gray-700 mb-2">
                                                        Report Type <span class="text-red-500">*</span>
                                                    </label>
                                                    <select id="requestReportTypeSelect" required
                                                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[var(--cane-600)] focus:border-transparent">
                                                        <option value="">Select report type</option>
                                                        <option value="crop_planting_records">Crop Planting Records</option>
                                                        <option value="growth_updates">Growth Updates</option>
                                                        <option value="harvest_schedules">Harvest Schedules</option>
                                                        <option value="fertilizer_usage">Fertilizer Usage</option>
                                                        <option value="land_titles">Land Titles</option>
                                                        <option value="barangay_certifications">Barangay Certifications</option>
                                                        <option value="production_costs">Production Costs</option>
                                                    </select>
                                                </div>

                                                <div class="flex items-center justify-end gap-3">
                                                    <button id="cancelRequestBtn" class="px-4 py-2 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium transition">
                                                        Cancel
                                                    </button>
                                                    <button id="confirmRequestBtn" class="px-4 py-2 rounded-lg bg-[var(--cane-600)] hover:bg-[var(--cane-700)] text-white font-semibold transition">
                                                        <i class="fas fa-paper-plane mr-2"></i>Send Request
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                    document.body.appendChild(modal);

                                    // Load handlers
                                    const handlerSelect = modal.querySelector('#requestHandlerSelect');
                                    try {
                                        const handlersQuery = query(
                                            collection(db, 'users'),
                                            where('role', '==', 'handler')
                                        );
                                        const handlersSnapshot = await getDocs(handlersQuery);

                                        if (handlersSnapshot.empty) {
                                            handlerSelect.innerHTML = '<option value="">No handlers found</option>';
                                        } else {
                                            handlerSelect.innerHTML = '<option value="">Select a handler</option>';
                                            handlersSnapshot.forEach(doc => {
                                                const handler = doc.data();
                                                const handlerName = handler.name || handler.full_name || handler.email || 'Unknown Handler';
                                                const option = document.createElement('option');
                                                option.value = doc.id;
                                                option.textContent = handlerName;
                                                handlerSelect.appendChild(option);
                                            });
                                        }
                                    } catch (error) {
                                        console.error('Error loading handlers:', error);
                                        handlerSelect.innerHTML = '<option value="">Error loading handlers</option>';
                                    }

                                    // Handle cancel
                                    modal.querySelector('#cancelRequestBtn').addEventListener('click', () => {
                                        modal.remove();
                                    });

                                    // Handle confirm
                                    modal.querySelector('#confirmRequestBtn').addEventListener('click', async () => {
                                        const handlerId = modal.querySelector('#requestHandlerSelect').value;
                                        const reportType = modal.querySelector('#requestReportTypeSelect').value;
                                        const confirmBtn = modal.querySelector('#confirmRequestBtn');

                                        if (!handlerId || !reportType) {
                                            alert('Please select both handler and report type');
                                            return;
                                        }

                                        confirmBtn.disabled = true;
                                        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

                                        try {
                                            // Import notification function
                                            const { notifyReportRequest } = await import('../Common/notifications.js');

                                            const reportTypeLabels = {
                                                'crop_planting_records': 'Crop Planting Records',
                                                'growth_updates': 'Growth Updates',
                                                'harvest_schedules': 'Harvest Schedules',
                                                'fertilizer_usage': 'Fertilizer Usage',
                                                'land_titles': 'Land Titles',
                                                'barangay_certifications': 'Barangay Certifications',
                                                'production_costs': 'Production Costs'
                                            };

                                            const reportLabel = reportTypeLabels[reportType] || reportType;
                                            const message = `SRA requested a ${reportLabel} report from you`;

                                            await notifyReportRequest(handlerId, reportType, message);

                                            // Remove modal
                                            modal.remove();

                                            // Show success message
                                            const successDiv = document.createElement('div');
                                            successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-[9999]';
                                            successDiv.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Report request sent to handler';
                                            document.body.appendChild(successDiv);
                                            setTimeout(() => successDiv.remove(), 3000);

                                        } catch (error) {
                                            console.error('Error sending report request:', error);
                                            modal.remove();
                                            alert('Failed to send report request');
                                        }
                                    });
                                }
                            }
                        } catch (err) {
                            console.error('‚ùå Failed to setup SRA reports:', err);
                        }
                    } else {
                        // redirect to login if needed
                    }
                });
                const profileBtn = document.getElementById('profileBtn');
                const profileMenu = document.getElementById('profileMenu');
                if (profileBtn && profileMenu) {
                    profileBtn.addEventListener('click', () => {
                        profileMenu.classList.toggle('hidden');
                    });
                    window.addEventListener('click', (e) => {
                        if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
                            profileMenu.classList.add('hidden');
                        }
                    });
                }
                const profileSettingsLink = document.getElementById('profileSettings');
                if (profileSettingsLink) {
                    profileSettingsLink.addEventListener('click', function(e){
                        e.preventDefault();
                        window.location.href = '../Common/profile-settings.html';
                    });
                }
                const viewAllNotifLink = document.getElementById('viewAllNotificationsLink');
                if (viewAllNotifLink) {
                    viewAllNotifLink.addEventListener('click', function(e){
                        e.preventDefault();
                        showSection('notifications');
                    });
                }
                const logoutBtn = document.getElementById('logoutBtn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        const modal = document.getElementById('sraLogoutModal');
                        const dialog = document.getElementById('sraLogoutDialog');
                        if (!modal || !dialog) return;
                        modal.classList.remove('invisible', 'opacity-0');
                        dialog.classList.remove('opacity-0', 'scale-95', 'translate-y-2', 'pointer-events-none');
                    });
                }
            } catch (e) {
                // eslint-disable-next-line no-console
                console.error('Auth init failed', e);
            }
        });

        // Navigation functionality
        function showSection(sectionId) {
            // Hide all content sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.add('hidden');
            });

            // Show selected section
            const selectedSection = document.getElementById(sectionId);
            if (selectedSection) {
                selectedSection.classList.remove('hidden');
            }

            // Update active nav item using Tailwind classes
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-slate-800', 'text-white');
                item.classList.add('text-slate-300');
            });

            const activeNavItem = document.querySelector(`[data-section="${sectionId}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('bg-slate-800', 'text-white');
                activeNavItem.classList.remove('text-slate-300');
            }

            // Initialize reports section with advanced filters and export
            if (sectionId === 'reports') {
                const reportsTableContainer = document.getElementById('sraReportsTableContainer');
                if (reportsTableContainer && !reportsTableContainer.dataset.initialized) {
                    reportsTableContainer.dataset.initialized = 'true';
                    renderReportsTable('sraReportsTableContainer');
                }
            }

            currentSection = sectionId;
        }

        // formatRelativeTime function moved to top of file (line 10) to avoid duplication

        //  Friendly relative time formatter (replaces simple formatRelativeTime)
        function formatFullDate(ts) {
        try {
            if (!ts) return '';
            const d = ts.seconds ? new Date(ts.seconds * 1000) : new Date(ts);
            const now = new Date();
            const diffMs = now - d;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHr  = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHr / 24);

            if (diffSec < 60) return `Last updated ${diffSec} second${diffSec !== 1 ? 's' : ''} ago`;
            if (diffMin < 60) return `Last updated ${diffMin} minute${diffMin !== 1 ? 's' : ''} ago`;
            if (diffHr < 24)  return `Last updated ${diffHr} hour${diffHr !== 1 ? 's' : ''} ago`;
            if (diffDay === 1) return 'Last updated yesterday';
            if (diffDay < 7)  return `Last updated ${d.toLocaleDateString('en-US', { weekday: 'long' })}`;
            return `Last updated ${d.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' })}`;
        } catch (e) {
            console.warn('formatFullDate error:', e);
            return '';
        }
        }

        // Sidebar functionality
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                if (sidebar.classList.contains('-translate-x-full')) {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                } else {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                }
            }
        }

        // Desktop collapse/expand (icon-only) toggle
        function toggleSidebarCollapse() {
            const isDesktop = window.innerWidth >= 1024; // lg breakpoint
            const body = document.body;
            const main = document.getElementById('sraMain');
            if (!isDesktop || !main) return;
            const collapsing = !body.classList.contains('sidebar-collapsed');
            body.classList.toggle('sidebar-collapsed');
            main.style.marginLeft = collapsing ? '5rem' : '16rem';
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Sidebar toggle
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const closeSidebarBtn = document.getElementById('closeSidebarBtn');
            const overlay = document.getElementById('sidebarOverlay');
            const collapseBtn = document.getElementById('sraCollapseSidebarBtn');
            
            if (closeSidebarBtn) {
                closeSidebarBtn.addEventListener('click', closeSidebar);
            }
            
            if (overlay) {
                overlay.addEventListener('click', closeSidebar);
            }
            if (collapseBtn) {
                collapseBtn.addEventListener('click', function(e){
                    e.preventDefault();
                    toggleSidebarCollapse();
                });
            }
            
            // Navigation menu
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', async function(e) {
                        e.preventDefault();
                    const sectionId = this.getAttribute('data-section');
                    showSection(sectionId);
                    if (sectionId === 'field-documents') {
                        // Load the partial and ALWAYS initialize Review.js
                        const container = document.getElementById('fieldDocsContainer');
                        if (container) {
                            // Load HTML if not already loaded
                            if (container.childElementCount === 0) {
                                const cacheBust = `?v=${Date.now()}`;
                                try {
                                    const html = await fetch(`SRA_FieldDocuments.html${cacheBust}`).then(r => r.text());
                                    container.innerHTML = html;
                                } catch(err) {
                                    console.error('‚ùå Failed to load SRA_FieldDocuments.html:', err);
                                    container.innerHTML = '<div class="text-[var(--cane-700)]">Unable to load field documents.</div>';
                                    return;
                                }
                            }

                            // ALWAYS initialize/refresh Review.js (even if HTML was already loaded)
                            console.log('üî• ABOUT TO IMPORT Review.js (nav menu click)...');
                            const cacheBust = `?v=${Date.now()}`;
                            try {
                                const mod = await import(`./Review.js${cacheBust}`);
                                console.log('üî• Review.js imported successfully (nav menu)!', mod);
                                if (mod && mod.SRAReview && typeof mod.SRAReview.init === 'function') {
                                    console.log('üî• Calling SRAReview.init() (nav menu)...');
                                    mod.SRAReview.init();
                                } else {
                                    console.error('‚ùå SRAReview.init not found (nav menu)!', mod);
                                }
                            } catch(err) {
                                console.error('‚ùå FAILED TO IMPORT Review.js (nav menu):', err);
                            }
                        }
                    }
                    
                    // Close sidebar on mobile after navigation
                    if (window.innerWidth < 1024) {
                        closeSidebar();
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth >= 1024) {
                    closeSidebar();
                    const main = document.getElementById('sraMain');
                    if (main) {
                        main.style.marginLeft = document.body.classList.contains('sidebar-collapsed') ? '5rem' : '16rem';
                    }
                }
            });

            // Click-through: Recent Field Applications -> Review Applications section
            const recentCard = document.getElementById('recentFieldApplicationsCard');
            if (recentCard) {
                recentCard.addEventListener('click', async function() {
                    try {
                        showSection('field-documents');
                        const container = document.getElementById('fieldDocsContainer');
                        if (container && container.childElementCount === 0) {
                            const cacheBust = `?v=${Date.now()}`;
                            const html = await fetch(`SRA_FieldDocuments.html${cacheBust}`).then(r => r.text());
                            container.innerHTML = html;
                        }
                        // initialize/refresh review list
                        console.log('üî• ABOUT TO IMPORT Review.js (recent card click)...');
                        const cacheBust = `?v=${Date.now()}`;
                        const mod = await import(`./Review.js${cacheBust}`);
                        console.log('üî• Review.js imported (recent card)!', mod);
                        if (mod && mod.SRAReview && typeof mod.SRAReview.init === 'function') {
                            console.log('üî• Calling SRAReview.init() (recent card)...');
                            mod.SRAReview.init();
                        } else {
                            console.error('‚ùå SRAReview.init not found (recent card)!', mod);
                        }
                        // Ensure sidebar section highlights the Review menu
                        const activeNavItem = document.querySelector('[data-section="field-documents"]');
                        if (activeNavItem) {
                            document.querySelectorAll('.nav-item').forEach(item => {
                                item.classList.remove('bg-slate-800', 'text-white');
                                item.classList.add('text-slate-300');
                            });
                            activeNavItem.classList.add('bg-slate-800', 'text-white');
                            activeNavItem.classList.remove('text-slate-300');
                        }
                    } catch(_) {}
                });
            }

            // OLD: Notifications card and bell popup removed (now using bell dropdown from initNotifications)

            // Logout modal controls
            const modal = document.getElementById('sraLogoutModal');
            const dialog = document.getElementById('sraLogoutDialog');
            const cancelBtn = document.getElementById('sraLogoutCancel');
            const confirmBtn = document.getElementById('sraLogoutConfirm');
            function hideLogoutModal(){
                if (!modal || !dialog) return;
                dialog.classList.add('opacity-0','scale-95','translate-y-2','pointer-events-none');
                modal.classList.add('opacity-0','invisible');
            }
            if (cancelBtn) cancelBtn.addEventListener('click', hideLogoutModal);
            if (modal) modal.addEventListener('click', (e)=>{ if (e.target === modal) hideLogoutModal(); });
            if (confirmBtn) confirmBtn.addEventListener('click', async ()=>{
                try {
                    const { auth } = await import('../Common/firebase-config.js');
                    const { signOut } = await import('https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js');
                    await signOut(auth);
                    localStorage.removeItem('farmerName');
                    localStorage.removeItem('userRole');
                    localStorage.removeItem('userId');
                    window.location.href = '../Common/farmers_login.html';
                } catch(_) { hideLogoutModal(); }
            });
        }

        // Export functions for use in HTML
        window.showSection = showSection;
        window.toggleSidebar = toggleSidebar;
        window.closeSidebar = closeSidebar;
        window.toggleSidebarCollapse = toggleSidebarCollapse;